/*
  hub.js -- cloud-friendly object graph sync
  Â©2010 Erich Atlas Ocean. Licensed under an MIT license:
  
  Permission is hereby granted, free of charge, to any person obtaining a 
  copy of this software and associated documentation files (the "Software"), 
  to deal in the Software without restriction, including without limitation 
  the rights to use, copy, modify, merge, publish, distribute, sublicense, 
  and/or sell copies of the Software, and to permit persons to whom the 
  Software is furnished to do so, subject to the following conditions:
  
  The above copyright notice and this permission notice shall be included in 
  all copies or substantial portions of the Software.
  
  THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR 
  IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY, 
  FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE 
  AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER 
  LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING 
  FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER 
  DEALINGS IN THE SOFTWARE.
  
  This software includes substantial portions from SproutCore:
    
    SproutCore -- JavaScript Application Framework
    copyright 2006-2008, Sprout Systems, Inc. and contributors.
    
    Permission is hereby granted, free of charge, to any person obtaining a 
    copy of this software and associated documentation files (the "Software"), 
    to deal in the Software without restriction, including without limitation 
    the rights to use, copy, modify, merge, publish, distribute, sublicense, 
    and/or sell copies of the Software, and to permit persons to whom the 
    Software is furnished to do so, subject to the following conditions:
    
    The above copyright notice and this permission notice shall be included in 
    all copies or substantial portions of the Software.
    
  hub.uuid() function Copyright (c) 2009 Robert Kieffer.
  Dual licensed under the MIT and GPL licenses.
  
  hub.SHA256() function based on original code by Angel Marin, Paul Johnston.
*/
var hub;if(typeof window==="undefined"){if(typeof exports==="object"){hub=exports;hub.isNode=true;hub.root=GLOBAL;var sys=require("sys");hub.debug=function(a,b){if(typeof b==="undefined"){b=a;a="LOG"}sys.puts(a+": "+sys.inspect(b))};if(typeof GLOBAL.console==="undefined"){var K=function(){};GLOBAL.console={log:K,info:K,warn:K,error:K}}}else{throw"hub.js currently requires node.js when run outside the browser"}}else{hub={isNode:false,root:window,debug:function(a,b){if(typeof b==="undefined"){b=a;a="LOG"}console.log(a+": ");console.log(b)}};if(typeof console==="undefined"){window.console={};console.log=console.info=console.warn=console.error=function(){}}}hub.json={encode:function(a){return JSON.stringify(a)},decode:function(a){return JSON.parse(a)}};Function.prototype.bind=function(c){var d=Array.prototype.slice;var f=function(j,g){var i=j.length,h=g.length;while(h--){j[i+h]=g[h]}return j};var e=function(h,g){h=d.call(h,0);return f(h,g)};if(arguments.length<2&&hub.none(arguments[0])){return this}var a=this,b=d.call(arguments,1);return function(){var g=e(b,arguments);return a.apply(c,g)}};var hub_assert=function(b,a){if(!b){throw ("HUB_ASSERT: "+a)}};var hub_precondition=function(b,a){if(!b){throw ("HUB_PRECONDITION: "+a)}};var hub_postcondition=function(b,a){if(!b){throw ("HUB_POSTCONDITION: "+a)}};var hub_invariant=function(b,a){if(!b){throw ("HUB_INVARIANT: "+a)}};var hub_error=function(a){throw"HUB_ERROR: "+a};hub.allege=function(b,a){if(!b){throw"HUB_ALLEGE: "+a}};hub.mixin=function(){var e=arguments[0]||{};var a=1;var d=arguments.length;var b;if(d===1){e=this||{};a=0}for(;a<d;a++){if(!(b=arguments[a])){continue}for(var c in b){if(!b.hasOwnProperty(c)){continue}var f=b[c];if(e===f){continue}if(f!==undefined){e[c]=f}}}return e};hub.supplement=function(){var e=arguments[0]||{};var a=1;var d=arguments.length;var b;if(d===1){e=this||{};a=0}for(;a<d;a++){if(!(b=arguments[a])){continue}for(var c in b){if(!b.hasOwnProperty(c)){continue}var f=e[c];var g=b[c];if(e===g){continue}if(g!==undefined&&f===undefined){e[c]=g}}}return e};hub.extend=hub.mixin;hub.mixin({T_ERROR:"error",T_OBJECT:"object",T_NULL:"null",T_CLASS:"class",T_HASH:"hash",T_FUNCTION:"function",T_UNDEFINED:"undefined",T_NUMBER:"number",T_BOOL:"boolean",T_ARRAY:"array",T_STRING:"string",typeOf:function(b){if(b===undefined){return hub.T_UNDEFINED}if(b===null){return hub.T_NULL}var a=typeof(b);if(a=="object"){if(b instanceof Array){a=hub.T_ARRAY}else{if(b instanceof Function){a=b.isClass?hub.T_CLASS:hub.T_FUNCTION}else{if(hub.Error&&(b instanceof hub.Error)){a=hub.T_ERROR}else{if(b.isObject===true){a=hub.T_OBJECT}else{a=hub.T_HASH}}}}}else{if(a===hub.T_FUNCTION){a=(b.isClass)?hub.T_CLASS:hub.T_FUNCTION}}return a},none:function(a){return a===null||a===undefined},empty:function(a){return a===null||a===undefined||a===""},isArray:function(c){if(c&&c.objectAt){return true}var a=(c?c.length:null),b=hub.typeOf(c);return !(hub.none(a)||(b===hub.T_FUNCTION)||(b===hub.T_STRING)||c.setInterval)},makeArray:function(a){return hub.isArray(a)?a:hub.A(a)},A:function(c){if(hub.none(c)){return[]}if(c.slice instanceof Function){if(typeof(c)==="string"){return[c]}else{return c.slice()}}if(c.toArray){return c.toArray()}if(!hub.isArray(c)){return[c]}var b=[],a=c.length;while(--a>=0){b[a]=c[a]}return b},guidKey:"_hub_guid_"+new Date().getTime(),_hub_nextGUID:0,_hub_numberGuids:[],_hub_stringGuids:{},_hub_keyCache:{},guidFor:function(b){if(b===undefined){return"(undefined)"}if(b===null){return"(null)"}if(b===Object){return"(Object)"}if(b===Array){return"(Array)"}var a=this.guidKey;if(b[a]){return b[a]}switch(typeof b){case hub.T_NUMBER:return(this._hub_numberGuids[b]=this._hub_numberGuids[b]||("nu"+b));case hub.T_STRING:return(this._hub_stringGuids[b]=this._hub_stringGuids[b]||("st"+b));case hub.T_BOOL:return(b)?"(true)":"(false)";default:return hub.generateGuid(b)}},keyFor:function(d,c){var b,a=this._hub_keyCache[d];if(!a){a=this._hub_keyCache[d]={}}b=a[c];if(!b){b=a[c]=d+"_"+c}return b},generateGuid:function(b){var a=("hub"+(this._hub_nextGUID++));if(b){b[this.guidKey]=a}return a},hashFor:function(a){return(a&&a.hash&&(typeof a.hash===hub.T_FUNCTION))?a.hash():this.guidFor(a)},isEqual:function(d,c){if(d===null){return c===null}else{if(d===undefined){return c===undefined}else{return this.hashFor(d)===this.hashFor(c)}}},compare:function(h,g){var f=hub.typeOf(h);var d=hub.typeOf(g);var j=hub.ORDER_DEFINITION.indexOf(f);var b=hub.ORDER_DEFINITION.indexOf(d);if(j<b){return -1}if(j>b){return 1}switch(f){case hub.T_BOOL:case hub.T_NUMBER:if(h<g){return -1}if(h>g){return 1}return 0;case hub.T_STRING:if(h.localeCompare(g)<0){return -1}if(h.localeCompare(g)>0){return 1}return 0;case hub.T_ARRAY:var c=Math.min(h.length,g.length);var a=0;var e=0;while(a===0&&e<c){a=arguments.callee(h[e],g[e]);if(a!==0){return a}e++}if(h.length<g.length){return -1}if(h.length>g.length){return 1}return 0;case hub.T_OBJECT:if(h.constructor.isComparable===true){return h.constructor.compare(h,g)}return 0;default:return 0}},K:function(){return this},EMPTY_ARRAY:[],EMPTY_HASH:{},EMPTY_RANGE:{start:0,length:0},beget:function(c){if(hub.none(c)){return null}var a=hub.K;a.prototype=c;var b=new a();a.prototype=null;if(hub.typeOf(c.didBeget)===hub.T_FUNCTION){b=c.didBeget(b)}return b},copy:function(b){var a=b;if(b&&b.isCopyable){return b.copy()}switch(hub.typeOf(b)){case hub.T_ARRAY:if(b.clone&&hub.typeOf(b.clone)===hub.T_FUNCTION){a=b.clone()}else{a=b.slice()}break;case hub.T_HASH:case hub.T_OBJECT:if(b.clone&&hub.typeOf(b.clone)===hub.T_FUNCTION){a=b.clone()}else{a={};for(var c in b){a[c]=b[c]}}}return a},merge:function(){var c={},b=arguments.length,a;for(a=0;a<b;a++){hub.mixin(c,arguments[a])}return c},keys:function(c){var a=[];for(var b in c){a.push(b)}return a},inspect:function(d){var a,b=[];for(var c in d){a=d[c];if(a==="toString"){continue}if(hub.typeOf(a)===hub.T_FUNCTION){a="function() { ... }"}b.push(c+": "+a)}return"{"+b.join(" , ")+"}"},tupleForPropertyPath:function(e,a){if(hub.typeOf(e)===hub.T_ARRAY){return e}var c;var b=e.indexOf("*");if(b<0){b=e.lastIndexOf(".")}c=(b>=0)?e.slice(b+1):e;var d=this.objectForPropertyPath(e,a,b);return(d&&c)?[d,c]:null},objectForPropertyPath:function(f,c,d){var g,b,e,a;if(!c){c=hub.root}if(hub.typeOf(f)===hub.T_STRING){if(d===undefined){d=f.length}g=0;while((c)&&(g<d)){b=f.indexOf(".",g);if((b<0)||(b>d)){b=d}e=f.slice(g,b);c=c.get?c.get(e):c[e];g=b+1}if(g<d){c=undefined}}else{g=0;a=f.length;e=null;while((g<a)&&c){e=f[g++];if(e){c=(c.get)?c.get(e):c[e]}}if(g<a){c=undefined}}return c},STRINGS:{},stringsFor:function(b,a){hub.mixin(hub.STRINGS,a);return this}});hub.clone=hub.copy;hub.$A=hub.A;hub.ORDER_DEFINITION=[hub.T_ERROR,hub.T_UNDEFINED,hub.T_NULL,hub.T_BOOL,hub.T_NUMBER,hub.T_STRING,hub.T_ARRAY,hub.T_HASH,hub.T_OBJECT,hub.T_FUNCTION,hub.T_CLASS];hub.mixin(Function.prototype,{property:function(){this.dependentKeys=hub.$A(arguments);var a=hub.guidFor(this);this.cacheKey="__hub_cache__"+a;this.lastSetValueKey="__hub_lastValue__"+a;this.isProperty=true;return this},cacheable:function(a){this.isProperty=true;if(!this.dependentKeys){this.dependentKeys=[]}this.isCacheable=(a===undefined)?true:a;return this},idempotent:function(a){this.isProperty=true;if(!this.dependentKeys){this.dependentKeys=[]}this.isVolatile=(a===undefined)?true:a;return this},observes:function(a){var e=arguments.length,b=null,d=null;while(--e>=0){var c=arguments[e];if((c.indexOf(".")<0)&&(c.indexOf("*")<0)){if(!b){b=this.localPropertyPaths=[]}b.push(c)}else{if(!d){d=this.propertyPaths=[]}d.push(c)}}return this}});String.prototype.fmt=function(){var b=arguments;var a=0;return this.replace(/%@([0-9]+)?/g,function(c,d){d=(d)?parseInt(d,0)-1:a++;c=b[d];return((c===null)?"(null)":(c===undefined)?"":c).toString()})};String.prototype.loc=function(){var a=hub.STRINGS[this]||this;return a.fmt.apply(a,arguments)};String.prototype.w=function(){var c=[],d=this.split(" "),b=d.length;for(var a=0;a<b;++a){var e=d[a];if(e.length!==0){c.push(e)}}return c};hub.ObserverSet={targets:0,_hub_membersCacheIsValid:false,add:function(d,f,b){var c=(d)?hub.guidFor(d):"__this__";var a=this[c];if(!a){a=this[c]=hub.CoreSet.create();a.target=d;a.isTargetSet=true;this.targets++}a.add(f);if(b!==undefined){var e=a.contexts;if(!b){e={}}e[hub.guidFor(f)]=b}this._hub_membersCacheIsValid=false},remove:function(c,d){var b=(c)?hub.guidFor(c):"__this__";var a=this[b];if(!a){return false}a.remove(d);if(a.length<=0){a.target=null;a.isTargetSet=false;a.contexts=null;delete this[b];this.targets--}else{if(a.contexts){delete a.contexts[hub.guidFor(d)]}}this._hub_membersCacheIsValid=false;return true},invokeMethods:function(){for(var b in this){if(!this.hasOwnProperty(b)){continue}var c=this[b];if(c&&c.isTargetSet){var a=c.length;var d=c.target;while(--a>=0){c[a].call(d)}}}},getMembers:function(){if(this._hub_membersCacheIsValid){return this._hub_members}if(!this._hub_members){this._hub_members=[]}else{this._hub_members.length=0}var b=this._hub_members;for(var c in this){if(!this.hasOwnProperty(c)){continue}var d=this[c];if(d&&d.isTargetSet){var a=d.length;var e=d.target;var g=d.contexts;if(g){while(--a>=0){var f=d[a];b.push([e,f,g[hub.guidFor(f)]])}}else{while(--a>=0){b.push([e,d[a]])}}}}this._hub_membersCacheIsValid=true;return b},clone:function(){var b,d,c,a=hub.ObserverSet.create();for(c in this){if(!this.hasOwnProperty(c)){continue}b=this[c];if(b&&b.isTargetSet){d=b.clone();d.target=b.target;if(b.contexts){d.contexts=hub.clone(b.contexts)}a[c]=d}}a.targets=this.targets;a._hub_membersCacheIsValid=false;return a},create:function(){return hub.beget(this)}};hub.ObserverSet.slice=hub.ObserverSet.clone;hub.LOG_OBSERVERS=false;hub.Observable={isObservable:true,automaticallyNotifiesObserversFor:function(a){return true},get:function(c){var b=this[c],a;if(b===undefined){return this.unknownProperty(c)}else{if(b&&b.isProperty){if(b.isCacheable){a=this._hub_kvo_cache;if(!a){a=this._hub_kvo_cache={}}return(a[b.cacheKey]!==undefined)?a[b.cacheKey]:(a[b.cacheKey]=b.call(this,c))}else{return b.call(this,c)}}else{return b}}},set:function(h,f){var b=this[h],i=this.automaticallyNotifiesObserversFor(h),e=f,c,a,g,d;if(this._hub_kvo_cacheable&&(a=this._hub_kvo_cache)){c=this._hub_kvo_cachedep;if(!c||(c=c[h])===undefined){c=this._hub_kvo_computeCachedDependentsFor(h)}if(c){g=c.length;while(--g>=0){d=c[g];a[d.cacheKey]=a[d.lastSetValueKey]=undefined}}}if(b&&b.isProperty){a=this._hub_kvo_cache;if(b.isVolatile||!a||(a[b.lastSetValueKey]!==f)){if(!a){a=this._hub_kvo_cache={}}a[b.lastSetValueKey]=f;if(i){this.propertyWillChange(h)}e=b.call(this,h,f);if(b.isCacheable){a[b.cacheKey]=e}if(i){this.propertyDidChange(h,e,true)}}}else{if(b===undefined){if(i){this.propertyWillChange(h)}this.unknownProperty(h,f);if(i){this.propertyDidChange(h,e)}}else{if(this[h]!==f){if(i){this.propertyWillChange(h)}e=this[h]=f;if(i){this.propertyDidChange(h,e)}}}}return this},unknownProperty:function(a,b){if(!(b===undefined)){this[a]=b}return b},beginPropertyChanges:function(){this._hub_kvo_changeLevel=(this._hub_kvo_changeLevel||0)+1;return this},endPropertyChanges:function(){this._hub_kvo_changeLevel=(this._hub_kvo_changeLevel||1)-1;var b=this._hub_kvo_changeLevel,a=this._hub_kvo_changes;if((b<=0)&&a&&(a.length>0)&&!hub.Observers.isObservingSuspended){this._hub_notifyPropertyObservers()}return this},propertyWillChange:function(a){return this},propertyDidChange:function(m,j,g){this._hub_kvo_revision=(this._hub_kvo_revision||0)+1;var b=this._hub_kvo_changeLevel||0,f,l,h,a,c,e=hub.LOG_OBSERVERS&&!(this.LOG_OBSERVING===false);if(this._hub_kvo_cacheable&&(a=this._hub_kvo_cache)){if(!g){c=this[m];if(c&&c.isProperty){a[c.cacheKey]=a[c.lastSetValueKey]=undefined}}f=this._hub_kvo_cachedep;if(!f||(f=f[m])===undefined){f=this._hub_kvo_computeCachedDependentsFor(m)}if(f){l=f.length;while(--l>=0){h=f[l];a[h.cacheKey]=a[h.lastSetValueKey]=undefined}}}var d=hub.Observers.isObservingSuspended;if((b>0)||d){var i=this._hub_kvo_changes;if(!i){i=this._hub_kvo_changes=hub.CoreSet.create()}i.add(m);if(d){if(e){hub.debug("%@%@".fmt(hub.KVO_SPACES,this),"will not notify observers because observing is suspended")}hub.Observers.objectHasPendingChanges(this)}}else{this._hub_notifyPropertyObservers(m)}return this},registerDependentKey:function(h,c){var e=this._hub_kvo_dependents,b=this[h],i,g,a,f,d;if(hub.typeOf(c)===hub.T_ARRAY){i=c;a=0}else{i=arguments;a=1}g=i.length;if(!e){this._hub_kvo_dependents=e={}}while(--g>=a){f=i[g];d=e[f];if(!d){d=e[f]=[]}d.push(h)}},_hub_kvo_addCachedDependents:function(b,f,h,c){var a=f.length,e,d,g;while(--a>=0){d=f[a];c.add(d);e=this[d];if(e&&(e instanceof Function)&&e.isProperty){if(e.isCacheable){b.push(e)}if((g=h[d])&&g.length>0){this._hub_kvo_addCachedDependents(b,g,h,c)}}}},_hub_kvo_computeCachedDependentsFor:function(c){var d=this._hub_kvo_cachedep,f=this._hub_kvo_dependents,e=f?f[c]:null,a,b;if(!d){d=this._hub_kvo_cachedep={}}if(!e||e.length===0){return d[c]=null}a=d[c]=[];b=hub._hub_TMP_SEEN_SET=(hub._hub_TMP_SEEN_SET||hub.CoreSet.create());b.add(c);this._hub_kvo_addCachedDependents(a,e,f,b);b.clear();if(a.length===0){a=d[c]=null}return a},_hub_kvo_for:function(c,b){var a=this[c];if(!this._hub_kvo_cloned){this._hub_kvo_cloned={}}if(!a){a=this[c]=(b===undefined)?[]:b.create();this._hub_kvo_cloned[c]=true}else{if(!this._hub_kvo_cloned[c]){a=this[c]=a.copy();this._hub_kvo_cloned[c]=true}}return a},addObserver:function(c,f,h,b){var d,a,e,g;if(h===undefined){h=f;f=this}if(!f){f=this}if(hub.typeOf(h)===hub.T_STRING){h=f[h]}if(!h){throw"You must pass a method to addObserver()"}c=c.toString();if(c.indexOf(".")>=0){a=hub._hub_ChainObserver.createChain(this,c,f,h,b);a.masterTarget=f;a.masterMethod=h;this._hub_kvo_for(hub.keyFor("_hub_kvo_chains",c)).push(a)}else{if((this[c]===undefined)&&(c.indexOf("@")===0)){this.get(c)}if(f===this){f=null}d=hub.keyFor("_hub_kvo_observers",c);this._hub_kvo_for(d,hub.ObserverSet).add(f,h,b);this._hub_kvo_for("_hub_kvo_observed_keys",hub.CoreSet).add(c)}if(this.didAddObserver){this.didAddObserver(c,f,h)}return this},removeObserver:function(c,f,h){var d,e,b,g,a;if(h===undefined){h=f;f=this}if(!f){f=this}if(hub.typeOf(h)===hub.T_STRING){h=f[h]}if(!h){throw"You must pass a method to addObserver()"}c=c.toString();if(c.indexOf(".")>=0){d=hub.keyFor("_hub_kvo_chains",c);if(e=this[d]){e=this._hub_kvo_for(d);a=e.length;while(--a>=0){b=e[a];if(b&&(b.masterTarget===f)&&(b.masterMethod===h)){e[a]=b.destroyChain()}}}}else{if(f===this){f=null}d=hub.keyFor("_hub_kvo_observers",c);if(g=this[d]){g=this._hub_kvo_for(d);g.remove(f,h);if(g.targets<=0){this._hub_kvo_for("_hub_kvo_observed_keys",hub.CoreSet).remove(c)}}}if(this.didRemoveObserver){this.didRemoveObserver(c,f,h)}return this},hasObserverFor:function(b){hub.Observers.flush(this);var d=this[hub.keyFor("_hub_kvo_observers",b)],c=this[hub.keyFor("_hub_kvo_local",b)],a;if(c&&c.length>0){return true}if(d&&d.getMembers().length>0){return true}return false},initObservable:function(){if(this._hub_observableInited){return}this._hub_observableInited=true;var e,m,j,i,g,d,l;if(m=this._hub_observers){var f=m.length;for(e=0;e<f;e++){j=m[e];g=this[j];d=g.propertyPaths;l=(d)?d.length:0;for(var b=0;b<l;b++){var n=d[b];var a=n.indexOf(".");if(a<0){this.addObserver(n,this,g)}else{if(n.indexOf("*")===0){this.addObserver(n.slice(1),this,g)}else{var h=null;if(a===0){h=this;n=n.slice(1)}else{if(a===4&&n.slice(0,5)==="this."){h=this;n=n.slice(5)}else{if(a<0&&n.length===4&&n==="this"){h=this;n=""}}}hub.Observers.addObserver(n,this,g,h)}}}}}this.bindings=[];if(m=this._hub_bindings){for(e=0;e<m.length;e++){j=m[e];i=this[j];var c=j.slice(0,-7);this[j]=this.bind(c,i)}}if(m=this._hub_properties){for(e=0;e<m.length;e++){j=m[e];if(i=this[j]){if(i.isCacheable){this._hub_kvo_cacheable=true}if(i.dependentKeys&&(i.dependentKeys.length>0)){this.registerDependentKey(j,i.dependentKeys)}}}}},observersForKey:function(a){var b=this._hub_kvo_for("_hub_kvo_observers",a);return b.getMembers()||[]},_hub_notifyPropertyObservers:function(u){if(!this._hub_observableInited){this.initObservable()}hub.Observers.flush(this);var g=hub.LOG_OBSERVERS&&!(this.LOG_OBSERVING===false);var p,s,n,d,o,m,r;var q,j,a,f,t,c,i,e;var b,h,l;if(g){h=hub.KVO_SPACES=(hub.KVO_SPACES||"")+"  ";hub.debug("%@%@".fmt(h,this,u),'notifying observers after change to key "%@"')}d=this["_hub_kvo_observers_*"];this._hub_kvo_changeLevel=(this._hub_kvo_changeLevel||0)+1;while(((s=this._hub_kvo_changes)&&(s.length>0))||u){r=++this.propertyRevision;if(!s){s=hub.CoreSet.create()}this._hub_kvo_changes=null;if(u==="*"){s.add("*");s.addEach(this._hub_kvo_for("_hub_kvo_observed_keys",hub.CoreSet))}else{if(u){s.add(u)}}if(n=this._hub_kvo_dependents){for(o=0;o<s.length;o++){u=s[o];m=n[u];if(m&&(i=m.length)){if(g){hub.debug("%@...including dependent keys for %@: %@".fmt(h,u,m))}l=this._hub_kvo_cache;if(!l){l=this._hub_kvo_cache={}}while(--i>=0){s.add(u=m[i]);if(e=this[u]){this[e.cacheKey]=undefined;l[e.cacheKey]=l[e.lastSetValueKey]=undefined}}}}}while(s.length>0){u=s.pop();p=this[hub.keyFor("_hub_kvo_observers",u)];if(p){q=p.getMembers();j=q.length;for(f=0;f<j;f++){a=q[f];if(a[3]===r){continue}t=a[0]||this;c=a[1];b=a[2];a[3]=r;if(g){hub.debug('%@...firing observer on %@ for key "%@"'.fmt(h,t,u))}if(b!==undefined){c.call(t,this,u,null,b,r)}else{c.call(t,this,u,null,r)}}}q=this[hub.keyFor("_hub_kvo_local",u)];if(q){j=q.length;for(f=0;f<j;f++){a=q[f];c=this[a];if(c){if(g){hub.debug('%@...firing local observer %@.%@ for key "%@"'.fmt(h,this,a,u))}c.call(this,this,u,null,r)}}}if(d&&u!=="*"){q=d.getMembers();j=q.length;for(f=0;f<j;f++){a=q[f];t=a[0]||this;c=a[1];b=a[2];if(g){hub.debug('%@...firing * observer on %@ for key "%@"'.fmt(h,t,u))}if(b!==undefined){c.call(t,this,u,null,b,r)}else{c.call(t,this,u,null,r)}}}if(this.propertyObserver){if(g){hub.debug('%@...firing %@.propertyObserver for key "%@"'.fmt(h,this,u))}this.propertyObserver(this,u,null,r)}}if(s){s.destroy()}u=null}this._hub_kvo_changeLevel=(this._hub_kvo_changeLevel||1)-1;if(g){hub.KVO_SPACES=h.slice(0,-2)}if(hub.needRunLoop){hub.needRunLoop=false;if(hub.run){setTimeout(hub.run(function(){hub.debug.log("Manually running run loop")}),10)}}return true},bind:function(a,c,e){var d;if(e!==undefined){c=[c,e]}var b=hub.typeOf(c);if(b===hub.T_STRING||b===hub.T_ARRAY){d=this[a+"BindingDefault"]||hub.Binding;d=d.beget().from(c)}else{d=c}d=d.to(a,this).connect();this.bindings.push(d);return d},didChangeFor:function(a){a=hub.hashFor(a);var b=this._hub_kvo_didChange_valueCache;if(!b){b=this._hub_kvo_didChange_valueCache={}}var f=this._hub_kvo_didChange_revisionCache;if(!f){f=this._hub_kvo_didChange_revisionCache={}}var e=b[a]||{};var j=f[a]||{};var d=false;var c=this._hub_kvo_revision||0;var h=arguments.length;while(--h>=1){var i=arguments[h];if(j[i]!=c){var g=this.get(i);if(e[i]!==g){d=true;e[i]=g}}j[i]=c}b[a]=e;f[a]=j;return d},setIfChanged:function(a,b){return(this.get(a)!==b)?this.set(a,b):this},getPath:function(b){var a=hub.tupleForPropertyPath(b,this);if(a===null||a[0]===null){return undefined}return a[0].get(a[1])},setPath:function(c,b){if(c.indexOf(".")>=0){var a=hub.tupleForPropertyPath(c,this);if(!a||!a[0]){return null}a[0].set(a[1],b)}else{this.set(c,b)}return this},setPathIfChanged:function(c,b){if(c.indexOf(".")>=0){var a=hub.tupleForPropertyPath(c,this);if(!a||!a[0]){return null}if(a[0].get(a[1])!==b){a[0].set(a[1],b)}}else{this.setIfChanged(c,b)}return this},getEach:function(){var c=hub.A(arguments);var b=[];for(var a=0;a<c.length;a++){b[b.length]=this.getPath(c[a])}return b},incrementProperty:function(a){this.set(a,(this.get(a)||0)+1);return this.get(a)},decrementProperty:function(a){this.set(a,(this.get(a)||0)-1);return this.get(a)},toggleProperty:function(a,b,c){if(b===undefined){b=true}if(c===undefined){c=false}b=(this.get(a)==b)?c:b;this.set(a,b);return this.get(a)},notifyPropertyChange:function(a,b){this.propertyWillChange(a);this.propertyDidChange(a,b);return this},allPropertiesDidChange:function(){this._hub_kvo_cache=null;this._hub_notifyPropertyObservers("*");return this},addProbe:function(a){this.addObserver(a,hub.logChange)},removeProbe:function(a){this.removeObserver(a,hub.logChange)},logProperty:function(){var b=hub.$A(arguments);for(var a=0;a<b.length;a++){var c=b[a];hub.debug("%@:%@".fmt(hub.guidFor(this),c),this.get(c))}},propertyRevision:1};hub.logChange=function logChange(c,a,b){hub.debug("CHANGE","%@[%@] => %@".fmt(c,a,c.get(a)))};hub.mixin(Array.prototype,hub.Observable);hub.Enumerator=function(a){this.enumerable=a;this.reset();return this};hub.Enumerator.prototype={nextObject:function(){var c=this._hub_index;var a=this._hub_length;if(c>=a){return undefined}var b=this.enumerable.nextObject(c,this._hub_previousObject,this._hub_context);this._hub_previousObject=b;this._hub_index=c+1;if(c>=a){this._hub_context=hub.Enumerator._hub_pushContext(this._hub_context)}return b},reset:function(){var b=this.enumerable;if(!b){throw hub.$error("Enumerator has been destroyed")}this._hub_length=b.get?b.get("length"):b.length;var a=this._hub_length;this._hub_index=0;this._hub_previousObject=null;this._hub_context=(a>0)?hub.Enumerator._hub_popContext():null},destroy:function(){this.enumerable=this._hub_length=this._hub_index=null;this._hub_previousObject=this._hub_context=null}};hub.Enumerator.create=function(a){return new hub.Enumerator(a)};hub.Enumerator._hub_popContext=function(){var a=this._hub_contextCache?this._hub_contextCache.pop():null;return a||{}};hub.Enumerator._hub_pushContext=function(b){this._hub_contextCache=this._hub_contextCache||[];var a=this._hub_contextCache;a.push(b);return null};hub.Enumerable={isEnumerable:true,nextObject:function(a,c,b){return this.objectAt?this.objectAt(a):this[a]},firstObject:function(){if(this.get("length")===0){return undefined}if(this.objectAt){return this.objectAt(0)}var b=hub.Enumerator._hub_popContext(),a;a=this.nextObject(0,null,b);b=hub.Enumerator._hub_pushContext(b);return a}.property(),enumerator:function(){return hub.Enumerator.create(this)},forEach:function(g,f){if(typeof g!=="function"){throw new TypeError()}var b=this.get?this.get("length"):this.length;if(f===undefined){f=null}var e=null;var c=hub.Enumerator._hub_popContext();for(var a=0;a<b;a++){var d=this.nextObject(a,e,c);g.call(f,d,a,this);e=d}e=null;c=hub.Enumerator._hub_pushContext(c);return this},getEach:function(a){return this.map(function(b){return b?(b.get?b.get(a):b[a]):null},this)},setEach:function(a,b){this.forEach(function(c){if(c){if(c.set){c.set(a,b)}else{c[a]=b}}},this);return this},map:function(h,g){if(typeof h!=="function"){throw new TypeError()}var b=this.get?this.get("length"):this.length;if(g===undefined){g=null}var c=[];var f=null;var d=hub.Enumerator._hub_popContext();for(var a=0;a<b;a++){var e=this.nextObject(a,f,d);c[a]=h.call(g,e,a,this);f=e}f=null;d=hub.Enumerator._hub_pushContext(d);return c},mapProperty:function(a){return this.map(function(b){return b?(b.get?b.get(a):b[a]):null})},filter:function(h,g){if(typeof h!=="function"){throw new TypeError()}var b=this.get?this.get("length"):this.length;if(g===undefined){g=null}var c=[];var f=null;var d=hub.Enumerator._hub_popContext();for(var a=0;a<b;a++){var e=this.nextObject(a,f,d);if(h.call(g,e,a,this)){c.push(e)}f=e}f=null;d=hub.Enumerator._hub_pushContext(d);return c},sortProperty:function(b){var c=(typeof b===hub.T_STRING)?arguments:b,a=c.length,d;if(this instanceof Array){d=this}else{d=[];this.forEach(function(e){d.push(e)})}if(!d){return[]}return d.sort(function(g,f){var e,i,l,j,h=0;for(e=0;h===0&&e<a;e++){i=c[e];l=g?(g.get?g.get(i):g[i]):null;j=f?(f.get?f.get(i):f[i]):null;h=hub.compare(l,j)}return h})},filterProperty:function(j,f){var d=this.get?this.get("length"):this.length;var e=[];var i=null;var b=hub.Enumerator._hub_popContext();for(var g=0;g<d;g++){var c=this.nextObject(g,i,b);var h=c?(c.get?c.get(j):c[j]):null;var a=(f===undefined)?!!h:hub.isEqual(h,f);if(a){e.push(c)}i=c}i=null;b=hub.Enumerator._hub_pushContext(b);return e},find:function(h,d){if(typeof h!=="function"){throw new TypeError()}var c=this.get?this.get("length"):this.length;if(d===undefined){d=null}var g=null,b,i=false,e=null;var a=hub.Enumerator._hub_popContext();for(var f=0;f<c&&!i;f++){b=this.nextObject(f,g,a);if(i=h.call(d,b,f,this)){e=b}g=b}b=g=null;a=hub.Enumerator._hub_pushContext(a);return e},findProperty:function(i,f){var c=this.get?this.get("length"):this.length;var j=false,d=null,h=null,b,g;var a=hub.Enumerator._hub_popContext();for(var e=0;e<c&&!j;e++){b=this.nextObject(e,h,a);g=b?(b.get?b.get(i):b[i]):null;j=(f===undefined)?!!g:hub.isEqual(g,f);if(j){d=b}h=b}h=b=null;a=hub.Enumerator._hub_pushContext(a);return d},every:function(h,g){if(typeof h!=="function"){throw new TypeError()}var b=this.get?this.get("length"):this.length;if(g===undefined){g=null}var c=true;var f=null;var d=hub.Enumerator._hub_popContext();for(var a=0;c&&(a<b);a++){var e=this.nextObject(a,f,d);if(!h.call(g,e,a,this)){c=false}f=e}f=null;d=hub.Enumerator._hub_pushContext(d);return c},everyProperty:function(i,e){var c=this.get?this.get("length"):this.length;var d=true;var h=null;var a=hub.Enumerator._hub_popContext();for(var f=0;d&&(f<c);f++){var b=this.nextObject(f,h,a);var g=b?(b.get?b.get(i):b[i]):null;d=(e===undefined)?!!g:hub.isEqual(g,e);h=b}h=null;a=hub.Enumerator._hub_pushContext(a);return d},some:function(h,g){if(typeof h!=="function"){throw new TypeError()}var b=this.get?this.get("length"):this.length;if(g===undefined){g=null}var c=false;var f=null;var d=hub.Enumerator._hub_popContext();for(var a=0;(!c)&&(a<b);a++){var e=this.nextObject(a,f,d);if(h.call(g,e,a,this)){c=true}f=e}f=null;d=hub.Enumerator._hub_pushContext(d);return c},someProperty:function(i,e){var c=this.get?this.get("length"):this.length;var d=false;var h=null;var a=hub.Enumerator._hub_popContext();for(var f=0;!d&&(f<c);f++){var b=this.nextObject(f,h,a);var g=b?(b.get?b.get(i):b[i]):null;d=(e===undefined)?!!g:hub.isEqual(g,e);h=b}h=null;a=hub.Enumerator._hub_pushContext(a);return d},reduce:function(g,h,i){if(typeof g!=="function"){throw new TypeError()}var c=this.get?this.get("length"):this.length;if(c===0&&h===undefined){throw new TypeError()}var d=h;var f=null;var a=hub.Enumerator._hub_popContext();for(var e=0;e<c;e++){var b=this.nextObject(e,f,a);if(b!==null){if(d===undefined){d=b}else{d=g.call(null,d,b,e,this,i)}}f=b}f=null;a=hub.Enumerator._hub_pushContext(a);if(d===undefined){throw new TypeError()}return d},invoke:function(h){var e=this.get?this.get("length"):this.length;if(e<=0){return[]}var i;var g=[];var c=arguments.length;if(c>1){for(i=1;i<c;i++){g.push(arguments[i])}}var f=[];var j=null;var b=hub.Enumerator._hub_popContext();for(i=0;i<e;i++){var d=this.nextObject(i,j,b);var a=d?d[h]:null;if(a){f[i]=a.apply(d,g)}j=d}j=null;b=hub.Enumerator._hub_pushContext(b);return f},invokeWhile:function(d,i){var f=this.get?this.get("length"):this.length;if(f<=0){return null}var j;var h=[];var c=arguments.length;if(c>2){for(j=2;j<c;j++){h.push(arguments[j])}}var g=d;var l=null;var b=hub.Enumerator._hub_popContext();for(j=0;(g===d)&&(j<f);j++){var e=this.nextObject(j,l,b);var a=e?e[i]:null;if(a){g=a.apply(e,h)}l=e}l=null;b=hub.Enumerator._hub_pushContext(b);return g},toArray:function(){var a=[];this.forEach(function(b){a.push(b)},this);return a}};hub._hub_buildReducerFor=function(a,b){return function(d,e){var f=this[a];if(hub.typeOf(f)!==hub.T_FUNCTION){return this.unknownProperty?this.unknownProperty(d,e):null}else{var c=hub.Enumerable.reduce.call(this,f,null,b);return c}}.property("[]")};hub.Reducers={"[]":function(a,b){return this}.property(),enumerableContentDidChange:function(b,a){this.notifyPropertyChange("[]");return this},reducedProperty:function(i,g,f){if(!i||i.charAt(0)!=="@"){return undefined}var d=i.match(/^@([^(]*)(\(([^)]*)\))?$/);if(!d||d.length<2){return undefined}var h=d[1];var j=d[3];h="reduce"+h.slice(0,1).toUpperCase()+h.slice(1);var a=this[h];if(hub.typeOf(a)!==hub.T_FUNCTION){return undefined}if(f===false){return hub.Enumerable.reduce.call(this,a,null,j)}var c=hub._hub_buildReducerFor(h,j);var b=this.constructor.prototype;if(b){b[i]=c;var e=b._hub_properties||[];e.push(i);b._hub_properties=e;this.registerDependentKey(i,"[]")}return hub.Enumerable.reduce.call(this,a,null,j)},reduceMax:function(a,d,b,f,c){if(c&&d){d=d.get?d.get(c):d[c]}if(a===null){return d}return(d>a)?d:a},reduceMaxObject:function(b,f,c,g,d){var a=b,h=f;if(d){if(f){h=f.get?f.get(d):f[d]}if(b){a=b.get?b.get(d):b[d]}}if(a===null){return f}return(h>a)?f:b},reduceMin:function(a,d,b,f,c){if(c&&d){d=d.get?d.get(c):d[c]}if(a===null){return d}return(d<a)?d:a},reduceMinObject:function(b,f,c,g,d){var a=b,h=f;if(d){if(f){h=f.get?f.get(d):f[d]}if(b){a=b.get?b.get(d):b[d]}}if(a===null){return f}return(h<a)?f:b},reduceAverage:function(b,g,d,h,f){if(f&&g){g=g.get?g.get(f):g[f]}var c=(b||0)+g;var a=h.get?h.get("length"):h.length;if(d>=a-1){c=c/a}return c},reduceSum:function(a,d,b,f,c){if(c&&d){d=d.get?d.get(c):d[c]}return(a===null)?d:a+d}};hub.mixin(hub.Enumerable,hub.Reducers);hub.mixin(Array.prototype,hub.Reducers);Array.prototype.isEnumerable=true;(function(){var a={nextObject:hub.Enumerable.nextObject,enumerator:hub.Enumerable.enumerator,firstObject:hub.Enumerable.firstObject,sortProperty:hub.Enumerable.sortProperty,mapProperty:function(g){var e=this.length;var f=[];for(var d=0;d<e;d++){var h=this[d];f[d]=h?(h.get?h.get(g):h[g]):null}return f},filterProperty:function(h,j){var f=this.length;var g=[];for(var e=0;e<f;e++){var i=this[e];var l=i?(i.get?i.get(h):i[h]):null;var d=(j===undefined)?!!l:hub.isEqual(l,j);if(d){g.push(i)}}return g},find:function(j,i){if(typeof j!=="function"){throw new TypeError()}var e=this.length;if(i===undefined){i=null}var g,f=null,h=false;for(var d=0;d<e&&!h;d++){g=this[d];if(h=j.call(i,g,d,this)){f=g}}g=null;return f},findProperty:function(g,j){var e=this.length;var h,l,i=false,f=null;for(var d=0;d<e&&!i;d++){l=(h=this[d])?(h.get?h.get(g):h[g]):null;i=(j===undefined)?!!l:hub.isEqual(l,j);if(i){f=h}}h=null;return f},everyProperty:function(g,i){var e=this.length;var f=true;for(var d=0;f&&(d<e);d++){var h=this[d];var j=h?(h.get?h.get(g):h[g]):null;f=(i===undefined)?!!j:hub.isEqual(j,i)}return f},someProperty:function(g,i){var e=this.length;var f=false;for(var d=0;!f&&(d<e);d++){var h=this[d];var j=h?(h.get?h.get(g):h[g]):null;f=(i===undefined)?!!j:hub.isEqual(j,i)}return f},invoke:function(f){var e=this.length;if(e<=0){return[]}var d;var h=[];var j=arguments.length;if(j>1){for(d=1;d<j;d++){h.push(arguments[d])}}var g=[];for(d=0;d<e;d++){var i=this[d];var l=i?i[f]:null;if(l){g[d]=l.apply(i,h)}}return g},invokeWhile:function(f,l){var h=this.length;if(h<=0){return null}var m;var j=[];var e=arguments.length;if(e>2){for(m=2;m<e;m++){j.push(arguments[m])}}var i=f;for(m=0;(i===f)&&(m<h);m++){var g=this[m];var d=g?g[l]:null;if(d){i=d.apply(g,j)}}return i},toArray:function(){var e=this.length;if(e<=0){return[]}var f=[];for(var d=0;d<e;d++){var g=this[d];f.push(g)}return f},getEach:function(g){var f=[];var e=this.length;for(var d=0;d<e;d++){var h=this[d];f[d]=h?(h.get?h.get(g):h[g]):null}return f},setEach:function(f,g){var e=this.length;for(var d=0;d<e;d++){var h=this[d];if(h){if(h.set){h.set(f,g)}else{h[f]=g}}}return this}};var c={forEach:function(h,g){if(typeof h!=="function"){throw new TypeError()}var e=this.length;if(g===undefined){g=null}for(var d=0;d<e;d++){var f=this[d];h.call(g,f,d,this)}return this},map:function(i,h){if(typeof i!=="function"){throw new TypeError()}var e=this.length;if(h===undefined){h=null}var f=[];for(var d=0;d<e;d++){var g=this[d];f[d]=i.call(h,g,d,this)}return f},filter:function(i,h){if(typeof i!=="function"){throw new TypeError()}var e=this.length;if(h===undefined){h=null}var f=[];for(var d=0;d<e;d++){var g=this[d];if(i.call(h,g,d,this)){f.push(g)}}return f},every:function(i,h){if(typeof i!=="function"){throw new TypeError()}var e=this.length;if(h===undefined){h=null}var f=true;for(var d=0;f&&(d<e);d++){var g=this[d];if(!i.call(h,g,d,this)){f=false}}return f},some:function(i,h){if(typeof i!=="function"){throw new TypeError()}var e=this.length;if(h===undefined){h=null}var f=false;for(var d=0;(!f)&&(d<e);d++){var g=this[d];if(i.call(h,g,d,this)){f=true}}return f},reduce:function(j,f,i){if(typeof j!=="function"){throw new TypeError()}var e=this.length;if(e===0&&f===undefined){throw new TypeError()}var g=f;for(var d=0;d<e;d++){var h=this[d];if(h!==null){if(g===undefined){g=h}else{g=j.call(null,g,h,d,this,i)}}}if(g===undefined){throw new TypeError()}return g}};for(var b in c){if(!c.hasOwnProperty(b)){continue}if(!Array.prototype[b]||((typeof Prototype==="object")&&Prototype.Version.match(/^1\.6/))){Array.prototype[b]=c[b]}}hub.mixin(Array.prototype,a)})();hub.RangeObserver={isRangeObserver:true,toString:function(){var a=this.indexes?this.indexes.toString():"hub.IndexSet<..>";return a.replace("IndexSet","RangeObserver(%@)".fmt(hub.guidFor(this)))},create:function(d,f,e,g,c,a){var b=hub.beget(this);b.source=d;b.indexes=f?f.frozenCopy():null;b.target=e;b.method=g;b.context=c;b.isDeep=a||false;b.beginObserving();return b},extend:function(e){var d=hub.beget(this),c=arguments,b=c.length,a;for(a=0;a<b;a++){hub.mixin(d,c[a])}return d},destroy:function(a){this.endObserving();return this},update:function(a,b){if(this.indexes&&this.indexes.isEqual(b)){return this}this.indexes=b?b.frozenCopy():null;this.endObserving().beginObserving();return this},beginObserving:function(){if(!this.isDeep){return this}var b=this.observing;if(!b){b=this.observing=hub.CoreSet.create()}var a=this._hub_beginObservingForEach;if(!a){a=this._hub_beginObservingForEach=function(c){var d=this.source.objectAt(c);if(d&&d.addObserver){b.push(d);d._hub_kvo_needsRangeObserver=true}}}this.indexes.forEach(a,this);this.isObserving=false;hub.Observers.addPendingRangeObserver(this);return this},setupPending:function(a){var d=this.observing;if(this.isObserving||!d||(d.get("length")===0)){return true}if(d.contains(a)){this.isObserving=true;var b=this._hub_setupPendingForEach;if(!b){var c=this.source,e=this.objectPropertyDidChange;b=this._hub_setupPendingForEach=function(f){var i=this.source.objectAt(f),g=hub.guidFor(i),h;if(i&&i.addObserver){d.push(i);i.addObserver("*",this,e);h=this[g];if(h===undefined||h===null){this[g]=f}else{if(h.isIndexSet){h.add(f)}else{h=this[g]=hub.IndexSet.create(h).add(f)}}}}}this.indexes.forEach(b,this);return true}else{return false}},endObserving:function(){if(!this.isDeep){return this}var e=this.observing;if(this.isObserving){var b=this.objectPropertyDidChange,c=this.source,a,f,d;if(e){f=e.length;for(a=0;a<f;a++){d=e[a];d.removeObserver("*",this,b);this[hub.guidFor(d)]=null}e.length=0}this.isObserving=false}if(e){e.clear()}return this},rangeDidChange:function(b){var a=this.indexes;if(!b||!a||a.intersects(b)){this.endObserving();this.method.call(this.target,this.source,null,"[]",b,this.context);this.beginObserving()}return this},objectPropertyDidChange:function(d,f,g,a){var e=this.context,h=this.method,c=hub.guidFor(d),b=this[c];if(b&&!b.isIndexSet){b=this[c]=hub.IndexSet.create(b).freeze()}if(e){h.call(this.target,this.source,d,f,b,e,a)}else{h.call(this.target,this.source,d,f,b,a)}}};hub.OUT_OF_RANGE_EXCEPTION="Index out of range.";hub.Array={isHubArray:true,replace:function(a,c,b){throw"replace() must be implemented to conform to hub.Array"},objectAt:function(a){if(a<0){return undefined}if(a>=this.get("length")){return undefined}return this.get(a)},"[]":function(a,b){if(b!==undefined){this.replace(0,this.get("length"),b)}return this}.property(),insertAt:function(a,b){if(a>this.get("length")){throw hub.OUT_OF_RANGE_EXCEPTION}this.replace(a,0,[b]);return this},removeAt:function(d,a){var c=0,b=[];if(typeof d===hub.T_NUMBER){if((d<0)||(d>=this.get("length"))){throw hub.OUT_OF_RANGE_EXCEPTION}if(a===undefined){this.replace(d,1,b);return this}else{d=hub.IndexSet.create(d,a)}}this.beginPropertyChanges();d.forEachRange(function(f,e){f-=c;c+=e;this.replace(f,e,b)},this);this.endPropertyChanges();return this},removeObject:function(b){var c=this.get("length")||0;while(--c>=0){var a=this.objectAt(c);if(a==b){this.removeAt(c)}}return this},removeObjects:function(a){this.beginPropertyChanges();a.forEach(function(b){this.removeObject(b)},this);this.endPropertyChanges();return this},pushObject:function(a){this.insertAt(this.get("length"),a);return a},pushObjects:function(a){this.beginPropertyChanges();a.forEach(function(b){this.pushObject(b)},this);this.endPropertyChanges();return this},popObject:function(){var a=this.get("length");if(a===0){return null}var b=this.objectAt(a-1);this.removeAt(a-1);return b},shiftObject:function(){if(this.get("length")===0){return null}var a=this.objectAt(0);this.removeAt(0);return a},unshiftObject:function(a){this.insertAt(0,a);return a},unshiftObjects:function(a){this.beginPropertyChanges();a.forEach(function(b){this.unshiftObject(b)},this);this.endPropertyChanges();return this},isEqual:function(a){if(!a){return false}if(a==this){return true}var b=a.get("length");if(b!=this.get("length")){return false}while(--b>=0){if(!hub.isEqual(a.objectAt(b),this.objectAt(b))){return false}}return true},compact:function(){return this.without(null)},without:function(b){if(this.indexOf(b)<0){return this}var a=[];this.forEach(function(c){if(c!==b){a[a.length]=c}});return a},uniq:function(){var a=[];this.forEach(function(b){if(a.indexOf(b)<0){a[a.length]=b}});return a},rangeObserverClass:hub.RangeObserver,addRangeObserver:function(d,f,h,e){var a=this._hub_array_rangeObservers;if(!a){a=this._hub_array_rangeObservers=hub.CoreSet.create()}if(this._hub_array_oldLength===undefined){this._hub_array_oldLength=this.get("length")}var g=this.rangeObserverClass;var b=false;var c=g.create(this,d,f,h,e,b);a.add(c);if(!this._hub_array_isNotifyingRangeObservers){this._hub_array_isNotifyingRangeObservers=true;this.addObserver("[]",this,this._hub_array_notifyRangeObservers)}return c},updateRangeObserver:function(b,a){return b.update(this,a)},removeRangeObserver:function(c){var b=c.destroy(this);var a=this._hub_array_rangeObservers;if(a){a.remove(c)}return b},enumerableContentDidChange:function(h,g,f){var a=this._hub_array_rangeObservers,d=this._hub_array_oldLength,e,c,b;this.beginPropertyChanges();this.notifyPropertyChange("length");if(a&&a.length>0){if(d===undefined){d=0}this._hub_array_oldLength=e=this.get("length");if(h===undefined){h=0}if(f===undefined){f=e-d}if(f!==0||g===undefined){c=e-h;if(f<0){c-=f}}else{c=g}b=this._hub_array_rangeChanges;if(!b){b=this._hub_array_rangeChanges=hub.IndexSet.create()}b.add(h,c)}this.notifyPropertyChange("[]");this.endPropertyChanges();return this},_hub_array_notifyRangeObservers:function(){var c=this._hub_array_rangeObservers,d=this._hub_array_rangeChanges,b=c?c.length:0,a,e;if(b>0&&d&&d.length>0){for(a=0;a<b;a++){c[a].rangeDidChange(d)}d.clear()}}};hub.mixin(Array.prototype,hub.Array);hub.Array=hub.mixin({},hub.Enumerable,hub.Array);hub.Array.slice=function(b,d){var a=[];var c=this.get("length");if(hub.none(b)){b=0}if(hub.none(d)||(d>c)){d=c}while(b<d){a[a.length]=this.objectAt(b++)}return a};hub.Array.indexOf=function(d,c){var b,a=this.get("length");if(c===undefined){c=0}else{c=(c<0)?Math.ceil(c):Math.floor(c)}if(c<0){c+=a}for(b=c;b<a;b++){if(this.objectAt(b)===d){return b}}return -1};if(!Array.prototype.indexOf){Array.prototype.indexOf=hub.Array.indexOf}hub.Array.lastIndexOf=function(d,c){var b,a=this.get("length");if(c===undefined){c=a-1}else{c=(c<0)?Math.ceil(c):Math.floor(c)}if(c<0){c+=a}for(b=c;b>=0;b--){if(this.objectAt(b)===d){return b}}return -1};if(!Array.prototype.lastIndexOf){Array.prototype.lastIndexOf=hub.Array.lastIndexOf}(function(){hub.mixin(Array.prototype,{replace:function(d,g,f){if(this.isFrozen){throw hub.FROZEN_ERROR}if(!f||f.length===0){this.splice(d,g)}else{var e=[d,g].concat(f);this.splice.apply(this,e)}var c=f?(f.get?f.get("length"):f.length):0;this.enumerableContentDidChange(d,g,c-g);return this},unknownProperty:function(d,e){var c=this.reducedProperty(d,e);if((e!==undefined)&&c===undefined){c=this[d]=e}return c}});var b=Array.prototype.indexOf;if(!b||(b===hub.Array.indexOf)){Array.prototype.indexOf=function(f,e){var d,c=this.length;if(e===undefined){e=0}else{e=(e<0)?Math.ceil(e):Math.floor(e)}if(e<0){e+=c}for(d=e;d<c;d++){if(this[d]===f){return d}}return -1}}var a=Array.prototype.lastIndexOf;if(!a||(a===hub.Array.lastIndexOf)){Array.prototype.lastIndexOf=function(f,e){var d,c=this.length;if(e===undefined){e=c-1}else{e=(e<0)?Math.ceil(e):Math.floor(e)}if(e<0){e+=c}for(d=e;d>=0;d--){if(this[d]===f){return d}}return -1}}})();hub.Comparable={isComparable:true,compare:function(d,c){throw"%@.compare() is not implemented".fmt(this.toString())}};hub.Copyable={isCopyable:true,copy:function(){throw"%@.copy() is not implemented"},frozenCopy:function(){var a=this.get?this.get("isFrozen"):this.isFrozen;if(a===true){return this}else{if(a===undefined){throw"%@ does not support freezing".fmt(this)}else{return this.copy().freeze()}}}};hub.mixin(Array.prototype,hub.Copyable);Array.prototype.copy=Array.prototype.slice;hub.DelegateSupport={delegateFor:function(c){var b=1,a=arguments.length,d;while(b<a){d=arguments[b];if(d&&d[c]!==undefined){return d}b++}return(this[c]!==undefined)?this:null},invokeDelegateMethod:function(c,a,b){b=hub.A(arguments);b=b.slice(2,b.length);if(!c||!c[a]){c=this}var d=c[a];return d?d.apply(c,b):null},getDelegateProperty:function(d,e){var b=1,a=arguments.length,c;while(b<a){c=arguments[b++];if(c&&c[d]!==undefined){return c.get?c.get(d):c[d]}}return(this[d]!==undefined)?this.get(d):undefined}};hub.FROZEN_ERROR=new Error("Cannot modify a frozen object");hub.Freezable={isFreezable:true,isFrozen:false,freeze:function(){if(this.set){this.set("isFrozen",true)}else{this.isFrozen=true}return this}};hub.mixin(Array.prototype,hub.Freezable);hub.Set=hub.mixin({},hub.Enumerable,hub.Observable,hub.Copyable,hub.Freezable,{create:function(b){var c,a,d=hub.Set._hub_pool,e=this.isObservable;if(!e&&b===undefined&&d.length>0){c=d.pop()}else{c=hub.beget(this);if(e){c.initObservable()}if(b&&b.isEnumerable&&b.get("length")>0){c.isObservable=false;if(b.isHubArray){a=b.get?b.get("length"):b.length;while(--a>=0){c.add(b.objectAt(a))}}else{if(b.isSet){a=b.length;while(--a>=0){c.add(b[a])}}else{b.forEach(function(f){c.add(f)},this)}}c.isObservable=e}}return c},isSet:true,length:0,firstObject:function(){return(this.length>0)?this[0]:undefined}.property(),clear:function(){if(this.isFrozen){throw hub.FROZEN_ERROR}this.length=0;return this},contains:function(b){if(b===null){return false}var a=this[hub.hashFor(b)];return(!hub.none(a)&&(a<this.length)&&(this[a]===b))},isEqual:function(a){if(!a||!a.isSet||(a.get("length")!==this.get("length"))){return false}var b=this.get("length");while(--b>=0){if(!a.contains(this[b])){return false}}return true},add:function(d){if(this.isFrozen){throw hub.FROZEN_ERROR}if(d===null||d===undefined){return this}var c=hub.hashFor(d);var b=this[c];var a=this.length;if((b===null||b===undefined)||(b>=a)||(this[b]!==d)){this[a]=d;this[c]=a;this.length=a+1}if(this.isObservable){this.enumerableContentDidChange()}return this},addEach:function(c){if(this.isFrozen){throw hub.FROZEN_ERROR}if(!c||!c.isEnumerable){throw"%@.addEach must pass enumerable".fmt(this)}var a,b=this.isObservable;if(b){this.beginPropertyChanges()}if(c.isHubArray){a=c.get("length");while(--a>=0){this.add(c.objectAt(a))}}else{if(c.isSet){a=c.length;while(--a>=0){this.add(c[a])}}else{c.forEach(function(d){this.add(d)},this)}}if(b){this.endPropertyChanges()}return this},remove:function(d){if(this.isFrozen){throw hub.FROZEN_ERROR}if(hub.none(d)){return this}var c=hub.hashFor(d);var b=this[c];var a=this.length;if(hub.none(b)||(b>=a)||(this[b]!==d)){return this}delete this[c];if(b<(a-1)){d=this[b]=this[a-1];this[hub.hashFor(d)]=b}this.length=a-1;if(this.isObservable){this.enumerableContentDidChange()}return this},pop:function(){if(this.isFrozen){throw hub.FROZEN_ERROR}var a=(this.length>0)?this[this.length-1]:null;if(a){this.remove(a)}return a},removeEach:function(c){if(this.isFrozen){throw hub.FROZEN_ERROR}if(!c||!c.isEnumerable){throw"%@.addEach must pass enumerable".fmt(this)}var a,b=this.isObservable;if(b){this.beginPropertyChanges()}if(c.isHubArray){a=c.get("length");while(--a>=0){this.remove(c.objectAt(a))}}else{if(c.isSet){a=c.length;while(--a>=0){this.remove(c[a])}}else{c.forEach(function(d){this.remove(d)},this)}}if(b){this.endPropertyChanges()}return this},copy:function(){return this.constructor.create(this)},destroy:function(){this.isFrozen=false;if(!this.isObservable){hub.Set._hub_pool.push(this.clear())}return this},forEach:function(c,d){var b=this.length;if(!d){d=this}for(var a=0;a<b;a++){c.call(d,this[a],a,this)}return this},toString:function(){var b=this.length,a,c=[];for(a=0;a<b;a++){c[a]=this[a]}return"hub.Set<%@>".fmt(c.join(","))},_hub_pool:[],isObservable:true});hub.Set.constructor=hub.Set;hub.Set.clone=hub.Set.copy;hub.Set.push=hub.Set.unshift=hub.Set.add;hub.Set.shift=hub.Set.pop;hub.Set.addObject=hub.Set.add;hub.Set.removeObject=hub.Set.remove;hub.Set._hub_pool=[];hub.CoreSet=hub.beget(hub.Set);hub.CoreSet.isObservable=false;hub.CoreSet.constructor=hub.CoreSet;hub.BENCHMARK_OBJECTS=false;hub._hub_object_extend=function _hub_object_extend(g,f){if(!f){f={}}g._hub_kvo_cloned=null;var x,n,t,e,h=g.concatenatedProperties,l=hub.K;var c,b;n=(h)?h.length:0;var a=(n>0)?{}:null;while(--n>=0){x=h[n];c=g[x];b=f[x];if(c){if(!(c instanceof Array)){c=hub.$A(c)}a[x]=(b)?c.concat(b):b}else{if(!(b instanceof Array)){b=hub.$A(b)}a[x]=b}}var w=g._hub_bindings,m=false;var u=g._hub_observers,v=false;var i=g._hub_properties,d=false;var q,j,o;var s=g.outlets,r=false;if(f.outlets){s=(s||hub.EMPTY_ARRAY).concat(f.outlets);r=true}for(x in f){if(x==="_kvo_cloned"){continue}if(!f.hasOwnProperty(x)){continue}var p=(a.hasOwnProperty(x)?a[x]:null)||f[x];if(x.slice(-7)==="Binding"){if(!m){w=(w||hub.EMPTY_ARRAY).slice();m=true}if(w===null){w=(g._hub_bindings||hub.EMPTY_ARRAY).slice()}w[w.length]=x}else{if(p&&(p instanceof Function)){if(!p.superclass&&(p!==(e=g[x]))){p.superclass=p.base=e||l}if(p.propertyPaths){if(!v){u=(u||hub.EMPTY_ARRAY).slice();v=true}u[u.length]=x}else{if(q=p.localPropertyPaths){j=q.length;while(--j>=0){o=g._hub_kvo_for(hub.keyFor("_kvo_local",q[j]),hub.Set);o.add(x);g._hub_kvo_for("_kvo_observed_keys",hub.CoreSet).add(q[j])}}else{if(p.dependentKeys){if(!d){i=(i||hub.EMPTY_ARRAY).slice();d=true}i[i.length]=x}else{if(p.autoconfiguredOutlet){if(!r){s=(s||hub.EMPTY_ARRAY).slice();r=true}s[s.length]=x}}}}}}g[x]=p}if(f.hasOwnProperty("toString")){x="toString";p=(a.hasOwnProperty(x)?a[x]:null)||f[x];if(!p.superclass&&(p!==(e=g[x]))){p.superclass=p.base=e||l}g[x]=p}g._hub_bindings=w||[];g._hub_observers=u||[];g._hub_properties=i||[];g.outlets=s||[];return g};hub.Object=function(a){return this._hub_object_init(a)};hub.mixin(hub.Object,{mixin:function(b){var a=arguments.length,c;for(c=0;c<a;c++){hub.mixin(this,arguments[c])}return this},superclass:null,extend:function(e){var d=hub.BENCHMARK_OBJECTS;if(d){hub.Benchmark.start("hub.Object.extend")}var g,c=function(h){return this._hub_object_init(h)};for(g in this){if(!this.hasOwnProperty(g)){continue}c[g]=this[g]}if(this.hasOwnProperty("toString")){c.toString=this.toString}c.superclass=this;hub.generateGuid(c);c.subclasses=hub.Set.create();this.subclasses.add(c);var f=(c.prototype=hub.beget(this.prototype));var b,a=arguments.length;for(b=0;b<a;b++){hub._hub_object_extend(f,arguments[b])}f.constructor=c;if(d){hub.Benchmark.end("hub.Object.extend")}return c},create:function(a){var b=this;return new b(arguments)},isClass:true,subclasses:hub.Set.create(),toString:function(){return hub._hub_object_className(this)},subclassOf:function(a){if(this===a){return false}var b=this;while(b=b.superclass){if(b===a){return true}}return false},hasSubclass:function(a){return(a&&a.subclassOf)?a.subclassOf(this):false},kindOf:function(a){return(this===a)||this.subclassOf(a)}});hub.Object.prototype={_hub_kvo_enabled:true,_hub_object_init:function(c){var b,a=(c)?c.length:0;for(b=0;b<a;b++){hub._hub_object_extend(this,c[b])}hub.generateGuid(this);this.init();var d=this.initMixin;a=(d)?d.length:0;for(b=0;b<a;b++){d[b].call(this)}return this},mixin:function(){var b,a=arguments.length;for(b=0;b<a;b++){hub.mixin(this,arguments[b])}for(b=0;b<a;b++){var c=arguments[b].initMixin;if(c){c.call(this)}}return this},init:function(){this.initObservable();return this},isDestroyed:false,destroy:function(){if(this.get("isDestroyed")){return this}this.set("isDestroyed",true);var b,c=this.destroyMixin,a=(c)?c.length:0;for(b=0;b<a;b++){c[b].call(this)}return this},isObject:true,respondsTo:function(a){return !!(hub.typeOf(this[a])===hub.T_FUNCTION)},tryToPerform:function(b,c,a){return this.respondsTo(b)&&(this[b](c,a)!==false)},superclass:function(b){var a=arguments.callee.caller;if(!a){throw"superclass cannot determine the caller method"}return a.superclass?a.superclass.apply(this,arguments):null},instanceOf:function(a){return this.constructor===a},kindOf:function(a){return this.constructor.kindOf(a)},toString:function(){if(!this._hub_object_toString){var a=hub._hub_object_className(this.constructor);var b="%@:%@".fmt(a,hub.guidFor(this));if(a){this._hub_object_toString=b}else{return b}}return this._hub_object_toString},awake:function(a){this.outlets.forEach(function(b){this.get(b)},this);this.bindings.invoke("sync")},invokeOnce:function(a){hub.RunLoop.currentRunLoop.invokeOnce(this,a);return this},invokeLast:function(a){hub.RunLoop.currentRunLoop.invokeLast(this,a);return this},concatenatedProperties:["concatenatedProperties","initMixin","destroyMixin"]};hub.Object.prototype.constructor=hub.Object;hub.mixin(hub.Object.prototype,hub.Observable);function findClassNames(){if(hub._hub_object_foundObjectClassNames){return}hub._hub_object_foundObjectClassNames=true;var b=[];var a=function(c,d,g){g--;if(b.indexOf(d)>=0){return}b.push(d);for(var e in d){if(e=="__scope__"){continue}if(e=="superclass"){continue}if(!e.match(/^[A-Z0-9]/)){continue}var h=(c)?[c,e].join("."):e;var f=d[e];switch(hub.typeOf(f)){case hub.T_CLASS:if(!f._hub_object_className){f._hub_object_className=h}if(g>=0){a(h,f,g)}break;case hub.T_OBJECT:if(g>=0){a(h,f,g)}break;case hub.T_HASH:if(((c)||(h==="hub"))&&(g>=0)){a(h,f,g)}break;default:break}}};a(null,window,2)}hub.instanceOf=function(b,a){return !!(b&&b.constructor===a)};hub.kindOf=function(b,a){if(b&&!b.isClass){b=b.constructor}return !!(b&&b.kindOf&&b.kindOf(a))};hub._hub_object_className=function(b){if(!hub.isReady){return""}if(!b._hub_object_className){findClassNames()}if(b._hub_object_className){return b._hub_object_className}var a=b;while(a&&!a._hub_object_className){a=a.superclass}return(a&&a._hub_object_className)?a._hub_object_className:"Anonymous"};hub._hub_ChainObserver=function(a){this.property=a};hub._hub_ChainObserver.createChain=function(d,j,f,a,b){var c=j.split("."),h=new hub._hub_ChainObserver(c[0]),g=h,e=c.length;for(var i=1;i<e;i++){g=g.next=new hub._hub_ChainObserver(c[i])}h.objectDidChange(d);g.target=f;g.method=a;g.context=b;return h};hub._hub_ChainObserver.prototype={isChainObserver:true,object:null,property:null,next:null,target:null,method:null,objectDidChange:function(a){if(a===this.object){return}if(this.object&&this.object.removeObserver){this.object.removeObserver(this.property,this,this.propertyDidChange)}this.object=a;if(this.object&&this.object.addObserver){this.object.addObserver(this.property,this,this.propertyDidChange)}this.propertyDidChange()},propertyDidChange:function(){var b=this.object;var e=this.property;var d=(b&&b.get)?b.get(e):null;if(this.next){this.next.objectDidChange(d)}var f=this.target,g=this.method,c=this.context;if(f&&g){var a=b?b.propertyRevision:null;if(c){g.call(f,b,e,d,c,a)}else{g.call(f,b,e,d,a)}}},destroyChain:function(){var a=this.object;if(a&&a.removeObserver){a.removeObserver(this.property,this,this.propertyDidChange)}if(this.next){this.next.destroyChain()}this.next=this.target=this.method=this.object=this.context=null;return null}};hub.Observers={queue:[],addObserver:function(c,d,e,b){var a;if(hub.typeOf(c)===hub.T_STRING){a=hub.tupleForPropertyPath(c,b)}else{a=c}if(a){a[0].addObserver(a[1],d,e)}else{this.queue.push([c,d,e,b])}},removeObserver:function(f,g,h,d){var c,b,a,e;a=hub.tupleForPropertyPath(f,d);if(a){a[0].removeObserver(a[1],g,h)}c=this.queue.length;b=this.queue;while(--c>=0){e=b[c];if((e[0]===f)&&(e[1]===g)&&(e[2]==h)&&(e[3]===d)){b[c]=null}}},addPendingRangeObserver:function(a){var b=this.rangeObservers;if(!b){b=this.rangeObservers=hub.CoreSet.create()}b.add(a);return this},_hub_TMP_OUT:[],flush:function(a){var e=this.queue;if(e&&e.length>0){var h=(this.queue=[]);var i=e.length;while(--i>=0){var j=e[i];if(!j){continue}var f=hub.tupleForPropertyPath(j[0],j[3]);if(f){f[0].addObserver(f[1],j[1],j[2])}else{h.push(j)}}}if(a._hub_kvo_needsRangeObserver){var g=this.rangeObservers,d=g?g.get("length"):0,b=this._hub_TMP_OUT,c;for(i=0;i<d;i++){c=g[i];if(c.setupPending(a)){b.push(c)}}if(b.length>0){g.removeEach(b)}b.length=0;a._hub_kvo_needsRangeObserver=false}},isObservingSuspended:0,_hub_pending:hub.CoreSet.create(),objectHasPendingChanges:function(a){this._hub_pending.add(a)},suspendPropertyObserving:function(){this.isObservingSuspended++},resumePropertyObserving:function(){var c;if(--this.isObservingSuspended<=0){c=this._hub_pending;this._hub_pending=hub.CoreSet.create();var b,a=c.length;for(b=0;b<a;b++){c[b]._hub_notifyPropertyObservers()}c.clear();c=null}}};hub.LOG_BINDINGS=false;hub.BENCHMARK_BINDING_NOTIFICATIONS=false;hub.BENCHMARK_BINDING_SETUP=false;hub.MULTIPLE_PLACEHOLDER="@@MULT@@";hub.NULL_PLACEHOLDER="@@NULL@@";hub.EMPTY_PLACEHOLDER="@@EMPTY@@";hub.Binding={beget:function(b){var a=hub.beget(this);a.parentBinding=this;if(b!==undefined){a=a.from(b)}return a},builder:function(){var b=this;var a=function(c){return b.beget().from(c)};a.beget=function(){return b.beget()};return a},from:function(b,a){if(!b){return this}var c=(this===hub.Binding)?this.beget():this;c._hub_fromPropertyPath=b;c._hub_fromRoot=a;c._hub_fromTuple=null;return c},to:function(b,a){var c=(this===hub.Binding)?this.beget():this;c._hub_toPropertyPath=b;c._hub_toRoot=a;c._hub_toTuple=null;return c},connect:function(){if(this.isConnected){return this}this.isConnected=true;this._hub_connectionPending=true;this._hub_syncOnConnect=true;hub.Binding._hub_connectQueue.add(this);return this},_hub_connect:function(){if(!this._hub_connectionPending){return}this._hub_connectionPending=false;var c,a;var b=hub.BENCHMARK_BINDING_SETUP;if(b){hub.Benchmark.start("hub.Binding.connect()")}c=this._hub_fromPropertyPath;a=this._hub_fromRoot;if(hub.typeOf(c)===hub.T_STRING){if(c.indexOf(".")===0){c=c.slice(1);if(!a){a=this._hub_toRoot}}else{if(c.indexOf("*")===0){c=[this._hub_fromRoot||this._hub_toRoot,c.slice(1)];a=null}}}hub.Observers.addObserver(c,this,this.fromPropertyDidChange,a);if(!this._hub_oneWay){c=this._hub_toPropertyPath;a=this._hub_toRoot;hub.Observers.addObserver(c,this,this.toPropertyDidChange,a)}if(b){hub.Benchmark.end("hub.Binding.connect()")}if(this._hub_syncOnConnect){this._hub_syncOnConnect=false;if(b){hub.Benchmark.start("hub.Binding.connect().sync()")}this.sync();if(b){hub.Benchmark.end("hub.Binding.connect().sync()")}}},disconnect:function(){if(!this.isConnected){return this}if(this._hub_connectionPending){this._hub_connectionPending=false}else{hub.Observers.removeObserver(this._hub_fromPropertyPath,this,this.fromPropertyDidChange,this._hub_fromRoot);if(!this._hub_oneWay){hub.Observers.removeObserver(this._hub_toPropertyPath,this,this.toPropertyDidChange,this._hub_toRoot)}}this.isConnected=false;return this},fromPropertyDidChange:function(c,b){var a=c?c.get(b):null;if(a!==this._hub_bindingValue){this._hub_setBindingValue(c,b);this._hub_changePending=true;hub.Binding._hub_changeQueue.add(this)}},toPropertyDidChange:function(c,b){if(this._hub_oneWay){return}var a=c.get(b);if(a!==this._hub_transformedBindingValue){this._hub_setBindingValue(c,b);this._hub_changePending=true;hub.Binding._hub_changeQueue.add(this)}},_hub_setBindingValue:function(b,a){this._hub_bindingSource=b;this._hub_bindingKey=a},_hub_computeBindingValue:function(){var g=this._hub_bindingSource,e=this._hub_bindingKey,c;if(!g){return}this._hub_bindingValue=c=g.getPath(e);var f=this._hub_transforms;if(f){var b=f.length;for(var a=0;a<b;a++){var d=f[a];c=d(c,this)}}if(this._hub_noError&&hub.typeOf(c)===hub.T_ERROR){c=null}this._hub_transformedBindingValue=c},_hub_connectQueue:hub.CoreSet.create(),_hub_alternateConnectQueue:hub.CoreSet.create(),_hub_changeQueue:hub.CoreSet.create(),_hub_alternateChangeQueue:hub.CoreSet.create(),_hub_changePending:false,flushPendingChanges:function(){if(this._hub_isFlushing){return false}this._hub_isFlushing=true;hub.Observers.suspendPropertyObserving();var b=false;var c=hub.LOG_BINDINGS;var a,d;while((a=this._hub_connectQueue).length>0){this._hub_connectQueue=this._hub_alternateConnectQueue;this._hub_alternateConnectQueue=a;while(d=a.pop()){d._hub_connect()}}while((a=this._hub_changeQueue).length>0){if(c){hub.debug("BEGIN","Trigger changed bindings.")}b=true;this._hub_changeQueue=this._hub_alternateChangeQueue;this._hub_alternateChangeQueue=a;while(d=a.pop()){d.applyBindingValue()}if(c){hub.debug("END","Trigger changed bindings.")}}this._hub_isFlushing=false;hub.Observers.resumePropertyObserving();return b},applyBindingValue:function(){this._hub_changePending=false;this._hub_computeBindingTargets();this._hub_computeBindingValue();var a=this._hub_bindingValue;var b=this._hub_transformedBindingValue;var c=hub.BENCHMARK_BINDING_NOTIFICATIONS;var d=hub.LOG_BINDINGS;if(!this._hub_oneWay&&this._hub_fromTarget){if(d){hub.debug(this,"%@ -> %@".fmt(a,b))}if(c){hub.Benchmark.start(this.toString()+"->")}this._hub_fromTarget.setPathIfChanged(this._hub_fromPropertyKey,a);if(c){hub.Benchmark.end(this.toString()+"->")}}if(this._hub_toTarget){if(d){hub.debug(this,"%@ <- %@".fmt(a,b))}if(c){hub.Benchmark.start(this.toString()+"<-")}this._hub_toTarget.setPathIfChanged(this._hub_toPropertyKey,b);if(c){hub.Benchmark.start(this.toString()+"<-")}}},sync:function(){if(!this.isConnected){return this}if(this._hub_connectionPending){this._hub_syncOnConnect=true}else{this._hub_computeBindingTargets();var c=this._hub_fromTarget;var b=this._hub_fromPropertyKey;if(!c||!b){return this}var a=c.getPath(b);if(a!==this._hub_bindingValue){this._hub_setBindingValue(c,b);this._hub_changePending=true;hub.Binding._hub_changeQueue.add(this)}}return this},_hub_syncOnConnect:false,_hub_computeBindingTargets:function(){if(!this._hub_fromTarget){var c,b,a;c=this._hub_fromPropertyPath;b=this._hub_fromRoot;if(hub.typeOf(c)===hub.T_STRING){if(c.indexOf(".")===0){c=c.slice(1);if(!b){b=this._hub_toRoot}}else{if(c.indexOf("*")===0){c=[b||this._hub_toRoot,c.slice(1)];b=null}}}a=hub.tupleForPropertyPath(c,b);if(a){this._hub_fromTarget=a[0];this._hub_fromPropertyKey=a[1]}}if(!this._hub_toTarget){c=this._hub_toPropertyPath;b=this._hub_toRoot;a=hub.tupleForPropertyPath(c,b);if(a){this._hub_toTarget=a[0];this._hub_toPropertyKey=a[1]}}},oneWay:function(c,a){if((a===undefined)&&(hub.typeOf(c)===hub.T_BOOL)){a=c;c=null}var b=this.from(c);if(b===hub.Binding){b=b.beget()}b._hub_oneWay=(a===undefined)?true:a;return b},transform:function(b){var c=(this===hub.Binding)?this.beget():this;var a=c._hub_transforms;if(a&&(a===c.parentBinding._hub_transform)){a=c._hub_transforms=a.slice()}if(!a){a=c._hub_transforms=[]}a.push(b);return c},resetTransforms:function(){var a=(this===hub.Binding)?this.beget():this;a._hub_transforms=null;return a},noError:function(c,a){if((a===undefined)&&(hub.typeOf(c)===hub.T_BOOL)){a=c;c=null}var b=this.from(c);if(b===hub.Binding){b=b.beget()}b._hub_noError=(a===undefined)?true:a;return b},single:function(b,a){if(a===undefined){a=hub.MULTIPLE_PLACEHOLDER}return this.from(b).transform(function(e,d){if(e&&e.isEnumerable){var c=e.get("length");e=(c>1)?a:(c<=0)?null:e.firstObject()}return e})},notEmpty:function(b,a){if(a===undefined){a=hub.EMPTY_PLACEHOLDER}return this.from(b).transform(function(d,c){if(hub.none(d)||(d==="")||(hub.isArray(d)&&d.length===0)){d=a}return d})},notNull:function(b,a){if(a===undefined){a=hub.EMPTY_PLACEHOLDER}return this.from(b).transform(function(d,c){if(hub.none(d)){d=a}return d})},multiple:function(a){return this.from(a).transform(function(b){if(!hub.isArray(b)){b=(b==null)?[]:[b]}return b})},bool:function(a){return this.from(a).transform(function(b){var c=hub.typeOf(b);if(c===hub.T_ERROR){return b}return(c==hub.T_ARRAY)?(b.length>0):(b==="")?false:!!b})},not:function(a){return this.from(a).transform(function(b){var c=hub.typeOf(b);if(c===hub.T_ERROR){return b}return !((c==hub.T_ARRAY)?(b.length>0):(b==="")?false:!!b)})},isNull:function(a){return this.from(a).transform(function(b){var c=hub.typeOf(b);return(c===hub.T_ERROR)?b:hub.none(b)})},toString:function(){var c=this._hub_fromRoot?"<%@>:%@".fmt(this._hub_fromRoot,this._hub_fromPropertyPath):this._hub_fromPropertyPath;var b=this._hub_toRoot?"<%@>:%@".fmt(this._hub_toRoot,this._hub_toPropertyPath):this._hub_toPropertyPath;var a=this._hub_oneWay?"[oneWay]":"";return"hub.Binding%@(%@ -> %@)%@".fmt(hub.guidFor(this),c,b,a)}};hub.binding=function(b,a){return hub.Binding.from(b,a)};hub.Error=hub.Object.extend({code:-1,message:"",errorValue:null,errorObject:function(){return this}.property().cacheable(),label:null,toString:function(){return"hub.Error:%@:%@ (%@)".fmt(hub.guidFor(this),this.get("message"),this.get("code"))},isError:true});hub.Error.desc=function(d,a,e,c){var b={message:d};if(a!==undefined){b.label=a}if(c!==undefined){b.code=c}if(e!==undefined){b.errorValue=e}return this.create(b)};hub.$error=function(b,a,d,e){return hub.Error.desc(b,a,d,e)};hub.ok=function(a){return(a!==false)&&!(a&&a.isError)};hub.$ok=hub.ok;hub.val=function(a){if(a&&a.isError){return a.get?a.get("errorValue"):null}else{return a}};hub.$val=hub.val;hub.Error.HAS_MULTIPLE_VALUES=-100;hub.needRunLoop=true;hub.RunLoop=hub.Object.extend({beginRunLoop:function(){this._hub_start=new Date().getTime();if(hub.LOG_BINDINGS||hub.LOG_OBSERVERS){hub.debug("-> hub.RunLoop.beginRunLoop at %@".fmt(this._hub_start))}hub.needRunLoop=false;return this},endRunLoop:function(){var a;if(hub.LOG_BINDINGS||hub.LOG_OBSERVERS){hub.debug("-- hub.RunLoop.endRunLoop ~ flushing application queues")}do{a=this.flushApplicationQueues();if(!a){a=this._hub_flushinvokeLastQueue()}}while(a);this._hub_start=null;if(hub.LOG_BINDINGS||hub.LOG_OBSERVERS){hub.debug("<- hub.RunLoop.endRunLoop ~ End")}hub.needRunLoop=true;return this},invokeOnce:function(a,b){if(b===undefined){b=a;a=this}if(hub.typeOf(b)===hub.T_STRING){b=a[b]}if(!this._hub_invokeQueue){this._hub_invokeQueue=hub.ObserverSet.create()}this._hub_invokeQueue.add(a,b);return this},invokeLast:function(a,b){if(b===undefined){b=a;a=this}if(hub.typeOf(b)===hub.T_STRING){b=a[b]}if(!this._hub_invokeLastQueue){this._hub_invokeLastQueue=hub.ObserverSet.create()}this._hub_invokeLastQueue.add(a,b);return this},flushApplicationQueues:function(){var b=false;var a=this._hub_invokeQueue;if(a&&a.targets>0){this._hub_invokeQueue=null;b=true;a.invokeMethods()}return hub.Binding.flushPendingChanges()||b},_hub_flushinvokeLastQueue:function(){var a=this._hub_invokeLastQueue,b=false;if(a&&a.targets>0){this._hub_invokeLastQueue=null;b=true;if(b){a.invokeMethods()}}return b}});hub.RunLoop.currentRunLoop=null;hub.RunLoop.runLoopClass=hub.RunLoop;hub.RunLoop.begin=function(){var a=this.currentRunLoop;if(!a){a=this.currentRunLoop=this.runLoopClass.create()}a.beginRunLoop();return this};hub.RunLoop.end=function(){var a=this.currentRunLoop;if(!a){throw"hub.RunLoop.end() called outside of a runloop!"}a.endRunLoop();return this};hub.run=function(b,a){hub.RunLoop.begin();b.call(a);hub.RunLoop.end()};hub.IndexSet=hub.mixin({},hub.Enumerable,hub.Observable,hub.Freezable,hub.Copyable,{_hub_sliceContent:function(e){if(e.length<1000){return e.slice()}var d=0,a=[],b=e[0];while(b!==0){a[d]=b;d=(b<0)?(0-b):b;b=e[d]}a[d]=0;this._hub_hint(0,d,a);return a},create:function(c,b){var a=hub.beget(this);a.initObservable();if(c&&c.isIndexSet){a._hub_content=this._hub_sliceContent(c._hub_content);a.max=c.max;a.length=c.length;a.source=c.source}else{a._hub_content=[0];if(c!==undefined){a.add(c,b)}}return a},isIndexSet:true,HINT_SIZE:256,length:0,max:0,min:function(){var a=this._hub_content,b=a[0];return(b===0)?-1:(b>0)?0:Math.abs(b)}.property("[]").cacheable(),firstObject:function(){return(this.get("length")>0)?this.get("min"):undefined}.property(),rangeStartForIndex:function(c){var f=this._hub_content,a=this.get("max"),b,e,d;if(c>=a){return a}if(Math.abs(f[c])>c){return c}d=c-(c%hub.IndexSet.HINT_SIZE);b=f[d];if(b<0||b>c){b=d}e=Math.abs(f[b]);while(e<c){b=e;e=Math.abs(f[b])}return b},isEqual:function(c){if(c===this){return true}if(!c||!c.isIndexSet||(c.max!==this.max)||(c.length!==this.length)){return false}var e=this._hub_content,b=c._hub_content,d=0,a=e[d];do{if(b[d]!==a){return false}d=Math.abs(a);a=e[d]}while(d!==0);return true},indexBefore:function(b){if(b===0){return -1}b--;var c=this._hub_content,a=this.get("max"),d=this.rangeStartForIndex(b);if(!c){return null}while((d===a)||(c[d]<0)){if(d===0){return -1}b=d-1;d=this.rangeStartForIndex(b)}return b},indexAfter:function(b){var d=this._hub_content,a=this.get("max"),e,c;if(!d||(b>=a)){return -1}b++;e=this.rangeStartForIndex(b);c=d[e];while(c<0){if(c===0){return -1}b=e=Math.abs(c);c=d[e]}return b},contains:function(g,c){var b,f,a,e,d;if(c===undefined){if(g===null||g===undefined){return false}if(typeof g===hub.T_NUMBER){c=1}else{if(g&&g.isIndexSet){if(g===this){return true}b=g._hub_content;f=0;a=b[f];while(a!==0){if((a>0)&&!this.contains(f,a-f)){return false}f=Math.abs(a);a=b[f]}return true}else{c=g.length;g=g.start}}}e=this.rangeStartForIndex(g);d=this._hub_content[e];return(d>0)&&(e<=g)&&(d>=(g+c))},intersects:function(f,c){var b,e,a,d;if(c===undefined){if(typeof f===hub.T_NUMBER){c=1}else{if(f&&f.isIndexSet){if(f===this){return true}b=f._hub_content;e=0;a=b[e];while(a!==0){if((a>0)&&this.intersects(e,a-e)){return true}e=Math.abs(a);a=b[e]}return false}else{c=f.length;f=f.start}}}e=this.rangeStartForIndex(f);b=this._hub_content;a=b[e];d=f+c;while(e<d){if(a===0){return false}if((a>0)&&(a>f)){return true}e=Math.abs(a);a=b[e]}return false},without:function(b,a){if(b===this){return hub.IndexSet.create()}return this.clone().remove(b,a)},replace:function(c,a){if(a===undefined){if(typeof c===hub.T_NUMBER){a=1}else{if(c&&c.isIndexSet){this._hub_content=this._hub_sliceContent(c._hub_content);this.beginPropertyChanges().set("max",c.max).set("length",c.length).set("source",c.source).enumerableContentDidChange().endPropertyChanges();return this}else{a=c.length;c=c.start}}}var b=this.length;this._hub_content.length=1;this._hub_content[0]=0;this.length=this.max=0;return this.add(c,a)},add:function(a,b){if(this.isFrozen){throw hub.FROZEN_ERROR}var e,i,d;if(a&&a.isIndexSet){e=a._hub_content;if(!e){return this}i=0;d=e[0];while(d!==0){if(d>0){this.add(i,d-i)}i=d<0?0-d:d;d=e[i]}return this}else{if(b===undefined){if(a===null||a===undefined){return this}else{if(typeof a===hub.T_NUMBER){b=1}else{b=a.length;a=a.start}}}else{if(b===null){b=1}}}hub_precondition(typeof a===hub.T_NUMBER);hub_precondition(typeof b===hub.T_NUMBER);if(b<=0){return this}var f=this.get("max"),c=f,h,g;e=this._hub_content;if(a===f){if(a>0){i=this.rangeStartForIndex(a-1);d=e[i];if(d>0){delete e[f];e[i]=f=a+b;a=i}else{e[f]=f=a+b}}else{e[a]=f=b}e[f]=0;this.set("max",f);this.set("length",this.length+b);b=f-a}else{if(a>f){e[f]=0-a;e[a]=a+b;e[a+b]=0;this.set("max",a+b);this.set("length",this.length+b);b=a+b-f;a=f}else{i=this.rangeStartForIndex(a);d=e[i];f=a+b;h=0;if((a>0)&&(i===a)&&(d<=0)){i=this.rangeStartForIndex(a-1);d=e[i]}if(d<0){e[i]=0-a;if(Math.abs(d)>f){e[a]=0-f;e[f]=d}else{e[a]=d}}else{a=i;if(d>f){f=d}}i=a;while(i<f){g=e[i];if(g===0){e[f]=0;d=f;h+=f-i}else{d=Math.abs(g);if(d>f){e[f]=g;d=f}if(g<0){h+=d-i}}delete e[i];i=d}if((i=e[f])>0){delete e[f];f=i}e[a]=f;if(f>c){this.set("max",f)}this.set("length",this.get("length")+h);b=f-a}}this._hub_hint(a,b);if(h!==0){this.enumerableContentDidChange()}return this},remove:function(a,b){if(this.isFrozen){throw hub.FROZEN_ERROR}if(b===undefined){if(a===null||a===undefined){return this}else{if(typeof a===hub.T_NUMBER){b=1}else{if(a.isIndexSet){a.forEachRange(this.remove,this);return this}else{b=a.length;a=a.start}}}}if(b<=0){return this}var f=this.get("max"),c=f,e=this._hub_content,j,d,i,g,h;if(a>=f){return this}j=this.rangeStartForIndex(a);d=e[j];h=a+b;i=0;if((a>0)&&(j===a)&&(d>0)){j=this.rangeStartForIndex(a-1);d=e[j]}if(d>0){e[j]=a;if(d>h){e[a]=h;e[h]=d}else{e[a]=d}}else{a=j;d=Math.abs(d);if(d>h){h=d}}j=a;while(j<h){g=e[j];if(g===0){e[h]=0;d=h}else{d=Math.abs(g);if(d>h){e[h]=g;d=h}if(g>0){i+=d-j}}delete e[j];j=d}if((j=e[h])<0){delete e[h];h=Math.abs(j)}if(e[h]===0){delete e[h];e[a]=0;this.set("max",a)}else{e[a]=0-h}this.set("length",this.get("length")-i);b=h-a;this._hub_hint(a,b);if(i!==0){this.enumerableContentDidChange()}return this},_hub_hint:function(g,d,c){if(c===undefined){c=this._hub_content}var b=hub.IndexSet.HINT_SIZE,a=Math.abs(c[g]),f=g-(g%b)+b,e=g+d;while(f<e){while((a!==0)&&(a<=f)){g=a;a=Math.abs(c[g])}if(a===0){delete c[f]}else{if(f!==g){c[f]=g}}f+=b}},clear:function(){if(this.isFrozen){throw hub.FROZEN_ERROR}var a=this.length;this._hub_content.length=1;this._hub_content[0]=0;this.set("length",0).set("max",0);if(a>0){this.enumerableContentDidChange()}},addEach:function(b){if(this.isFrozen){throw hub.FROZEN_ERROR}this.beginPropertyChanges();var a=b.get("length");if(b.isHubArray){while(--a>=0){this.add(b.objectAt(a))}}else{if(b.isEnumerable){b.forEach(function(c){this.add(c)},this)}}this.endPropertyChanges();return this},removeEach:function(b){if(this.isFrozen){throw hub.FROZEN_ERROR}this.beginPropertyChanges();var a=b.get("length");if(b.isHubArray){while(--a>=0){this.remove(b.objectAt(a))}}else{if(b.isEnumerable){b.forEach(function(c){this.remove(c)},this)}}this.endPropertyChanges();return this},clone:function(){return hub.IndexSet.create(this)},inspect:function(){var e=this._hub_content,b=e.length,a=0,c=[],d;for(a=0;a<b;a++){d=e[a];if(d!==undefined){c.push("%@:%@".fmt(a,d))}}return"hub.IndexSet<%@>".fmt(c.join(" , "))},forEachRange:function(f,d){var b=this._hub_content,e=0,a=b[e],c=this.source;if(d===undefined){d=null}while(a!==0){if(a>0){f.call(d,e,a-e,this,c)}e=Math.abs(a);a=b[e]}return this},forEachIn:function(b,c,j,f){var g=this._hub_content,i=0,h=0,d=b+c,a=this.source,e=g[i];if(f===undefined){f=null}while(e!==0){if(i<b){i=b}while((i<e)&&(i<d)){j.call(f,i++,h++,this,a)}if(i>=d){i=e=0}else{i=Math.abs(e);e=g[i]}}return this},lengthIn:function(g,d){var a=0;if(d===undefined){if(g===null||g===undefined){return 0}else{if(typeof g===hub.T_NUMBER){d=1}else{if(g.isIndexSet){g.forEachRange(function(i,h){a+=this.lengthIn(i,h)},this);return a}else{d=g.length;g=g.start}}}}if(this.get("length")===0){return 0}var c=this._hub_content,f=0,b=c[f],e=g+d;while(f<e&&b!==0){if(b>0){a+=(b>e)?e-f:b-f}f=Math.abs(b);b=c[f]}return a},source:null,indexOf:function(d,c){var f=this.source;if(!f){throw"%@.indexOf() requires source".fmt(this)}var b=f.get("length"),e=this._hub_content,g=e[0]<0?Math.abs(e[0]):0,a;while(g>=0&&g<b){a=f.indexOf(d,g);if(a<0){return -1}if(this.contains(a)){return a}g=a+1}return -1},lastIndexOf:function(d,c){var e=this.source;if(!e){throw"%@.lastIndexOf() requires source".fmt(this)}var b=e.get("length"),f=this.max-1,a;if(f>=b){f=b-1}while(f>=0){a=e.lastIndexOf(d,f);if(a<0){return -1}if(this.contains(a)){return a}f=a+1}return -1},forEachObject:function(g,e){var d=this.source;if(!d){throw"%@.forEachObject() requires source".fmt(this)}var c=this._hub_content,f=0,a=0,b=c[f];if(e===undefined){e=null}while(b!==0){while(f<b){g.call(e,d.objectAt(f),f,d,this);f++}f=Math.abs(b);b=c[f]}return this},addObject:function(c,d){var e=this.source;if(!e){throw"%@.addObject() requires source".fmt(this)}var b=e.get("length"),f=0,a;while(f>=0&&f<b){a=e.indexOf(c,f);if(a>=0){this.add(a);if(d){return this}f=a++}else{return this}}return this},addObjects:function(b,a){b.forEach(function(c){this.addObject(c,a)},this);return this},removeObject:function(c,d){var e=this.source;if(!e){throw"%@.removeObject() requires source".fmt(this)}var b=e.get("length"),f=0,a;while(f>=0&&f<b){a=e.indexOf(c,f);if(a>=0){this.remove(a);if(d){return this}f=a+1}else{return this}}return this},removeObjects:function(b,a){b.forEach(function(c){this.removeObject(c,a)},this);return this},LOG_OBSERVING:false,forEach:function(g,e){var c=this._hub_content,f=0,a=0,d=this.source,b=c[f];if(e===undefined){e=null}while(b!==0){while(f<b){g.call(e,f++,a++,this,d)}f=Math.abs(b);b=c[f]}return this},nextObject:function(f,b,c){var e=this._hub_content,d=c.next,a=this.get("max");if(b===null){b=d=0}else{if(b>=a){delete c.next;return null}else{b++}}if(b===d){do{b=Math.abs(d);d=e[b]}while(d<0);c.next=d}return b},toString:function(){var a=[];this.forEachRange(function(c,b){a.push(b===1?c:"%@..%@".fmt(c,c+b-1))},this);return"hub.IndexSet<%@>".fmt(a.join(","))},max:0});hub.IndexSet.slice=hub.IndexSet.copy=hub.IndexSet.clone;hub.IndexSet.EMPTY=hub.IndexSet.create().freeze();hub.SelectionSet=hub.Object.extend(hub.Enumerable,hub.Freezable,hub.Copyable,{isSelectionSet:true,length:function(){var a=0,b=this._hub_sets,c=this._hub_objects;if(c){a+=c.get("length")}if(b){b.forEach(function(d){a+=d.get("length")})}return a}.property().cacheable(),sources:function(){var c=[],d=this._hub_sets,b=d?d.length:0,a,f,e;for(a=0;a<b;a++){f=d[a];if(f&&f.get("length")>0&&f.source){c.push(f.source)}}return c}.property().cacheable(),indexSetForSource:function(e){if(!e||!e.isHubArray){return null}var b=this._hub_indexSetCache,d=this._hub_objects,c,a;if(!b){b=this._hub_indexSetCache={}}c=b[hub.guidFor(e)];if(c&&c._hub_sourceRevision&&(c._hub_sourceRevision!==e.propertyRevision)){c=null}if(!c){c=this._hub_indexSetForSource(e,false);if(c&&c.get("length")===0){c=null}if(d){if(c){c=c.copy()}d.forEach(function(f){if((a=e.indexOf(f))>=0){if(!c){c=hub.IndexSet.create()}c.add(a)}},this)}if(c){c=b[hub.guidFor(e)]=c.frozenCopy();c._hub_sourceRevision=e.propertyRevision}}return c},_hub_indexSetForSource:function(f,g){if(g===undefined){g=true}var d=hub.guidFor(f),c=this[d],e=this._hub_sets,a=e?e.length:0,b=null;if(c>=a){c=null}if(hub.none(c)){if(g&&!this.isFrozen){this.propertyWillChange("sources");if(!e){e=this._hub_sets=[]}b=e[a]=hub.IndexSet.create();b.source=f;this[d]=a;this.propertyDidChange("sources")}}else{b=e?e[c]:null}return b},add:function(a,b,d){if(this.isFrozen){throw hub.FROZEN_ERROR}var g,f,j,i,c,e,h,l;if(b===undefined&&d===undefined){if(!a){throw"missing params in call to hub.SelectionSet.add()"}if(a.isIndexSet){return this.add(a.source,a)}if(a.isSelectionSet){g=a._hub_sets;l=a._hub_objects;f=g?g.length:0;this.beginPropertyChanges();for(j=0;j<f;j++){i=g[j];if(i&&i.get("length")>0){this.add(i.source,i)}}if(l){this.addObjects(l)}this.endPropertyChanges();return this}}i=this._hub_indexSetForSource(a,true);c=this.get("length");h=i.get("length");e=c-h;i.add(b,d);this._hub_indexSetCache=null;e+=i.get("length");if(e!==c){this.propertyDidChange("length");this.enumerableContentDidChange();if(h===0){this.notifyPropertyChange("sources")}}return this},remove:function(a,b,d){if(this.isFrozen){throw hub.FROZEN_ERROR}var g,f,j,i,c,e,h,l;if(b===undefined&&d===undefined){if(!a){throw"missing params to hub.SelectionSet.remove()"}if(a.isIndexSet){return this.remove(a.source,a)}if(a.isSelectionSet){g=a._hub_sets;l=a._hub_objects;f=g?g.length:0;this.beginPropertyChanges();for(j=0;j<f;j++){i=g[j];if(i&&i.get("length")>0){this.remove(i.source,i)}}if(l){this.removeObjects(l)}this.endPropertyChanges();return this}}i=this._hub_indexSetForSource(a,true);c=this.get("length");e=c-i.get("length");if(i&&(l=this._hub_objects)){if(d!==undefined){b=hub.IndexSet.create(b,d);d=undefined}l.forEach(function(m){j=a.indexOf(m);if(b.contains(j)){l.remove(m);e--}},this)}i.remove(b,d);h=i.get("length");e+=h;this._hub_indexSetCache=null;if(e!==c){this.propertyDidChange("length");this.enumerableContentDidChange();if(h===0){this.notifyPropertyChange("sources")}}return this},contains:function(b,d,a){if(d===undefined&&a===undefined){return this.containsObject(b)}var c=this.indexSetForSource(b);if(!c){return false}return c.contains(d,a)},intersects:function(b,d,a){var c=this.indexSetForSource(b,false);if(!c){return false}return c.intersects(d,a)},_hub_TMP_ARY:[],addObject:function(b){var c=this._hub_TMP_ARY,a;c[0]=b;a=this.addObjects(c);c.length=0;return a},addObjects:function(a){var d=this._hub_objects,b,c;if(!d){d=this._hub_objects=hub.CoreSet.create()}b=d.get("length");d.addEach(a);c=d.get("length");this._hub_indexSetCache=null;if(c!==b){this.propertyDidChange("length");this.enumerableContentDidChange()}return this},removeObject:function(b){var c=this._hub_TMP_ARY,a;c[0]=b;a=this.removeObjects(c);c.length=0;return a},removeObjects:function(b){var e=this._hub_objects,c,d,a;if(!e){return this}c=e.get("length");e.removeEach(b);d=e.get("length");if(a=this._hub_sets){a.forEach(function(f){c+=f.get("length");f.removeObjects(b);d+=f.get("length")},this)}this._hub_indexSetCache=null;if(d!==c){this.propertyDidChange("length");this.enumerableContentDidChange()}return this},containsObject:function(c){var e=this._hub_objects;if(e&&e.contains(c)){return true}var d=this._hub_sets,b=d?d.length:0,a,f;for(a=0;a<b;a++){f=d[a];if(f&&f.indexOf(c)>=0){return true}}return false},constrain:function(d){var e,b,a,c;this.beginPropertyChanges();this.get("sources").forEach(function(f){if(f===d){return}var g=this._hub_indexSetForSource(d,false);if(g){this.remove(d,g)}},this);e=this._hub_indexSetForSource(d,false);if(e&&((a=e.get("max"))>(b=d.get("length")))){this.remove(d,b,a-b)}if(c=this._hub_objects){c.forEach(function(f){if(d.indexOf(f)<0){this.removeObject(f)}},this)}this.endPropertyChanges();return this},isEqual:function(g){var f,d,b,a,c,e;if(!g||!g.isSelectionSet){return false}if(g===this){return true}if((this._hub_sets===g._hub_sets)&&(this._hub_objects===g._hub_objects)){return true}if(this.get("length")!==g.get("length")){return false}f=this._hub_objects;d=g._hub_objects;if(f||d){if((f?f.get("length"):0)!==(d?d.get("length"):0)){return false}if(f&&!f.isEqual(d)){return false}}c=this.get("sources");a=c.get("length");for(b=0;b<a;b++){e=c.objectAt(b);f=this._hub_indexSetForSource(e,false);d=this._hub_indexSetForSource(e,false);if(!!d!==!!f){return false}if(f&&!f.isEqual(d)){return false}}return true},clear:function(){if(this.isFrozen){throw hub.FROZEN_ERROR}if(this._hub_sets){this._hub_sets.length=0}if(this._hub_objects){this._hub_objects=null}this._hub_indexSetCache=null;this.propertyDidChange("length");this.enumerableContentDidChange();this.notifyPropertyChange("sources");return this},copy:function(){var c=this.constructor.create(),d=this._hub_sets,b=d?d.length:0,a,e;if(d&&b>0){d=c._hub_sets=d.slice();for(a=0;a<b;a++){if(!(e=d[a])){continue}e=d[a]=e.copy();c[hub.guidFor(e.source)]=a}}if(this._hub_objects){c._hub_objects=this._hub_objects.copy()}return c},freeze:function(){if(this.isFrozen){return this}var a=this._hub_sets,b=a?a.length:0,c;while(--b>=0){if(c=a[b]){c.freeze()}}if(this._hub_objects){this._hub_objects.freeze()}return arguments.callee.base.apply(this,arguments)},toString:function(){var a=this._hub_sets||[];a=a.map(function(b){return b.toString().replace("hub.IndexSet",hub.guidFor(b.source))},this);if(this._hub_objects){a.push(this._hub_objects.toString())}return"hub.SelectionSet:%@<%@>".fmt(hub.guidFor(this),a.join(","))},firstObject:function(){var b=this._hub_sets,c=this._hub_objects;if(b&&b.get("length")>0){var e=b?b[0]:null,d=e?e.source:null,a=e?e.firstObject():-1;if(d&&a>=0){return d.objectAt(a)}}return c?c.firstObject():undefined}.property(),nextObject:function(c,e,b){var d,a;if(c===0){d=b.objects=[];this.forEach(function(f){d.push(f)},this);b.max=d.length}d=b.objects;a=d[c];if(c+1>=b.max){b.objects=b.max=null}return a},forEach:function(g,e){var c=this._hub_sets,d=this._hub_objects,b=c?c.length:0,f,a;for(a=0;a<b;a++){f=c[a];if(f){f.forEachObject(g,e)}}if(d){d.forEach(g,e)}return this}});hub.SelectionSet.prototype.clone=hub.SelectionSet.prototype.copy;hub.SelectionSet.EMPTY=hub.SelectionSet.create().freeze();hub.SparseArray=hub.Object.extend(hub.Observable,hub.Enumerable,hub.Array,hub.DelegateSupport,{_hub_requestingLength:0,_hub_requestingIndex:0,length:function(){var a=this.delegate;if(a&&hub.none(this._hub_length)&&a.sparseArrayDidRequestLength){this._hub_requestingLength++;a.sparseArrayDidRequestLength(this);this._hub_requestingLength--}return this._hub_length||0}.property().cacheable(),provideLength:function(a){if(hub.none(a)){this._hub_sa_content=null}if(a!==this._hub_length){this._hub_length=a;if(this._hub_requestingLength<=0){this.enumerableContentDidChange()}}return this},rangeWindowSize:1,requestedRangeIndex:[],objectAt:function(a){var c=this._hub_sa_content,b;if(!c){c=this._hub_sa_content=[]}if((b=c[a])===undefined){this.requestIndex(a);b=c[a]}return b},definedIndexes:function(d){var c=hub.IndexSet.create(),e=this._hub_sa_content,b,a;if(!e){return c.freeze()}if(d){d.forEach(function(f){if(e[f]!==undefined){c.add(f)}})}else{a=e.length;for(b=0;b<a;b++){if(e[b]!==undefined){c.add(b)}}}return c.freeze()},_hub_TMP_RANGE:{},requestIndex:function(b){var c=this.delegate;if(!c){return this}var a=this.get("rangeWindowSize"),e=b;if(a>1){e=e-Math.floor(e%a)}if(a<1){a=1}this._hub_requestingIndex++;if(c.sparseArrayDidRequestRange){var d=this._hub_TMP_RANGE;if(this.wasRangeRequested(e)===-1){d.start=e;d.length=a;c.sparseArrayDidRequestRange(this,d);this.requestedRangeIndex.push(e)}}else{if(c.sparseArrayDidRequestIndex){while(--a>=0){c.sparseArrayDidRequestIndex(this,e+a)}}}this._hub_requestingIndex--;return this},wasRangeRequested:function(c){var b,a;for(b=0,a=this.requestedRangeIndex.length;b<a;b++){if(this.requestedRangeIndex[b]===c){return b}}return -1},rangeRequestCompleted:function(b){var a=this.wasRangeRequested(b);if(a>=0){this.requestedRangeIndex.removeAt(a,1);return true}return false},provideObjectsInRange:function(b,e){var c=this._hub_sa_content;if(!c){c=this._hub_sa_content=[]}var d=b.start,a=b.length;while(--a>=0){c[d+a]=e[a]}if(this._hub_requestingIndex<=0){this.enumerableContentDidChange()}return this},_hub_TMP_PROVIDE_ARRAY:[],_hub_TMP_PROVIDE_RANGE:{length:1},provideObjectAtIndex:function(c,b){var d=this._hub_TMP_PROVIDE_ARRAY,a=this._hub_TMP_PROVIDE_RANGE;d[0]=b;a.start=c;return this.provideObjectsInRange(a,d)},objectsDidChangeInRange:function(a){var b=this._hub_sa_content;if(b){if(a.start===0&&hub.maxRange(a)>=b.length){this._hub_sa_content=null}else{var d=a.start,c=Math.min(d+a.length,b.length);while(--c>=d){b[c]=undefined}}}this.enumerableContentDidChange(a);return this},indexOf:function(c){var a=this.delegate;if(a&&a.sparseArrayDidRequestIndexOf){return a.sparseArrayDidRequestIndexOf(this,c)}else{var b=this._hub_sa_content;if(!b){b=this._hub_sa_content=[]}return b.indexOf(c)}},replace:function(b,g,e){e=e||[];var c=this.delegate;if(c){if(!c.sparseArrayShouldReplace||!c.sparseArrayShouldReplace(this,b,g,e)){return this}}var d=this._hub_sa_content;if(!d){d=this._hub_sa_content=[]}d.replace(b,g,e);var a=e?(e.get?e.get("length"):e.length):0;var f=a-g;if(!hub.none(this._hub_length)){this.propertyWillChange("length");this._hub_length+=f;this.propertyDidChange("length")}this.enumerableContentDidChange(b,g,f);return this},reset:function(){this._hub_sa_content=null;this._hub_length=null;this.enumerableContentDidChange();this.invokeDelegateMethod(this.delegate,"sparseArrayDidReset",this);return this}});hub.SparseArray.array=function(a){return this.create({_hub_length:a||0})};hub.DataSource=hub.Object.extend({fetch:function(a,b){return false},retrieveRecords:function(a,c,b){return this._hub_handleEach(a,c,this.retrieveRecord,b)},commitRecords:function(c,b,g,f,h){var d,e,a;if(b.length>0){d=this.createRecords.call(this,c,b,h)}if(g.length>0){e=this.updateRecords.call(this,c,g,h)}if(f.length>0){a=this.destroyRecords.call(this,c,f,h)}return((d===e)&&(d===a))?d:hub.MIXED_STATE},cancel:function(a,b){return false},updateRecords:function(a,b,c){return this._hub_handleEach(a,b,this.updateRecord,null,c)},createRecords:function(a,b,c){return this._hub_handleEach(a,b,this.createRecord,null,c)},destroyRecords:function(a,b,c){return this._hub_handleEach(a,b,this.destroyRecord,null,c)},_hub_handleEach:function(g,d,c,a,b){var e=d.length,h,f,i,j;if(!a){a=[]}for(h=0;h<e;h++){j=a[h]?a[h]:b;i=c.call(this,g,d[h],j,b);if(f===undefined){f=i}else{if(f===true){f=(i===true)?true:hub.MIXED_STATE}else{if(f===false){f=(i===false)?false:hub.MIXED_STATE}}}}return f?f:null},updateRecord:function(a,b,c){return false},retrieveRecord:function(a,b,c){return false},createRecord:function(a,b,c){return false},destroyRecord:function(a,b,c){return false}});hub.CascadeDataSource=hub.DataSource.extend({dataSources:null,from:function(a){var b=this.get("dataSources");if(!b){this.set("dataSources",b=[])}b.push(a);return this},fetch:function(c,g){var e=this.get("dataSources"),b=e?e.length:0,d=false,h,f,a;for(a=0;(d!==true)&&a<b;a++){f=e.objectAt(a);h=f.fetch?f.fetch.call(f,c,g):false;d=this._hub_handleResponse(d,h)}return d},retrieveRecords:function(c,f){var e=this.get("dataSources"),b=e?e.length:0,d=false,h,g,a;for(a=0;(d!==true)&&a<b;a++){g=e.objectAt(a);h=g.retrieveRecords.call(g,c,f);d=this._hub_handleResponse(d,h)}return d},commitRecords:function(i,c,g,d){var b=this.get("dataSources"),e=b?b.length:0,f=false,j,a,h;for(h=0;(f!==true)&&h<e;h++){a=b.objectAt(h);j=a.commitRecords.call(a,i,c,g,d);f=this._hub_handleResponse(f,j)}return f},cancel:function(c,f){var e=this.get("dataSources"),b=e?e.length:0,d=false,h,g,a;for(a=0;(d!==true)&&a<b;a++){g=e.objectAt(a);h=g.cancel.call(g,c,f);d=this._hub_handleResponse(d,h)}return d},init:function(){arguments.callee.base.apply(this,arguments);var b=this.get("dataSources"),a=b?b.get("length"):0,c;while(--a>=0){c=b[a];if(hub.typeOf(c)===hub.T_STRING){b[a]=this.get(c)}}},_hub_handleResponse:function(b,a){if(a===true){return true}else{if(b===false){return(a===false)?false:hub.MIXED_STATE}else{return hub.MIXED_STATE}}}});hub.Record=hub.Object.extend({isRecord:true,primaryKey:"guid",id:function(a,b){if(b!==undefined){this.writeAttribute(this.get("primaryKey"),b);return b}else{return hub.Store.idFor(this.storeKey)}}.property("storeKey").cacheable(),status:function(){var a=this.get("store");if(!a){return hub.Record.EMPTY}return a.readStatus(this.storeKey)}.property("storeKey").cacheable(),store:null,storeKey:null,isDestroyed:function(){return !!(this.get("status")&hub.Record.DESTROYED)}.property("status").cacheable(),isEditable:function(a,b){if(b!==undefined){this._hub_screc_isEditable=b}if(this.get("status")&hub.Record.READY){return this._hub_screc_isEditable}else{return false}}.property("status").cacheable(),_hub_screc_isEditable:true,isLoaded:function(){var b=hub.Record,a=this.get("status");return !((a===b.EMPTY)||(a===b.BUSY_LOADING)||(a===b.ERROR))}.property("status").cacheable(),relationships:null,attributes:function(){var a=this.get("store");return(a)?a.readEditableDataHash(this.storeKey):{}}.property(),refresh:function(){this.get("store").refreshRecord(null,null,this.get("storeKey"));return this},destroy:function(){this.get("store").destroyRecord(null,null,this.get("storeKey"));this.propertyDidChange("status");return this},recordDidChange:function(a){this.get("store").recordDidChange(null,null,this.get("storeKey"),a);this.notifyPropertyChange("status");return this},_hub_editLevel:0,beginEditing:function(){this._hub_editLevel++;return this},endEditing:function(a){if(--this._hub_editLevel<=0){this._hub_editLevel=0;this.recordDidChange(a)}return this},readAttribute:function(c){var a=this.get("store"),d=this.storeKey;var b=a.readDataHash(d);return b?b[c]:undefined},writeAttribute:function(g,d,i){var e=this.get("store"),h=this.storeKey,c=e.peekStatus(h),a=this[g],b=hub.Store.recordTypeFor(h),f;f=e.readEditableDataHash(h);if(!f){throw hub.Record.BAD_STATE_ERROR}if(d!==f[g]){if(!i){this.beginEditing()}f[g]=d;if(!i){this.endEditing(g)}}if(g===this.get("primaryKey")){hub.Store.idsByStoreKey[h]=f[g];this.propertyDidChange("id")}if(!b.aggregates||b.aggregates.length>0){this.propagateToAggregates()}return this},propagateToAggregates:function(){var i=this.get("storeKey"),b=hub.Store.recordTypeFor(i),g,e,h,a,f;var d=b.aggregates;if(!d){var c=this.get("store").readDataHash(i),d=[];for(k in c){if(this[k]&&this[k].get&&this[k].get("aggregate")===true){d.push(k)}}b.aggregates=d}for(g=0,e=d.length;g<e;g++){h=d[g];a=this.get(h);f=hub.kindOf(a,hub.ManyArray)?a:[a];f.forEach(function(j){if(j){j.get("store").writeStatus(j.get("storeKey"),this.get("status"));j.storeDidChangeProperties(true)}},this)}},storeDidChangeProperties:function(a,b){if(a){this.notifyPropertyChange("status")}else{if(b){this.beginPropertyChanges();b.forEach(function(e){this.notifyPropertyChange(e)},this);this.notifyPropertyChange("status");this.endPropertyChanges()}else{this.allPropertiesDidChange()}var d=this.relationships,c=d?d.length:0;while(--c>=0){d[c].recordPropertyDidChange(b)}}},normalize:function(c){var g=this.primaryKey,e={},b=this.get("id"),h=this.get("store"),j=this.get("storeKey"),l,d,a,f;e[g]=b;for(var i in this){if(this[i]&&this[i]["typeClass"]){a=hub.typeOf(this[i].typeClass())==="class";if(!a){d=this.get(i);if(d!==undefined||(d===null&&c)){e[i]=d}}else{if(a){l=h.readDataHash(j);if(l[i]!==undefined){e[i]=l[i]}else{f=this[i].get("defaultValue");if(hub.typeOf(f)===hub.T_FUNCTION){e[i]=f()}else{e[i]=f}}}}}}h.writeDataHash(j,e);return h.materializeRecord(j)},unknownProperty:function(b,d){if(d!==undefined){var c=this.get("storeKey"),e=hub.Store.recordTypeFor(c);if(e.ignoreUnknownProperties===true){this[b]=d;return d}var a=this.get("primaryKey");this.writeAttribute(b,d);if(b===a){hub.Store.replaceIdFor(c,d)}}return this.readAttribute(b)},commitRecord:function(b){var a=this.get("store");a.commitRecord(undefined,undefined,this.get("storeKey"),b);return this},isError:function(){return this.get("status")&hub.Record.ERROR}.property("status").cacheable(),errorValue:function(){return this.get("isError")?hub.val(this.get("errorObject")):null}.property("isError").cacheable(),errorObject:function(){if(this.get("isError")){var a=this.get("store");return a.readError(this.get("storeKey"))||hub.Record.GENERIC_ERROR}else{return null}}.property("isError").cacheable(),toString:function(){var a=this.get("attributes");return"%@(%@) %@".fmt(this.constructor.toString(),hub.inspect(a),this.statusString())},statusString:function(){var b=[],a=this.get("status");for(var c in hub.Record){if(c.match(/[A-Z_]$/)&&hub.Record[c]===a){b.push(c)}}return b.join(" ")}});hub.Record.mixin({ignoreUnknownProperties:false,CLEAN:1,DIRTY:2,EMPTY:256,ERROR:4096,READY:512,READY_CLEAN:513,READY_DIRTY:514,READY_NEW:515,DESTROYED:1024,DESTROYED_CLEAN:1025,DESTROYED_DIRTY:1026,BUSY:2048,BUSY_LOADING:2052,BUSY_CREATING:2056,BUSY_COMMITTING:2064,BUSY_REFRESH:2080,BUSY_REFRESH_CLEAN:2081,BUSY_REFRESH_DIRTY:2082,BUSY_DESTROYING:2112,BAD_STATE_ERROR:hub.$error("Internal Inconsistency"),RECORD_EXISTS_ERROR:hub.$error("Record Exists"),NOT_FOUND_ERROR:hub.$error("Not found "),BUSY_ERROR:hub.$error("Busy"),GENERIC_ERROR:hub.$error("Generic Error"),attr:function(a,b){return hub.RecordAttribute.attr(a,b)},fetch:function(b,a){return hub.FetchedAttribute.attr(b,a)},toMany:function(b,a){return hub.ManyAttribute.attr(b,a)},toOne:function(b,a){return hub.SingleAttribute.attr(b,a)},storeKeysById:function(){var b=hub.keyFor("storeKey",hub.guidFor(this)),a=this[b];if(!a){a=this._hub_storeKeysById=this[b]={}}return a},storeKeyFor:function(c){var a=this._hub_storeKeysById;if(!a){a=this.storeKeysById()}var b=a[c];if(!b){b=hub.Store.generateStoreKey();hub.Store.idsByStoreKey[b]=c;hub.Store.recordTypesByStoreKey[b]=this;a[c]=b}return b},storeKeyExists:function(b){var a=this._hub_storeKeysById;if(!a){a=this.storeKeysById()}return a[b]},find:function(a,b){return a.find(this,b)},extend:function(){var a=hub.Object.extend.apply(this,arguments);hub.Query._hub_scq_didDefineRecordType(a);return a}});hub.FixturesDataSource=hub.DataSource.extend({simulateRemoteResponse:false,latency:50,cancel:function(a,b){return false},fetch:function(a,b){if(b.get("location")!==hub.Query.LOCAL){throw hub.$error("hub.Fixture data source can only fetch local queries")}if(!b.get("recordType")&&!b.get("recordTypes")){throw hub.$error("hub.Fixture data source can only fetch queries with one or more record types")}if(this.get("simulateRemoteResponse")){this.invokeLater(this._hub_fetch,this.get("latency"),a,b)}else{this._hub_fetch(a,b)}},_hub_fetch:function(a,c){var d=c.get("recordType"),b=c.get("recordTypes")||[d];b.forEach(function(e){if(hub.typeOf(e)===hub.T_STRING){e=hub.objectForPropertyPath(e)}if(e){this.loadFixturesFor(a,e)}},this);a.dataSourceDidFetchQuery(c)},retrieveRecords:function(a,c){var d=this.get("latency"),b=this.hasFixturesFor(c);if(!b){return b}if(this.get("simulateRemoteResponse")){this.invokeLater(this._hub_retrieveRecords,d,a,c)}else{this._hub_retrieveRecords(a,c)}return b},_hub_retrieveRecords:function(a,b){b.forEach(function(d){var c=[],g=hub.Store.recordTypeFor(d),f=a.idFor(d),e=this.fixtureForStoreKey(a,d);c.push(d);a.dataSourceDidComplete(d,e,f)},this)},updateRecords:function(a,c,e){var d=this.get("latency"),b=this.hasFixturesFor(c);if(!b){return b}if(this.get("simulateRemoteResponse")){this.invokeLater(this._hub_updateRecords,d,a,c)}else{this._hub_updateRecords(a,c)}return b},_hub_updateRecords:function(a,b){b.forEach(function(c){var d=a.readDataHash(c);this.setFixtureForStoreKey(a,c,d);a.dataSourceDidComplete(c)},this)},createRecords:function(a,b,d){var c=this.get("latency");if(this.get("simulateRemoteResponse")){this.invokeLater(this._hub_createRecords,c,a,b)}else{this._hub_createRecords(a,b)}return true},_hub_createRecords:function(a,b){b.forEach(function(e){var g=a.idFor(e),f=a.recordTypeFor(e),d=a.readDataHash(e),c=this.fixturesFor(f);if(!g){g=this.generateIdFor(f,d,a,e)}this._hub_invalidateCachesFor(f,e,g);c[g]=d;a.dataSourceDidComplete(e,null,g)},this)},destroyRecords:function(a,c,e){var d=this.get("latency"),b=this.hasFixturesFor(c);if(!b){return b}if(this.get("simulateRemoteResponse")){this.invokeLater(this._hub_destroyRecords,d,a,c)}else{this._hub_destroyRecords(a,c)}return b},_hub_destroyRecords:function(a,b){b.forEach(function(d){var f=a.idFor(d),e=a.recordTypeFor(d),c=this.fixturesFor(e);this._hub_invalidateCachesFor(e,d,f);if(f){delete c[f]}a.dataSourceDidDestroy(d)},this)},loadFixturesFor:function(a,g,c){var b=[],e,d,f;e=this.fixturesFor(g);for(d in e){f=g.storeKeyFor(d);if(a.peekStatus(f)===hub.Record.EMPTY){b.push(e[d])}if(c){c.push(f)}}if(b&&b.length>0){a.loadRecords(g,b)}return this},generateIdFor:function(d,b,a,c){return"@id%@".fmt(hub.Store.generateStoreKey())},fixtureForStoreKey:function(a,c){var e=a.idFor(c),d=a.recordTypeFor(c),b=this.fixturesFor(d);return b?b[e]:null},setFixtureForStoreKey:function(a,d,c){var f=a.idFor(d),e=a.recordTypeFor(d),b=this.fixturesFor(e);this._hub_invalidateCachesFor(e,d,f);b[f]=c;return this},fixturesFor:function(h){if(!this._hub_fixtures){this._hub_fixtures={}}var f=this._hub_fixtures[hub.guidFor(h)];if(f){return f}var e=h?h.FIXTURES:null,b=e?e.length:0,c=h?h.prototype.primaryKey:"guid",a,d,g;this._hub_fixtures[hub.guidFor(h)]=f={};for(a=0;a<b;a++){d=e[a];g=d[c];if(!g){g=this.generateIdFor(h,d)}f[g]=d}return f},fixturesLoadedFor:function(c){if(!this._hub_fixtures){return false}var a=[],b=this._hub_fixtures[hub.guidFor(c)];return b?true:false},hasFixturesFor:function(b){var a=false;b.forEach(function(d){if(a!==hub.MIXED_STATE){var e=hub.Store.recordTypeFor(d),c=e?e.FIXTURES:null;if(c&&c.length&&c.length>0){if(a===false){a=true}}else{if(a===true){a=hub.MIXED_STATE}}}},this);return a},_hub_invalidateCachesFor:function(d,b,c){var a=this._hub_storeKeyCache;if(a){delete a[hub.guidFor(d)]}return this}});hub.Record.fixtures=hub.FixturesDataSource.create();hub.RecordAttribute=hub.Object.extend({defaultValue:null,type:String,key:null,isRequired:false,isEditable:true,useIsoDate:true,aggregate:false,typeClass:function(){var a=this.get("type");if(hub.typeOf(a)===hub.T_STRING){a=hub.objectForPropertyPath(a)}return a}.property("type").cacheable(),transform:function(){var a=this.get("typeClass")||String,c=hub.RecordAttribute.transforms,b;while(a&&!(b=c[hub.guidFor(a)])){if(a.superclass.hasOwnProperty("create")){a=a.superclass}else{a=hub.T_FUNCTION}}return b}.property("typeClass").cacheable(),toType:function(a,c,e){var b=this.get("transform"),d=this.get("typeClass");if(b&&b.to){e=b.to(e,this,d,a,c)}return e},fromType:function(a,c,e){var b=this.get("transform"),d=this.get("typeClass");if(b&&b.from){e=b.from(e,this,d,a,c)}return e},call:function(a,b,c){var d=this.get("key")||b,e;if(c!==undefined){e=this.fromType(a,b,c);a.writeAttribute(d,e)}else{c=a.readAttribute(d);if(hub.none(c)&&(c=this.get("defaultValue"))){if(typeof c===hub.T_FUNCTION){c=this.defaultValue(a,b,this);if(a.attributes()){a.writeAttribute(d,c,true)}}}else{c=this.toType(a,b,c)}}return c},isProperty:true,isCacheable:true,dependentKeys:[],init:function(){arguments.callee.base.apply(this,arguments);this.cacheKey="__hub_cache__"+hub.guidFor(this);this.lastSetValueKey="__hub_lastValue__"+hub.guidFor(this)}});hub.RecordAttribute.attr=function(a,b){if(!b){b={}}if(!b.type){b.type=a||String}return this.create(b)};hub.RecordAttribute.transforms={};hub.RecordAttribute.registerTransform=function(a,b){hub.RecordAttribute.transforms[hub.guidFor(a)]=b};hub.RecordAttribute.registerTransform(Boolean,{to:function(a){return hub.none(a)?null:!!a}});hub.RecordAttribute.registerTransform(Number,{to:function(a){return hub.none(a)?null:Number(a)}});hub.RecordAttribute.registerTransform(String,{to:function(a){if(!(typeof a===hub.T_STRING)&&!hub.none(a)&&a.toString){a=a.toString()}return a}});hub.RecordAttribute.registerTransform(Array,{to:function(a){if(!hub.isArray(a)&&!hub.none(a)){a=[]}return a}});hub.RecordAttribute.registerTransform(Object,{to:function(a){if(!(typeof a==="object")&&!hub.none(a)){a={}}return a}});hub.RecordAttribute.registerTransform(hub.Record,{to:function(e,a,d,c){var b=c.get("store");if(hub.none(e)||(e==="")){return null}else{return b.find(d,e)}},from:function(a){return a?a.get("id"):null}});hub.RecordAttribute.registerTransform(hub.T_FUNCTION,{to:function(e,a,d,c){d=d.apply(c);var b=c.get("store");return b.find(d,e)},from:function(a){return a.get("id")}});hub.RecordAttribute.registerTransform(Date,{to:function(i,a){var c;if(a.get("useIsoDate")){var e="([0-9]{4})(-([0-9]{2})(-([0-9]{2})(T([0-9]{2}):([0-9]{2})(:([0-9]{2})(\\.([0-9]+))?)?(Z|(([-+])([0-9]{2}):([0-9]{2})))?)?)?)?",h=i.toString().match(new RegExp(e)),g=0,b=new Date(h[1],0,1),f;if(h[3]){b.setMonth(h[3]-1)}if(h[5]){b.setDate(h[5])}if(h[7]){b.setHours(h[7])}if(h[8]){b.setMinutes(h[8])}if(h[10]){b.setSeconds(h[10])}if(h[12]){b.setMilliseconds(Number("0."+h[12])*1000)}if(h[14]){g=(Number(h[16])*60)+Number(h[17]);g*=((h[15]=="-")?1:-1)}g-=b.getTimezoneOffset();f=(Number(b)+(g*60*1000));c=new Date();c.setTime(Number(f))}else{c=new Date(Date.parse(i))}return c},_hub_dates:{},_hub_zeropad:function(a){return((a<0)?"-":"")+((a<10)?"0":"")+Math.abs(a)},from:function(b){var a=this._hub_dates[b.getTime()];if(a){return a}var d=this._hub_zeropad,c=0-b.getTimezoneOffset()/60;c=(c===0)?"Z":"%@:00".fmt(d(c));this._hub_dates[b.getTime()]=a="%@-%@-%@T%@:%@:%@%@".fmt(d(b.getFullYear()),d(b.getMonth()+1),d(b.getDate()),d(b.getHours()),d(b.getMinutes()),d(b.getSeconds()),c);return a}});if(hub.DateTime&&!hub.RecordAttribute.transforms[hub.guidFor(hub.DateTime)]){hub.RecordAttribute.registerTransform(hub.DateTime,{to:function(c,a){if(hub.none(c)||hub.instanceOf(c,hub.DateTime)){return c}var b=a.get("format");return hub.DateTime.parse(c,b?b:hub.DateTime.recordFormat)},from:function(b,a){if(hub.none(b)){return b}var c=a.get("format");return b.toFormattedString(c?c:hub.DateTime.recordFormat)}})}hub.FetchedAttribute=hub.RecordAttribute.extend({paramValueKey:"link",paramOwnerKey:"owner",paramRelKey:"rel",queryKey:null,isEditable:false,toType:function(d,i,g){var h=d.get("store");if(!h){return null}var b=this.get("paramValueKey"),a=this.get("paramOwnerKey"),f=this.get("paramRelKey"),e=this.get("queryKey")||this.get("typeClass"),c={};if(b){c[b]=g}if(a){c[a]=d}if(f){c[f]=this.get("key")||i}return h.findAll(e,c)},fromType:function(a,b,c){return c}});hub.ManyAttribute=hub.RecordAttribute.extend({inverse:null,isMaster:true,orderBy:null,toType:function(b,d,f){var e=this.get("typeClass"),h=this.get("key")||d,g=hub.keyFor("__manyArray__",hub.guidFor(this)),c=b[g],a;if(!c){c=hub.ManyArray.create({recordType:e,record:b,propertyName:h,manyAttribute:this});b[g]=c;a=b.get("relationships");if(!a){b.set("relationships",a=[])}a.push(c)}return c},fromType:function(b,e,f){var c=[];if(!hub.isArray(f)){throw"Expects toMany attribute to be an array"}var a=f.get("length");for(var d=0;d<a;d++){c[d]=f.objectAt(d).get("id")}return c},inverseDidRemoveRecord:function(a,b,c,d){var e=a.get(b);if(e){e.removeInverseRecord(c)}},inverseDidAddRecord:function(a,b,c,d){var e=a.get(b);if(e){e.addInverseRecord(c)}}});hub.SingleAttribute=hub.RecordAttribute.extend({inverse:null,isMaster:true,call:function(c,i,b){var a=this.get("key")||i,h,g,j,f,e,d;if(b!==undefined){if(b&&!hub.kindOf(b,hub.Record)){throw"%@ is not an instance of hub.Record".fmt(b)}h=this.get("inverse");if(h){j=this._hub_scsa_call(c,i)}d=this.fromType(c,i,b);c.writeAttribute(a,d,!this.get("isMaster"));e=b;if(h&&(j!==b)){if(j&&(f=j[h])){f.inverseDidRemoveRecord(j,h,c,i)}if(b&&(f=b[h])){f.inverseDidAddRecord(b,h,c,i)}}}else{e=this._hub_scsa_call(c,i,b)}return e},_hub_scsa_call:hub.RecordAttribute.prototype.call,inverseDidRemoveRecord:function(c,f,g,h){var b=this.get("inverse"),e=this._hub_scsa_call(c,f),d=this.get("isMaster"),a;c.writeAttribute(f,null,!d);c.notifyPropertyChange(f);if((e!==g)||(h!==b)){if(e&&(a=e[b])){a.inverseDidRemoveRecord(e,b,c,f)}}},inverseDidAddRecord:function(a,h,c,g){var e=this.get("inverse"),i=this._hub_scsa_call(a,h),f=this.get("isMaster"),d,b;b=this.fromType(a,h,c);a.writeAttribute(h,b,!f);a.notifyPropertyChange(h);if((i!==c)||(g!==e)){if(i&&(d=i[e])){d.inverseDidRemoveRecord(i,e,a,h)}}}});hub.ManyArray=hub.Object.extend(hub.Enumerable,hub.Array,{recordType:null,record:null,propertyName:null,manyAttribute:null,store:function(){return this.get("record").get("store")}.property("record").cacheable(),storeKey:function(){return this.get("record").get("storeKey")}.property("record").cacheable(),readOnlyStoreIds:function(){return this.get("record").readAttribute(this.get("propertyName"))}.property(),editableStoreIds:function(){var a=this.get("store"),d=this.get("storeKey"),c=this.get("propertyName"),b,e;b=a.readEditableProperty(d,c);if(!b){e=a.readEditableDataHash(d);b=e[c]=[]}if(b!==this._hub_prevStoreIds){this.recordPropertyDidChange()}return b}.property(),isEditable:function(){var a=this.manyAttribute;return a?a.get("isEditable"):false}.property("manyAttribute").cacheable(),inverse:function(){var a=this.manyAttribute;return a?a.get("inverse"):null}.property("manyAttribute").cacheable(),isMaster:function(){var a=this.manyAttribute;return a?a.get("isMaster"):null}.property("manyAttribute").cacheable(),orderBy:function(){var a=this.manyAttribute;return a?a.get("orderBy"):null}.property("manyAttribute").cacheable(),length:function(){var a=this.get("readOnlyStoreIds");return a?a.get("length"):0}.property("readOnlyStoreIds").cacheable(),objectAt:function(a){var g=this._hub_records,f=this.get("readOnlyStoreIds"),c=this.get("store"),h=this.get("recordType"),e,d,b;if(!f||!c){return undefined}if(g&&(d=g[a])){return d}if(!g){this._hub_records=g=[]}b=f.objectAt(a);if(b){e=c.storeKeyFor(h,b);if(c.readStatus(e)===hub.Record.EMPTY){c.retrieveRecord(h,null,e)}g[a]=d=c.materializeRecord(e)}return d},replace:function(o,d,n){if(!this.get("isEditable")){throw"%@.%@[] is not editable".fmt(this.get("record"),this.get("propertyName"))}var c=this.get("editableStoreIds"),l=n?(n.get?n.get("length"):n.length):0,h=this.get("record"),e=this.get("propertyName"),g,p,a,b,f,m,j;a=[];for(g=0;g<l;g++){a[g]=n.objectAt(g).get("id")}f=this.get("inverse");if(f&&d>0){b=hub.ManyArray._hub_toRemove;if(b){hub.ManyArray._hub_toRemove=null}else{b=[]}for(g=0;g<d;g++){b[g]=this.objectAt(g)}}c.replace(o,d,a);if(f){for(g=0;g<d;g++){j=b[g];m=j?j[f]:null;if(m&&m.inverseDidRemoveRecord){m.inverseDidRemoveRecord(j,f,h,e)}}if(b){b.length=0;if(!hub.ManyArray._hub_toRemove){hub.ManyArray._hub_toRemove=b}}for(g=0;g<l;g++){j=n.objectAt(g);m=j?j[f]:null;if(m&&m.inverseDidAddRecord){m.inverseDidAddRecord(j,f,h,e)}}}if(h&&(!f||this.get("isMaster"))){h.recordDidChange(e)}return this},removeInverseRecord:function(c){if(!c){return this}var e=c.get("id"),d=this.get("editableStoreIds"),a=(d&&e)?d.indexOf(e):-1,b;if(a>=0){d.removeAt(a);if(this.get("isMaster")&&(b=this.get("record"))){b.recordDidChange(this.get("propertyName"))}}},addInverseRecord:function(d){if(!d){return this}var g=d.get("id"),e=this.get("editableStoreIds"),f=this.get("orderBy"),b=e.get("length"),a,c;if(f){a=this._hub_findInsertionLocation(d,0,b,f)}else{a=b}e.insertAt(a,d.get("id"));if(this.get("isMaster")&&(c=this.get("record"))){c.recordDidChange(this.get("propertyName"))}},_hub_findInsertionLocation:function(g,d,c,f){var b=d+Math.floor((c-d)/2),e=this.objectAt(b),a=this._hub_compare(g,e,f);if(a<0){if(b===0){return b}else{return this._hub_findInsertionLocation(g,0,b,f)}}else{if(a>0){if(b>=c){return b}else{return this._hub_findInsertionLocation(g,b,c,f)}}else{return b}}},_hub_compare:function(f,e,i){var h=hub.typeOf(i),g,d,c;if(h===hub.T_FUNCTION){g=i(f,e)}else{if(h===hub.T_STRING){g=hub.compare(f,e)}else{c=i.get("length");g=0;for(d=0;(g===0)&&(d<c);d++){g=hub.compare(f,e)}}}return g},recordPropertyDidChange:function(c){if(c&&!c.contains(this.get("propertyName"))){return this}var e=this.get("readOnlyStoreIds");var b=this._hub_prevStoreIds,d=this._hub_storeIdsContentDidChange;if(e===b){return this}if(b){b.removeObserver("[]",this,d)}this._hub_prevStoreIds=e;if(e){e.addObserver("[]",this,d)}var a=(e)?e.propertyRevision:-1;this._hub_storeIdsContentDidChange(e,"[]",e,a)},_hub_storeIdsContentDidChange:function(d,b,c,a){this._hub_records=null;this.enumerableContentDidChange()},unknownProperty:function(b,c){var a=this.reducedProperty(b,c);return a===undefined?arguments.callee.base.apply(this,arguments):a},init:function(){arguments.callee.base.apply(this,arguments);this.recordPropertyDidChange()}});hub.Store=hub.Object.extend({name:null,nestedStores:null,dataSource:null,isNested:false,commitRecordsAutomatically:false,from:function(a){this.set("dataSource",a);return this},_hub_getDataSource:function(){var a=this.get("dataSource");if(typeof a===hub.T_STRING){a=hub.objectForPropertyPath(a);if(a){a=a.create()}if(a){this.set("dataSource",a)}}return a},cascade:function(a){var b=hub.A(arguments);a=hub.CascadeDataSource.create({dataSources:b});return this.from(a)},chain:function(b,c){if(!b){b={}}b.parentStore=this;if(c){if(hub.typeOf(c)!=="class"){throw new Error("%@ is not a valid class".fmt(c))}if(!hub.kindOf(c,hub.NestedStore)){throw new Error("%@ is not a type of hub.NestedStore".fmt(c))}}else{c=hub.NestedStore}var a=c.create(b),d=this.nestedStores;if(!d){d=this.nestedStores=[]}d.push(a);return a},willDestroyNestedStore:function(a){if(this.nestedStores){this.nestedStores.removeObject(a)}return this},hasNestedStore:function(a){while(a&&(a!==this)){a=a.get("parentStore")}return a===this},dataHashes:null,statuses:null,revisions:null,editables:null,changelog:null,recordArraysWithQuery:null,recordErrors:null,queryErrors:null,storeKeyEditState:function(b){hub_precondition(typeof b===hub.T_NUMBER);var c=this.editables,a=this.locks;return(c&&c[b])?hub.Store.EDITABLE:hub.Store.LOCKED},readDataHash:function(a){hub_precondition(typeof a===hub.T_NUMBER);return this.dataHashes[a]},readEditableDataHash:function(b){hub_precondition(typeof b===hub.T_NUMBER);var a=this.dataHashes[b];if(!a){return a}var c=this.editables;if(!c){c=this.editables=[]}if(!c[b]){c[b]=1;a=this.dataHashes[b]=hub.clone(a)}return a},readEditableProperty:function(c,a){hub_precondition(typeof c===hub.T_NUMBER);var e=this.readEditableDataHash(c),d=this.editables[c],b=e[a];if(d===1){d=this.editables[c]={}}if(!d[a]){b=e[a];if(b&&b.isCopyable){b=e[a]=b.copy()}d[a]=true}return b},writeDataHash:function(b,d,a){hub_precondition(typeof b===hub.T_NUMBER);if(d){this.dataHashes[b]=d}if(a){this.statuses[b]=a}var c=this.editables;if(!c){c=this.editables=[]}c[b]=1;return this},removeDataHash:function(c,b){hub_precondition(typeof c===hub.T_NUMBER);var a;this.dataHashes[c]=null;this.statuses[c]=b||hub.Record.EMPTY;a=this.revisions[c]=this.revisions[c];var d=this.editables;if(d){d[c]=0}return this},readStatus:function(a){hub_precondition(typeof a===hub.T_NUMBER);this.readDataHash(a);return this.statuses[a]||hub.Record.EMPTY},peekStatus:function(a){hub_precondition(typeof a===hub.T_NUMBER);return this.statuses[a]||hub.Record.EMPTY},writeStatus:function(b,a){hub_precondition(typeof b===hub.T_NUMBER);return this.writeDataHash(b,null,a)},dataHashDidChange:function(h,d,e,f){if(!d){d=hub.Store.generateStoreKey()}var c,b,a,g;c=hub.typeOf(h)===hub.T_ARRAY;if(c){b=h.length}else{b=1;g=h}for(a=0;a<b;a++){if(c){g=h[a]}hub_precondition(typeof g===hub.T_NUMBER);this.revisions[g]=d;this._hub_notifyRecordPropertyChange(g,e,f)}return this},_hub_notifyRecordPropertyChange:function(n,e,m){hub_precondition(typeof n===hub.T_NUMBER);var a=this.records,g=this.get("nestedStores"),h=hub.Store,c,b,f,l,j,d,o;f=g?g.length:0;for(l=0;l<f;l++){j=g[l];d=j.peekStatus(n);b=j.storeKeyEditState(n);if(b===h.INHERITED){j._hub_notifyRecordPropertyChange(n,e,m)}else{if(d&hub.Record.BUSY){if(j.get("hasChanges")){throw h.CHAIN_CONFLICT_ERROR}j.reset()}}}var i=this.recordPropertyChanges;if(!i){i=this.recordPropertyChanges={storeKeys:hub.CoreSet.create(),records:hub.CoreSet.create(),hasDataChanges:hub.CoreSet.create(),propertyForStoreKeys:{}}}i.storeKeys.add(n);if(a&&(c=a[n])){i.records.push(n);if(!e){i.hasDataChanges.push(n)}if(m){if(!(o=i.propertyForStoreKeys[n])){o=i.propertyForStoreKeys[n]=hub.CoreSet.create()}if(o!=="*"){o.add(m)}}else{i.propertyForStoreKeys[n]="*"}}this.invokeOnce(this.flush);return this},flush:function(){if(!this.recordPropertyChanges){return this}var i=this.recordPropertyChanges,h=i.storeKeys,m=i.hasDataChanges,a=i.records,f=i.propertyForStoreKeys,d=hub.CoreSet.create(),c,b,e,j,g,l,n;h.forEach(function(o){hub_precondition(typeof o===hub.T_NUMBER);if(a.contains(o)){e=m.contains(o)?false:true;c=this.records[o];n=f?f[o]:null;if(n==="*"){n=null}a.remove(o);if(c){c.storeDidChangeProperties(e,n)}}b=hub.Store.recordTypeFor(o);d.add(b)},this);this._hub_notifyRecordArrays(h,d);h.clear();m.clear();a.clear();this.recordPropertyChanges.propertyForStoreKeys={};return this},reset:function(){this.dataHashes={};this.revisions={};this.statuses={};this.chainedChanges=this.locks=this.editables=null;this.changelog=null;this.recordErrors=null;this.queryErrors=null;var a=this.records,b;if(a){for(b in a){hub_precondition(typeof b===hub.T_NUMBER);if(!a.hasOwnProperty(b)){continue}this._hub_notifyRecordPropertyChange(b,false)}}this.set("hasChanges",false)},commitChangesFromNestedStore:function(l,m,c){if(!c){this._hub_verifyLockRevisions(m,l.locks)}var g=m.length,e,p,f,a,o,b,d,n,j;b=this.revisions;f=this.dataHashes;a=this.statuses;o=this.editables;if(!o){o=this.editables=[]}d=l.dataHashes;j=l.revisions;n=l.statuses;for(e=0;e<g;e++){p=m[e];hub_precondition(typeof p===hub.T_NUMBER);f[p]=d[p];a[p]=n[p];b[p]=j[p];o[p]=0;this._hub_notifyRecordPropertyChange(p,false)}var q=this.changelog,h=l.changelog;if(h){if(!q){q=this.changelog=hub.CoreSet.create()}q.addEach(h)}this.changelog=q;if(!this.get("parentStore")){this.flush()}return this},_hub_verifyLockRevisions:function(f,h){var a=f.length,c=this.revisions,e,g,d,b;if(h&&c){for(e=0;e<a;e++){g=f[e];hub_precondition(typeof g===hub.T_NUMBER);d=h[g]||1;b=c[g]||1;if(d<b){throw hub.Store.CHAIN_CONFLICT_ERROR}}}return this},find:function(b,a){if(hub.typeOf(b)===hub.T_STRING){b=hub.objectForPropertyPath(b)}if((arguments.length===1)&&!(b&&b.get&&b.get("isRecord"))){if(!b){throw new Error("hub.Store#find() must pass recordType or query")}if(!b.isQuery){b=hub.Query.local(b)}return this._hub_findQuery(b,true,true)}else{return this._hub_findRecord(b,a)}},_hub_findQuery:function(f,a,e){var b=this._hub_scst_recordArraysByQuery,d=hub.guidFor(f),c,g;if(!b){b=this._hub_scst_recordArraysByQuery={}}c=b[d];if(!c&&a){b[d]=c=hub.RecordArray.create({store:this,query:f});g=this.get("recordArrays");if(!g){this.set("recordArrays",g=hub.Set.create())}g.add(c);if(e){this.refreshQuery(f)}}this.flush();return c},_hub_findRecord:function(c,b){var a;if(c&&c.get&&c.get("isRecord")){a=c.get("storeKey")}else{a=b?c.storeKeyFor(b):null}if(a&&(this.readStatus(a)===hub.Record.EMPTY)){a=this.retrieveRecord(c,b)}return a?this.materializeRecord(a):null},recordArrayWillDestroy:function(b){var a=this._hub_scst_recordArraysByQuery,c=this.get("recordArrays");if(a){delete a[hub.guidFor(b.get("query"))]}if(c){c.remove(b)}return this},refreshQuery:function(d){if(!d){throw new Error("refreshQuery() requires a query")}var a=this._hub_scst_recordArraysByQuery,c=a?a[hub.guidFor(d)]:null,b=this._hub_getDataSource();if(b&&b.fetch){if(c){c.storeWillFetchQuery(d)}b.fetch.call(b,this,d)}return this},_hub_notifyRecordArrays:function(b,a){var c=this.get("recordArrays");if(!c){return this}c.forEach(function(d){if(d){d.storeDidChangeStoreKeys(b,a)}},this);return this},recordsFor:function(g){var e=[],f,d,c,a=g._hub_storeKeysById;if(!a){a=this.storeKeysById()}var b=hub.Record.EMPTY;for(f in a){d=a[f];hub_precondition(typeof d===hub.T_NUMBER);if(this.readStatus(d)!==b){e.push(d)}}if(e.length>0){c=hub.RecordArray.create({store:this,storeKeys:e})}else{c=e}return c},_hub_TMP_REC_ATTRS:{},materializeRecord:function(d){hub_precondition(typeof d===hub.T_NUMBER);var a=this.records,c,e,b;if(!a){a=this.records={}}c=a[d];if(c){return c}e=hub.Store.recordTypeFor(d);if(!e){return null}b=this._hub_TMP_REC_ATTRS;b.storeKey=d;b.store=this;c=a[d]=e.create(b);return c},createRecord:function(b,d,a){var h,i,c,g=hub.Record,e,f;if(!a&&(h=b.prototype.primaryKey)){a=d[h];f=b.prototype[h]?b.prototype[h].defaultValue:null;if(!a&&hub.typeOf(f)===hub.T_FUNCTION){a=d[h]=f()}}i=a?b.storeKeyFor(a):hub.Store.generateStoreKey();hub_precondition(typeof i===hub.T_NUMBER);c=this.readStatus(i);if((c&g.BUSY)||(c&g.READY)||(c==g.DESTROYED_DIRTY)){throw a?g.RECORD_EXISTS_ERROR:g.BAD_STATE_ERROR}else{if(!a&&(c==hub.DESTROYED_CLEAN||c==hub.ERROR)){throw g.BAD_STATE_ERROR}}this.writeDataHash(i,(d?d:{}),g.READY_NEW);hub.Store.replaceRecordTypeFor(i,b);this.dataHashDidChange(i);e=this.changelog;if(!e){e=hub.Set.create()}e.add(i);this.changelog=e;if(this.get("commitRecordsAutomatically")){this.invokeLast(this.commitRecords)}return this.materializeRecord(i)},createRecords:function(d,i,a){var g=[],c,b,e,f=i.length,h;e=hub.typeOf(d)===hub.T_ARRAY;if(!e){c=d}for(h=0;h<f;h++){if(e){c=d[h]||hub.Record}b=a?a[h]:undefined;g.push(this.createRecord(c,i[h],b))}return g},destroyRecord:function(f,e,d){if(d===undefined){d=f.storeKeyFor(e)}hub_precondition(typeof d===hub.T_NUMBER);var b=this.readStatus(d),c,a=hub.Record;if((b===a.BUSY_DESTROYING)||(b&a.DESTROYED)){return this}else{if(b==a.EMPTY){throw a.NOT_FOUND_ERROR}else{if(b&a.BUSY){throw a.BUSY_ERROR}else{if(b==a.READY_NEW){b=a.DESTROYED_CLEAN}else{b=a.DESTROYED_DIRTY}}}}this.writeStatus(d,b);this.dataHashDidChange(d);c=this.changelog;if(!c){c=this.changelog=hub.Set.create()}((b&a.DIRTY)?c.add(d):c.remove(d));this.changelog=c;if(this.get("commitRecordsAutomatically")){this.invokeLast(this.commitRecords)}return this},destroyRecords:function(d,a,f){var g,e,h,b,c,i;if(f===undefined){g=a.length;e=hub.typeOf(d)===hub.T_ARRAY;if(!e){c=d}for(h=0;h<g;h++){if(e){c=d[h]||hub.Record}b=a?a[h]:undefined;this.destroyRecord(c,b,undefined)}}else{g=f.length;for(h=0;h<g;h++){i=f?f[h]:undefined;hub_precondition(typeof i===hub.T_NUMBER);this.destroyRecord(undefined,undefined,i)}}return this},recordDidChange:function(g,f,e,c){if(e===undefined){e=g.storeKeyFor(f)}hub_precondition(typeof e===hub.T_NUMBER);var b=this.readStatus(e),d,a=hub.Record;if(b&a.BUSY){throw a.BUSY_ERROR}else{if(!(b&a.READY)){throw a.NOT_FOUND_ERROR}else{if(b!=a.READY_NEW){this.writeStatus(e,a.READY_DIRTY)}}}this.dataHashDidChange(e,null,null,c);d=this.changelog;if(!d){d=this.changelog=hub.Set.create()}d.add(e);this.changelog=d;if(this.get("commitRecordsAutomatically")){this.invokeLast(this.commitRecords)}return this},recordsDidChange:function(d,a,f){var g,e,h,b,c,i;if(f===undefined){g=a.length;e=hub.typeOf(d)===hub.T_ARRAY;if(!e){c=d}for(h=0;h<g;h++){if(e){c=d[h]||hub.Record}b=a?a[h]:undefined;i=f?f[h]:undefined;hub_precondition(typeof i===hub.T_NUMBER);this.recordDidChange(c,b,i)}}else{g=f.length;for(h=0;h<g;h++){i=f?f[h]:undefined;hub_precondition(typeof i===hub.T_NUMBER);this.recordDidChange(undefined,undefined,i)}}return this},retrieveRecords:function(f,b,i,c){var a=this._hub_getDataSource(),h=hub.typeOf(f)===hub.T_ARRAY,j=(!i)?b.length:i.length,l=[],g=hub.Store.generateStoreKey(),n=hub.Record,d,o,p,e,m;if(!h){d=f}for(o=0;o<j;o++){if(i){p=i[o]}else{if(h){d=f[o]}p=d.storeKeyFor(b[o])}hub_precondition(typeof p===hub.T_NUMBER);e=this.readStatus(p);if((e==n.EMPTY)||(e==n.ERROR)||(e==n.DESTROYED_CLEAN)){this.writeStatus(p,n.BUSY_LOADING);this.dataHashDidChange(p,g,true);l.push(p)}else{if(c){if(e&n.READY){this.writeStatus(p,n.BUSY_REFRESH|(e&3));this.dataHashDidChange(p,g,true);l.push(p)}else{if((e==n.BUSY_DESTROYING)||(e==n.BUSY_CREATING)||(e==n.BUSY_COMMITTING)){throw n.BUSY_ERROR}else{if(e==n.DESTROYED_DIRTY){throw n.BAD_STATE_ERROR}}}}}}m=false;if(a){m=a.retrieveRecords.call(a,this,l,b)}if(!m){j=l.length;g=hub.Store.generateStoreKey();for(o=0;o<j;o++){p=l[o];hub_precondition(typeof p===hub.T_NUMBER);e=this.readStatus(p);if(e===n.BUSY_LOADING){this.writeStatus(p,n.ERROR);this.dataHashDidChange(p,g,true)}else{if(e&n.BUSY_REFRESH){this.writeStatus(p,n.READY|(e&3));this.dataHashDidChange(p,g,true)}}}l.length=0}return l},_hub_TMP_RETRIEVE_ARRAY:[],retrieveRecord:function(f,e,b,c){var d=this._hub_TMP_RETRIEVE_ARRAY,a;if(b){hub_precondition(typeof b===hub.T_NUMBER);d[0]=b;b=d;e=null}else{d[0]=e;e=d}a=this.retrieveRecords(f,e,b,c);d.length=0;return a[0]},refreshRecord:function(c,b,a){return !!this.retrieveRecord(c,b,a,true)},refreshRecords:function(b,c,d){var a=this.retrieveRecords(b,c,d,true);return a&&a.length>0},commitRecords:function(e,m,b,p){var l=this._hub_getDataSource(),g=hub.typeOf(e)===hub.T_ARRAY,c=[],i=[],j=[],q=hub.Store.generateStoreKey(),f=hub.Record,a,h,d,n,s,r,o;if(!e&&!m&&!b){b=this.changelog}o=b?b.get("length"):(m?m.get("length"):0);for(h=0;h<o;h++){if(b){d=b[h]}else{if(g){a=e[h]||hub.Record}else{a=e}d=a.storeKeyFor(m[h])}hub_precondition(typeof d===hub.T_NUMBER);n=this.readStatus(d);if((n==f.EMPTY)||(n==f.ERROR)){throw f.NOT_FOUND_ERROR}else{if(n==f.READY_NEW){this.writeStatus(d,f.BUSY_CREATING);this.dataHashDidChange(d,q,true);c.push(d)}else{if(n==f.READY_DIRTY){this.writeStatus(d,f.BUSY_COMMITTING);this.dataHashDidChange(d,q,true);i.push(d)}else{if(n==f.DESTROYED_DIRTY){this.writeStatus(d,f.BUSY_DESTROYING);this.dataHashDidChange(d,q,true);j.push(d)}else{if(n==f.DESTROYED_CLEAN){this.dataHashDidChange(d,q,true)}}}}}}if(l&&(o>0||p)){r=l.commitRecords.call(l,this,c,i,j,p)}if(r&&!e&&!m&&b===this.changelog){this.changelog=null}return r},commitRecord:function(f,e,b,c){var d=this._hub_TMP_RETRIEVE_ARRAY,a;if(e===undefined&&b===undefined){return false}if(b!==undefined){d[0]=b;b=d;e=null}else{d[0]=e;e=d}a=this.commitRecords(f,e,b,c);d.length=0;return a},cancelRecords:function(e,b,i){var a=this._hub_getDataSource(),g=hub.typeOf(e)===hub.T_ARRAY,l=hub.Record,j=[],f,h,m,c,d,n;h=(i===undefined)?b.length:i.length;for(m=0;m<h;m++){if(g){d=e[m]||hub.Record}else{d=e||hub.Record}c=b?b[m]:undefined;if(i===undefined){n=d.storeKeyFor(c)}else{n=i?i[m]:undefined}if(n){hub_precondition(typeof n===hub.T_NUMBER);f=this.readStatus(n);if((f==l.EMPTY)||(f==l.ERROR)){throw l.NOT_FOUND_ERROR}j.push(n)}}if(a){a.cancel.call(a,this,j)}return this},cancelRecord:function(e,d,b){var c=this._hub_TMP_RETRIEVE_ARRAY,a;if(b!==undefined){c[0]=b;b=c;d=null}else{c[0]=d;d=c}a=this.cancelRecords(e,d,b);c.length=0;return this},loadRecords:function(d,n,a){var f=hub.typeOf(d)===hub.T_ARRAY,g=n.get("length"),h=[],i=hub.Record,c,b,l,j,e,m;if(!f){c=d||hub.Record;l=c.prototype.primaryKey}for(j=0;j<g;j++){e=n.objectAt(j);if(f){c=d.objectAt(j)||hub.Record;l=c.prototype.primaryKey}b=(a)?a.objectAt(j):e[l];h[j]=m=c.storeKeyFor(b);hub_precondition(typeof m===hub.T_NUMBER);if(this.readStatus(m)&i.BUSY){this.dataSourceDidComplete(m,e,b)}else{this.pushRetrieve(c,b,e,m)}}return h},readError:function(a){var b=this.recordErrors;return b?b[a]:undefined},readQueryError:function(a){var b=this.queryErrors;return b?b[hub.guidFor(a)]:undefined},dataSourceDidCancel:function(c){hub_precondition(typeof c===hub.T_NUMBER);var b=this.readStatus(c),a=hub.Record;if(!(b&a.BUSY)){throw a.BAD_STATE_ERROR}switch(b){case a.BUSY_LOADING:b=a.EMPTY;break;case a.BUSY_CREATING:b=a.READY_NEW;break;case a.BUSY_COMMITTING:b=a.READY_DIRTY;break;case a.BUSY_REFRESH_CLEAN:b=a.READY_CLEAN;break;case a.BUSY_REFRESH_DIRTY:b=a.READY_DIRTY;break;case a.BUSY_DESTROYING:b=a.DESTROYED_DIRTY;break;default:throw a.BAD_STATE_ERROR}this.writeStatus(c,b);this.dataHashDidChange(c,null,true);return this},dataSourceDidComplete:function(f,e,d){hub_precondition(typeof f===hub.T_NUMBER);var b=this.readStatus(f),a=hub.Record,c;if(!(b&a.BUSY)){throw a.BAD_STATE_ERROR}if(b===a.BUSY_DESTROYING){throw a.BAD_STATE_ERROR}else{b=a.READY_CLEAN}this.writeStatus(f,b);if(e){this.writeDataHash(f,e,b)}if(d){hub.Store.replaceIdFor(f,d)}c=e||d?false:true;this.dataHashDidChange(f,null,c);return this},dataSourceDidDestroy:function(c){hub_precondition(typeof c===hub.T_NUMBER);var b=this.readStatus(c),a=hub.Record;if(!(b&a.BUSY)){throw a.BAD_STATE_ERROR}else{b=a.DESTROYED_CLEAN}this.removeDataHash(c,b);this.dataHashDidChange(c);return this},dataSourceDidError:function(d,c){hub_precondition(typeof d===hub.T_NUMBER);var b=this.readStatus(d),e=this.recordErrors,a=hub.Record;if(!(b&a.BUSY)){throw a.BAD_STATE_ERROR}else{b=a.ERROR}if(c&&c.isError){if(!e){e=this.recordErrors=[]}e[d]=c}this.writeStatus(d,b);this.dataHashDidChange(d,null,true);return this},pushRetrieve:function(f,e,c,d){var b=hub.Record,a;if(d===undefined){d=f.storeKeyFor(e)}hub_precondition(typeof d===hub.T_NUMBER);a=this.readStatus(d);if(a==b.EMPTY||a==b.ERROR||a==b.READY_CLEAN||a==b.DESTROYED_CLEAN||a==b.BUSY_LOADING){a=b.READY_CLEAN;if(c===undefined){this.writeStatus(d,a)}else{this.writeDataHash(d,c,a)}this.dataHashDidChange(d);return true}return false},pushDestroy:function(e,d,c){var b=hub.Record,a;if(c===undefined){c=e.storeKeyFor(d)}hub_precondition(typeof c===hub.T_NUMBER);a=this.readStatus(c);if(a==b.EMPTY||a==b.ERROR||a==b.READY_CLEAN||a==b.DESTROY_CLEAN){a=b.DESTROY_CLEAN;this.removeDataHash(c,a);this.dataHashDidChange(c);return true}return false},pushError:function(g,f,c,d){var b=hub.Record,a,e=this.recordErrors;if(d===undefined){d=g.storeKeyFor(f)}hub_precondition(typeof d===hub.T_NUMBER);a=this.readStatus(d);if(a==b.EMPTY||a==b.ERROR||a==b.READY_CLEAN||a==b.DESTROY_CLEAN){a=b.ERROR;if(c&&c.isError){if(!e){e=this.recordErrors=[]}e[d]=c}this.writeStatus(d,a);this.dataHashDidChange(d,null,true);return true}return false},loadQueryResults:function(c,a){if(c.get("location")===hub.Query.LOCAL){throw new Error("Cannot load query results for a local query")}var b=this._hub_findQuery(c,true,false);if(b){b.set("storeKeys",a)}this.dataSourceDidFetchQuery(c);return this},dataSourceDidFetchQuery:function(a){return this._hub_scstore_dataSourceDidFetchQuery(a,true)},_hub_scstore_dataSourceDidFetchQuery:function(d,a){var c=this._hub_findQuery(d,a,false),b=this.get("nestedStores"),e=b?b.get("length"):0;if(c){c.storeDidFetchQuery(d)}while(--e>=0){b[e]._hub_scstore_dataSourceDidFetchQuery(d,false)}return this},dataSourceDidCancelQuery:function(a){return this._hub_scstore_dataSourceDidCancelQuery(a,true)},_hub_scstore_dataSourceDidCancelQuery:function(d,a){var c=this._hub_findQuery(d,a,false),b=this.get("nestedStores"),e=b?b.get("length"):0;if(c){c.storeDidCancelQuery(d)}while(--e>=0){b[e]._hub_scstore_dataSourceDidCancelQuery(d,false)}return this},dataSourceDidErrorQuery:function(b,a){var c=this.queryErrors;if(a&&a.isError){if(!c){c=this.queryErrors={}}c[hub.guidFor(b)]=a}return this._hub_scstore_dataSourceDidErrorQuery(b,true)},_hub_scstore_dataSourceDidErrorQuery:function(d,a){var c=this._hub_findQuery(d,a,false),b=this.get("nestedStores"),e=b?b.get("length"):0;if(c){c.storeDidErrorQuery(d)}while(--e>=0){b[e]._hub_scstore_dataSourceDidErrorQuery(d,false)}return this},init:function(){arguments.callee.base.apply(this,arguments);this.reset()},toString:function(){var b=this.get("name");if(!b){return arguments.callee.base.apply(this,arguments)}else{var a=arguments.callee.base.apply(this,arguments);return"%@ (%@)".fmt(b,a)}},idFor:function(a){return hub.Store.idFor(a)},recordTypeFor:function(a){return hub.Store.recordTypeFor(a)},storeKeyFor:function(b,a){return b.storeKeyFor(a)},storeKeyExists:function(b,a){return b.storeKeyExists(a)},storeKeysFor:function(f){var a=[],e=f&&f.isEnumerable,c,d,b;if(!this.statuses){return a}for(d in hub.Store.recordTypesByStoreKey){c=hub.Store.recordTypesByStoreKey[d];if(e){b=f.contains(c)}else{b=c===f}if(b&&this.statuses[d]){a.push(parseInt(d,0))}}return a},storeKeys:function(){var b=[],c;if(!this.statuses){return}var a=hub.Record.EMPTY;for(c in this.statuses){if(this.statuses[c]!==a){b.push(parseInt(c,0))}}return b},statusString:function(a){hub_precondition(typeof a===hub.T_NUMBER);var b=this.materializeRecord(a);return b.statusString()},query:function(a){return this.find(hub.Query.create(a))}});hub.Store.mixin({CHAIN_CONFLICT_ERROR:new Error("Nested Store Conflict"),NO_PARENT_STORE_ERROR:new Error("Parent Store Required"),NESTED_STORE_UNSUPPORTED_ERROR:new Error("Unsupported In Nested Store"),NESTED_STORE_RETRIEVE_DIRTY_ERROR:new Error("Cannot Retrieve Dirty Record in Nested Store"),EDITABLE:"editable",LOCKED:"locked",INHERITED:"inherited",idsByStoreKey:[],recordTypesByStoreKey:{},queriesByStoreKey:[],nextStoreKey:1,generateStoreKey:function(){return this.nextStoreKey++},idFor:function(a){return this.idsByStoreKey[a]},queryFor:function(a){return this.queriesByStoreKey[a]},recordTypeFor:function(a){return this.recordTypesByStoreKey[a]},replaceIdFor:function(c,a){var d=this.idsByStoreKey[c],e,b;if(d!==a){e=this.recordTypeFor(c);if(!e){throw new Error("replaceIdFor: storeKey %@ does not exist".fmt(c))}this.idsByStoreKey[c]=a;b=e.storeKeysById();delete b[d];b[a]=c}return this},replaceRecordTypeFor:function(a,b){this.recordTypesByStoreKey[a]=b;return this}});hub.Store.prototype.nextStoreIndex=1;hub.NestedStore=hub.Store.extend({hasChanges:false,parentStore:null,isNested:true,lockOnRead:true,locks:null,chainedChanges:null,find:function(a){if(a&&a.isQuery&&a.get("location")!==hub.Query.LOCAL){throw"hub.Store#find() can only accept LOCAL queries in nested stores"}return arguments.callee.base.apply(this,arguments)},commitChanges:function(b){if(this.get("hasChanges")){var a=this.get("parentStore");a.commitChangesFromNestedStore(this,this.chainedChanges,b)}this.reset();return this},discardChanges:function(){var c,f;if((c=this.records)&&(f=this.locks)){var b=this.get("parentStore"),h=b.revisions;var g=this.revisions,e,d,a;for(e in c){if(!c.hasOwnProperty(e)){continue}if(!(d=f[e])){continue}a=h[e];if((a!==d)||(g[e]>a)){this._hub_notifyRecordPropertyChange(e)}}}this.reset();this.flush();return this},destroy:function(){this.discardChanges();var a=this.get("parentStore");if(a){a.willDestroyNestedStore(this)}arguments.callee.base.apply(this,arguments);return this},reset:function(){var a=this.get("parentStore");if(!a){throw hub.Store.NO_PARENT_STORE_ERROR}this.dataHashes=hub.beget(a.dataHashes);this.revisions=hub.beget(a.revisions);this.statuses=hub.beget(a.statuses);this.chainedChanges=this.locks=this.editables=null;this.changelog=null;this.set("hasChanges",false)},refreshQuery:function(b){var a=this.get("parentStore");if(a){a.refreshQuery(b)}return this},readError:function(b){var a=this.get("parentStore");return a?a.readError(b):null},readQueryError:function(b){var a=this.get("parentStore");return a?a.readQueryError(b):null},storeKeyEditState:function(b){var c=this.editables,a=this.locks;return(c&&c[b])?hub.Store.EDITABLE:(a&&a[b])?hub.Store.LOCKED:hub.Store.INHERITED},_hub_lock:function(e){var d=this.locks,a,f;if(d&&d[e]){return this}if(!d){d=this.locks=[]}f=this.editables;if(f){f[e]=0}var c=this.get("parentStore"),b;while(c&&(b=c.storeKeyEditState(e))===hub.Store.INHERITED){c=c.get("parentStore")}if(c&&b===hub.Store.EDITABLE){this.dataHashes[e]=hub.clone(c.dataHashes[e]);if(!f){f=this.editables=[]}f[e]=1}else{this.dataHashes[e]=this.dataHashes[e]}this.statuses[e]=this.statuses[e];a=this.revisions[e]=this.revisions[e];d[e]=a||1;return this},readDataHash:function(a){if(this.get("lockOnRead")){this._hub_lock(a)}return this.dataHashes[a]},readEditableDataHash:function(a){this._hub_lock(a);return arguments.callee.base.apply(this,arguments)},writeDataHash:function(d,f,b){var c=this.locks,a;if(f){this.dataHashes[d]=f}this.statuses[d]=b?b:(this.statuses[d]||hub.Record.READY_NEW);a=this.revisions[d]=this.revisions[d];if(!c){c=this.locks=[]}if(!c[d]){c[d]=a||1}var e=this.editables;if(!e){e=this.editables=[]}e[d]=1;return this},removeDataHash:function(c,a){var b=this.locks;if(!b){b=this.locks=[]}if(!b[c]){b[c]=this.revisions[c]||1}return arguments.callee.base.apply(this,arguments)},dataHashDidChange:function(d,b,a,h){if(!b){b=hub.Store.generateStoreKey()}var c,e,g,i;c=hub.typeOf(d)===hub.T_ARRAY;if(c){e=d.length}else{e=1;i=d}var f=this.chainedChanges;if(!f){f=this.chainedChanges=hub.Set.create()}for(g=0;g<e;g++){if(c){i=d[g]}this._hub_lock(i);this.revisions[i]=b;f.add(i);this._hub_notifyRecordPropertyChange(i,a,h)}this.setIfChanged("hasChanges",true);return this},commitChangesFromNestedStore:function(e,f,a){arguments.callee.base.apply(this,arguments);var b=this.get("parentStore"),h=b.revisions,c;var l=this.locks,g=this.chainedChanges,d,j;if(!l){l=this.locks=[]}if(!g){g=this.chainedChanges=hub.Set.create()}d=f.length;for(c=0;c<d;c++){j=f[c];if(!l[j]){l[j]=h[j]||1}g.add(j)}this.setIfChanged("hasChanges",g.get("length")>0);this.flush();return this},queryFor:function(c,a,b){return this.get("parentStore").queryFor(c,a,b)},retrieveRecords:function(f,n,b,c){var a=this.get("parentStore"),l,d,q,p=(!b)?n.length:b.length,i=hub.Record,o;if(c){for(l=0;l<p;l++){d=!b?a.storeKeyFor(f,n[l]):b[l];o=this.peekStatus(d);if(o&i.DIRTY){throw hub.Store.NESTED_STORE_RETRIEVE_DIRTY_ERROR}else{var g=this.dataHashes,j=this.revisions,h=this.statuses,m=this.editables,s=this.locks;var e=false;var r=false;if(g&&g.hasOwnProperty(d)){delete g[d];e=true}if(j&&j.hasOwnProperty(d)){delete j[d];e=true}if(m){delete m[d]}if(s){delete s[d]}if(h&&h.hasOwnProperty(d)){delete h[d];if(!e){r=true}e=true}if(e){this._hub_notifyRecordPropertyChange(d,r)}}}}return a.retrieveRecords(f,n,b,c)},commitRecords:function(a,b,c){throw hub.Store.NESTED_STORE_UNSUPPORTED_ERROR},commitRecord:function(c,b,a){throw hub.Store.NESTED_STORE_UNSUPPORTED_ERROR},cancelRecords:function(a,b,c){throw hub.Store.NESTED_STORE_UNSUPPORTED_ERROR},cancelRecord:function(c,b,a){throw hub.Store.NESTED_STORE_UNSUPPORTED_ERROR},dataSourceDidCancel:function(a){throw hub.Store.NESTED_STORE_UNSUPPORTED_ERROR},dataSourceDidComplete:function(c,b,a){throw hub.Store.NESTED_STORE_UNSUPPORTED_ERROR},dataSourceDidDestroy:function(a){throw hub.Store.NESTED_STORE_UNSUPPORTED_ERROR},dataSourceDidError:function(b,a){throw hub.Store.NESTED_STORE_UNSUPPORTED_ERROR},pushRetrieve:function(d,c,a,b){throw hub.Store.NESTED_STORE_UNSUPPORTED_ERROR},pushDestroy:function(c,b,a){throw hub.Store.NESTED_STORE_UNSUPPORTED_ERROR},pushError:function(d,c,a,b){throw hub.Store.NESTED_STORE_UNSUPPORTED_ERROR}});hub.Query=hub.Object.extend(hub.Copyable,hub.Freezable,{isQuery:true,conditions:null,orderBy:null,recordType:null,recordTypes:null,expandedRecordTypes:function(){var b=hub.CoreSet.create(),a,c;if(a=this.get("recordType")){this._hub_scq_expandRecordType(a,b)}else{if(a=this.get("recordTypes")){a.forEach(function(d){this._hub_scq_expandRecordType(d,b)},this)}else{this._hub_scq_expandRecordType(hub.Record,b)}}c=hub.Query._hub_scq_queriesWithExpandedRecordTypes;if(!c){c=hub.Query._hub_scq_queriesWithExpandedRecordTypes=hub.CoreSet.create()}c.add(this);return b.freeze()}.property("recordType","recordTypes").cacheable(),_hub_scq_expandRecordType:function(b,a){if(a.contains(b)){return}a.add(b);if(hub.typeOf(b)===hub.T_STRING){b=hub.objectForPropertyPath(b)}b.subclasses.forEach(function(c){this._hub_scq_expandRecordType(c,a)},this)},parameters:null,location:"local",scope:null,isRemote:function(){return this.get("location")===hub.Query.REMOTE}.property("location").cacheable(),isLocal:function(){return this.get("location")===hub.Query.LOCAL}.property("location").cacheable(),isEditable:false,contains:function(a,d){var e,b=true;if(e=this.get("recordTypes")){b=e.find(function(f){return hub.kindOf(a,f)})}else{if(e=this.get("recordType")){b=hub.kindOf(a,e)}}if(!b){return false}var c=this.get("scope");if(c&&!c.contains(a)){return false}if(!this._hub_isReady){this.parse()}if(!this._hub_isReady){return false}if(d===undefined){d=this.parameters||this}return this._hub_tokenTree.evaluate(a,d)},containsRecordTypes:function(a){var b=this.get("recordType");if(b){return !!a.find(function(c){return hub.kindOf(c,b)})}else{if(b=this.get("recordTypes")){return !!b.find(function(c){return !!a.find(function(d){return hub.kindOf(d,c)})})}else{return true}}},compare:function(f,d){var c=0,e,b,a,g;if(f===d){return 0}if(!this._hub_isReady){this.parse()}if(!this._hub_isReady){return hub.compare(f.get("id"),d.get("id"))}b=this._hub_order;a=b?b.length:0;for(g=0;c===0&&(g<a);g++){e=b[g].propertyName;if(hub.Query.comparisons[e]){c=hub.Query.comparisons[e](f.get(e),d.get(e))}else{c=hub.compare(f.get(e),d.get(e))}if((c!==0)&&b[g].descending){c=(-1)*c}}if(c!==0){return c}else{return hub.compare(f.get("id"),d.get("id"))}},_hub_isReady:false,parse:function(){var c=this.get("conditions"),d=this.get("queryLanguage"),b,a;b=this._hub_tokenList=this.tokenizeString(c,d);a=this._hub_tokenTree=this.buildTokenTree(b,d);this._hub_order=this.buildOrder(this.get("orderBy"));this._hub_isReady=!!a&&!a.error;if(a&&a.error){throw a.error}return this._hub_isReady},queryWithScope:function(c){var b=hub.keyFor("__query__",hub.guidFor(this)),a=c[b];if(!a){c[b]=a=this.copy();a.set("scope",c);a.freeze()}return a},copyKeys:"conditions orderBy recordType recordTypes parameters location scope".w(),concatenatedProperties:"copyKeys".w(),copy:function(){var d={},c=this.get("copyKeys"),f=c?c.length:0,b,e,a;while(--f>=0){b=c[f];e=this.get(b);if(e!==undefined){d[b]=e}}a=this.constructor.create(d);d=null;return a},queryLanguage:{UNKNOWN:{firstCharacter:/[^\s'"\w\d\(\)\{\}]/,notAllowed:/[\s'"\w\d\(\)\{\}]/},PROPERTY:{firstCharacter:/[a-zA-Z_]/,notAllowed:/[^a-zA-Z_0-9]/,evalType:"PRIMITIVE",evaluate:function(b,a){return b.get(this.tokenValue)}},NUMBER:{firstCharacter:/\d/,notAllowed:/[^\d\.]/,format:/^\d+$|^\d+\.\d+$/,evalType:"PRIMITIVE",evaluate:function(b,a){return parseFloat(this.tokenValue)}},STRING:{firstCharacter:/['"]/,delimeted:true,evalType:"PRIMITIVE",evaluate:function(b,a){return this.tokenValue}},PARAMETER:{firstCharacter:/\{/,lastCharacter:"}",delimeted:true,evalType:"PRIMITIVE",evaluate:function(b,a){return a[this.tokenValue]}},"%@":{rememberCount:true,reservedWord:true,evalType:"PRIMITIVE",evaluate:function(b,a){return a[this.tokenValue]}},OPEN_PAREN:{firstCharacter:/\(/,singleCharacter:true},CLOSE_PAREN:{firstCharacter:/\)/,singleCharacter:true},AND:{reservedWord:true,leftType:"BOOLEAN",rightType:"BOOLEAN",evalType:"BOOLEAN",evaluate:function(c,a){var d=this.leftSide.evaluate(c,a);var b=this.rightSide.evaluate(c,a);return d&&b}},OR:{reservedWord:true,leftType:"BOOLEAN",rightType:"BOOLEAN",evalType:"BOOLEAN",evaluate:function(c,a){var d=this.leftSide.evaluate(c,a);var b=this.rightSide.evaluate(c,a);return d||b}},NOT:{reservedWord:true,rightType:"BOOLEAN",evalType:"BOOLEAN",evaluate:function(c,a){var b=this.rightSide.evaluate(c,a);return !b}},"=":{reservedWord:true,leftType:"PRIMITIVE",rightType:"PRIMITIVE",evalType:"BOOLEAN",evaluate:function(c,a){var d=this.leftSide.evaluate(c,a);var b=this.rightSide.evaluate(c,a);return d==b}},"!=":{reservedWord:true,leftType:"PRIMITIVE",rightType:"PRIMITIVE",evalType:"BOOLEAN",evaluate:function(c,a){var d=this.leftSide.evaluate(c,a);var b=this.rightSide.evaluate(c,a);return d!=b}},"<":{reservedWord:true,leftType:"PRIMITIVE",rightType:"PRIMITIVE",evalType:"BOOLEAN",evaluate:function(c,a){var d=this.leftSide.evaluate(c,a);var b=this.rightSide.evaluate(c,a);return d<b}},"<=":{reservedWord:true,leftType:"PRIMITIVE",rightType:"PRIMITIVE",evalType:"BOOLEAN",evaluate:function(c,a){var d=this.leftSide.evaluate(c,a);var b=this.rightSide.evaluate(c,a);return d<=b}},">":{reservedWord:true,leftType:"PRIMITIVE",rightType:"PRIMITIVE",evalType:"BOOLEAN",evaluate:function(c,a){var d=this.leftSide.evaluate(c,a);var b=this.rightSide.evaluate(c,a);return d>b}},">=":{reservedWord:true,leftType:"PRIMITIVE",rightType:"PRIMITIVE",evalType:"BOOLEAN",evaluate:function(c,a){var d=this.leftSide.evaluate(c,a);var b=this.rightSide.evaluate(c,a);return d>=b}},BEGINS_WITH:{reservedWord:true,leftType:"PRIMITIVE",rightType:"PRIMITIVE",evalType:"BOOLEAN",evaluate:function(c,a){var b=this.leftSide.evaluate(c,a);var d=this.rightSide.evaluate(c,a);return(b.indexOf(d)===0)}},ENDS_WITH:{reservedWord:true,leftType:"PRIMITIVE",rightType:"PRIMITIVE",evalType:"BOOLEAN",evaluate:function(d,b){var c=this.leftSide.evaluate(d,b);var a=this.rightSide.evaluate(d,b);return(c.indexOf(a)===(c.length-a.length))}},CONTAINS:{reservedWord:true,leftType:"PRIMITIVE",rightType:"PRIMITIVE",evalType:"BOOLEAN",evaluate:function(d,a){var c=this.leftSide.evaluate(d,a)||[];var f=this.rightSide.evaluate(d,a);switch(hub.typeOf(c)){case hub.T_STRING:return(c.indexOf(f)!==-1);case hub.T_ARRAY:var e=false;var b=0;while(e===false&&b<c.length){if(f==c[b]){e=true}b++}return e;default:break}}},ANY:{reservedWord:true,leftType:"PRIMITIVE",rightType:"PRIMITIVE",evalType:"BOOLEAN",evaluate:function(d,a){var f=this.leftSide.evaluate(d,a);var b=this.rightSide.evaluate(d,a);var e=false;var c=0;while(e===false&&c<b.length){if(f==b[c]){e=true}c++}return e}},MATCHES:{reservedWord:true,leftType:"PRIMITIVE",rightType:"PRIMITIVE",evalType:"BOOLEAN",evaluate:function(c,a){var d=this.leftSide.evaluate(c,a);var b=this.rightSide.evaluate(c,a);return b.test(d)}},TYPE_IS:{reservedWord:true,rightType:"PRIMITIVE",evalType:"BOOLEAN",evaluate:function(d,a){var c=hub.Store.recordTypeFor(d.storeKey);var b=this.rightSide.evaluate(d,a);var e=hub.objectForPropertyPath(b);return c==e}},"null":{reservedWord:true,evalType:"PRIMITIVE",evaluate:function(b,a){return null}},"undefined":{reservedWord:true,evalType:"PRIMITIVE",evaluate:function(b,a){return undefined}},"false":{reservedWord:true,evalType:"PRIMITIVE",evaluate:function(b,a){return false}},"true":{reservedWord:true,evalType:"PRIMITIVE",evaluate:function(b,a){return true}},YES:{reservedWord:true,evalType:"PRIMITIVE",evaluate:function(b,a){return true}},NO:{reservedWord:true,evalType:"PRIMITIVE",evaluate:function(b,a){return false}}},tokenizeString:function(w,r){var l=[],u=null,h=null,f=null,v=null,a=null,j=null,d=null,g=null,s=false,b=false,n=false,o=false,p={};function e(t,c){h=r[t];if(h.format&&!h.format.test(c)){t="UNKNOWN"}if(h.delimeted){o=true}if(!h.delimeted){for(var i in r){if(r[i].reservedWord&&i==c){t=i}}}h=r[t];if(h&&h.rememberCount){if(!p[t]){p[t]=0}c=p[t];p[t]+=1}l.push({tokenType:t,tokenValue:c});a=null;j=null;d=null}if(!w){return[]}var m=w.length;for(var q=0;q<m;q++){s=(q===m-1);u=w.charAt(q);o=false;if(a){h=r[a];b=h.delimeted?u===g:h.notAllowed.test(u);if(!b){d+=u}if(b||s){e(a,d)}if(s&&!b){o=true}}if(!a&&!o){for(f in r){h=r[f];if(h.firstCharacter&&h.firstCharacter.test(u)){a=f}}if(a){h=r[a];d=u;if(h.delimeted){d="";if(h.lastCharacter){g=h.lastCharacter}else{g=u}}if(h.singleCharacter||s){e(a,d)}}}}return l},buildTokenTree:function(m,a){var p=m.slice();var r=0;var t=[];var c=false;var q=[];if(!m||m.length===0){return{evaluate:function(){return true}}}function s(i){var w=i;if(w<0){return false}var l=a[p[w].tokenType];if(!l){q.push("logic for token '"+p[w].tokenType+"' is not defined");return false}p[w].evaluate=l.evaluate;return l}function b(w,i){var x=i;var l=s(x);if(!l){return false}if(w=="left"){return l.leftType}if(w=="right"){return l.rightType}}function o(i){var w=i;var l=s(w);if(!l){return false}else{return l.evalType}}function f(i){p.splice(i,1);if(i<=r){r--}}function u(i){var l=i||r;if(l>0){return true}else{return false}}function j(i){var l=i;if(l<0){return true}return(b("left",l)&&!p[l].leftSide)||(b("right",l)&&!p[l].rightSide)}function h(l,w){var i=(w<l)?"left":"right";if(l<0||w<0){return false}if(!b(i,l)){return false}if(!o(w)){return false}if(b(i,l)==o(w)){return true}else{return false}}function n(i){var l=i;if(!j(l)){return false}if(!u(l)){return false}if(h(l,l-1)){return true}else{return false}}function d(i){var l=i;if(j(l)){return false}if(!u(l)){return false}if(!j(l-1)){return false}if(h(l-1,l)){return true}else{return false}}function g(i){var l=i;if(l<1){return false}p[l].leftSide=p[l-1];f(l-1)}function v(i){var l=i;if(l<1){return false}p[l-1].rightSide=p[l];f(l)}function e(i){f(i);f(t.pop())}for(r=0;r<p.length;r++){c=false;if(p[r].tokenType=="UNKNOWN"){q.push("found unknown token: "+p[r].tokenValue)}if(p[r].tokenType=="OPEN_PAREN"){t.push(r)}if(p[r].tokenType=="CLOSE_PAREN"){e(r)}if(n(r)){g(r)}if(d(r)){v(r);c=true}if(c){r--}}if(p.length==1){p=p[0]}else{q.push("string did not resolve to a single tree")}if(q.length>0){return{error:q.join(",\n"),tree:p}}else{return p}},buildOrder:function(c){if(!c){return[]}else{var d=c.split(",");for(var a=0;a<d.length;a++){var b=d[a];b=b.replace(/^\s+|\s+$/,"");b=b.replace(/\s+/,",");b=b.split(",");d[a]={propertyName:b[0]};if(b[1]&&b[1]=="DESC"){d[a].descending=true}}return d}}});hub.Query.mixin({LOCAL:"local",REMOTE:"remote",storeKeyFor:function(a){return a?a.get("storeKey"):null},containsRecords:function(g,e,d){var f=[];for(var b=0,a=e.get("length");b<a;b++){var c=e.objectAt(b);if(c&&g.contains(c)){f.push(c.get("storeKey"))}}f=hub.Query.orderStoreKeys(f,g,d);return f},orderStoreKeys:function(b,c,a){if(b){hub.Query._hub_TMP_STORE=a;hub.Query._hub_TMP_QUERY_KEY=c;b.sort(hub.Query.compareStoreKeys);hub.Query._hub_TMP_STORE=hub.Query._hub_TMP_QUERY_KEY=null}return b},compareStoreKeys:function(f,e){var c=hub.Query._hub_TMP_STORE,d=hub.Query._hub_TMP_QUERY_KEY,b=c.materializeRecord(f),a=c.materializeRecord(e);return d.compare(b,a)},build:function(h,c,g,d){var a=null,f,b,i,e;if(c&&c.isQuery){if(c.get("location")===h){return c}else{return c.copy().set("location",h).freeze()}}if(typeof c===hub.T_STRING){f=hub.objectForPropertyPath(c);if(!f){throw"%@ did not resolve to a class".fmt(c)}c=f}else{if(c&&c.isEnumerable){f=[];c.forEach(function(j){if(typeof j===hub.T_STRING){j=hub.objectForPropertyPath(j)}if(!j){throw"cannot resolve record types: %@".fmt(c)}f.push(j)},this);c=f}else{if(!c){c=hub.Record}}}if(d===undefined){d=null}if(g===undefined){g=null}if(!d&&(typeof g!==hub.T_STRING)){a=g;g=null}if(!d&&!a){e=hub.Query._hub_scq_recordTypeCache;if(!e){e=hub.Query._hub_scq_recordTypeCache={}}b=e[h];if(!b){b=e[h]={}}if(c.isEnumerable){i=c.map(function(j){return hub.guidFor(j)});i=i.sort().join(":")}else{i=hub.guidFor(c)}if(g){i=[i,g].join("::")}f=b[i];if(!f){if(c.isEnumerable){a={recordTypes:c.copy()}}else{a={recordType:c}}a.location=h;a.conditions=g;f=b[i]=hub.Query.create(a).freeze()}}else{if(!a){a={}}if(!a.location){a.location=h}if(c&&c.isEnumerable){a.recordsTypes=c}else{a.recordType=c}if(g){a.conditions=g}if(d){a.parameters=d}f=hub.Query.create(a).freeze()}return f},local:function(c,a,b){return this.build(hub.Query.LOCAL,c,a,b)},remote:function(c,a,b){return this.build(hub.Query.REMOTE,c,a,b)},_hub_scq_didDefineRecordType:function(){var a=hub.Query._hub_scq_queriesWithExpandedRecordTypes;if(a){a.forEach(function(b){b.notifyPropertyChange("expandedRecordTypes")},this);a.clear()}}});hub.Query.comparisons={};hub.Query.registerComparison=function(a,b){hub.Query.comparisons[a]=b};hub.Query.registerQueryExtension=function(b,a){hub.Query.prototype.queryLanguage[b]=a};hub.Q=hub.Query.from;hub.RecordArray=hub.Object.extend(hub.Enumerable,hub.Array,{store:null,query:null,storeKeys:null,status:hub.Record.EMPTY,isEditable:function(){var a=this.get("query");return a?a.get("isEditable"):false}.property("query").cacheable(),length:function(){this.flush();var a=this.get("storeKeys");return a?a.get("length"):0}.property("storeKeys").cacheable(),_hub_scra_records:null,objectAt:function(a){this.flush();var f=this._hub_scra_records,e=this.get("storeKeys"),b=this.get("store"),d,c;if(!e||!b){return undefined}if(f&&(c=f[a])){return c}if(!f){this._hub_scra_records=f=[]}d=e.objectAt(a);if(d){if(b.peekStatus(d)===hub.Record.EMPTY){b.retrieveRecord(null,null,d)}f[a]=c=b.materializeRecord(d)}return c},forEach:function(h,d){this.flush();var e=this._hub_scra_records,b=this.get("storeKeys"),f=this.get("store"),c=b?b.get("length"):0,g,i,a;if(!b||!f){return this}if(!e){e=this._hub_scra_records=[]}if(!d){d=this}for(g=0;g<c;g++){a=e[g];if(!a){a=e[g]=f.materializeRecord(b.objectAt(g))}h.call(d,a,g,this)}return this},replace:function(b,h,g){this.flush();var e=this.get("storeKeys"),a=g?(g.get?g.get("length"):g.length):0,c,d;if(!e){throw"storeKeys required"}var f=this.get("query");if(f&&!f.get("isEditable")){throw hub.RecordArray.NOT_EDITABLE}d=[];for(c=0;c<a;c++){d[c]=g.objectAt(c).get("storeKey")}e.replace(b,h,d);return this},contains:function(a){return this.indexOf(a)>=0},indexOf:function(b,a){if(!hub.kindOf(b,hub.Record)){return false}this.flush();var d=b.get("storeKey"),c=this.get("storeKeys");return c?c.indexOf(d,a):-1},lastIndexOf:function(b,a){if(!hub.kindOf(b,hub.Record)){return false}this.flush();var d=b.get("storeKey"),c=this.get("storeKeys");return c?c.lastIndexOf(d,a):-1},add:function(a){if(!hub.kindOf(a,hub.Record)){return this}if(this.indexOf(a)<0){this.pushObject(a)}return this},remove:function(a){if(!hub.kindOf(a,hub.Record)){return this}this.removeObject(a);return this},find:function(a,b){if(a&&a.isQuery){return this.get("store").find(a.queryWithScope(this))}else{return arguments.callee.base.apply(this,arguments)}},refresh:function(){this.get("store").refreshQuery(this.get("query"))},destroy:function(){if(!this.get("isDestroyed")){this.get("store").recordArrayWillDestroy(this)}arguments.callee.base.apply(this,arguments)},storeWillFetchQuery:function(c){var b=this.get("status"),a=hub.Record;if((b===a.EMPTY)||(b===a.ERROR)){b=a.BUSY_LOADING}if(b&a.READY){b=a.BUSY_REFRESH}this.setIfChanged("status",b);return this},storeDidFetchQuery:function(a){this.setIfChanged("status",hub.Record.READY_CLEAN);return this},storeDidCancelQuery:function(c){var b=this.get("status"),a=hub.Record;if(b===a.BUSY_LOADING){b=a.EMPTY}else{if(b===a.BUSY_REFRESH){b=a.READY_CLEAN}}this.setIfChanged("status",b);return this},storeDidErrorQuery:function(a){this.setIfChanged("status",hub.Record.ERROR);return this},storeDidChangeStoreKeys:function(b,a){var c=this.get("query");if(c.get("location")!==hub.Query.LOCAL){return this}if(!c.containsRecordTypes(a)){return this}var d=this._hub_scq_changedStoreKeys;if(!d){d=this._hub_scq_changedStoreKeys=hub.IndexSet.create()}d.addEach(b);this.set("needsFlush",true);this.enumerableContentDidChange();return this},flush:function(){if(!this.get("needsFlush")){return this}this.set("needsFlush",false);var h=this.get("query"),j=this.get("store");if(!j||!h||h.get("location")!==hub.Query.LOCAL){return this}var f=this.get("storeKeys"),d=this._hub_scq_changedStoreKeys,e=false,i=hub.Record,b,c,a,m,l,g;if(f){if(d){d.forEach(function(n){c=j.peekStatus(n);if(!(c&i.EMPTY)&&!((c&i.DESTROYED)||(c===i.BUSY_DESTROYING))){b=j.materializeRecord(n);g=!!(b&&h.contains(b))}else{g=false}if(g){if(f.indexOf(n)<0){if(!e){f=f.copy()}f.pushObject(n)}}else{if(f.indexOf(n)>=0){if(!e){f=f.copy()}f.removeObject(n)}}},this);e=true}}else{if(l=h.get("scope")){m=l.flush().get("storeKeys")}else{if(a=h.get("expandedRecordTypes")){m=hub.IndexSet.create();a.forEach(function(n){m.addEach(j.storeKeysFor(a))})}}f=[];m.forEach(function(n){c=j.peekStatus(n);if(!(c&i.EMPTY)&&!((c&i.DESTROYED)||(c===i.BUSY_DESTROYING))){b=j.materializeRecord(n);if(b&&h.contains(b)){f.push(n)}}});e=true}if(d){d.clear()}if(e){f=hub.Query.orderStoreKeys(f,h,j);this.set("storeKeys",hub.clone(f))}return this},needsFlush:true,isError:function(){return this.get("status")&hub.Record.ERROR}.property("status").cacheable(),errorValue:function(){return this.get("isError")?hub.val(this.get("errorObject")):null}.property("isError").cacheable(),errorObject:function(){if(this.get("isError")){var a=this.get("store");return a.readQueryError(this.get("query"))||hub.Record.GENERIC_ERROR}else{return null}}.property("isError").cacheable(),refresh:function(){var a=this.get("store");if(!a){return}var b=a._hub_getDataSource();if(!b||b.fetch===undefined){return}var c=this.get("queryKey");if(!c){return}b.fetch.call(b,a,c,null);return this},_hub_storeKeysDidChange:function(){var d=this.get("storeKeys");var c=this._hub_prevStoreKeys,e=this._hub_storeKeysContentDidChange,a=this._hub_storeKeysStateDidChange;if(d===c){return this}if(c){c.removeObserver("[]",this,e)}this._hub_prevStoreKeys=d;if(d){d.addObserver("[]",this,e)}var b=(d)?d.propertyRevision:-1;this._hub_storeKeysContentDidChange(d,"[]",d,b)}.observes("storeKeys"),_hub_storeKeysContentDidChange:function(d,b,c,a){if(this._hub_scra_records){this._hub_scra_records.length=0}this.beginPropertyChanges().notifyPropertyChange("length").enumerableContentDidChange().endPropertyChanges()},init:function(){arguments.callee.base.apply(this,arguments);this._hub_storeKeysDidChange()}});hub.RecordArray.mixin({NOT_EDITABLE:hub.Error.desc("hub.RecordArray is not editable")});
/*
  Math.uuid.js (v1.4)
  http://www.broofa.com
  mailto:robert@broofa.com
 
  Copyright (c) 2009 Robert Kieffer
  Dual licensed under the MIT and GPL licenses.
*/
hub.uuid=(function(){var a="0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz".split("");return function(b,e){var g=a,d=[],c;e=e||g.length;if(b){for(c=0;c<b;c++){d[c]=g[0|Math.random()*e]}}else{var f;d[8]=d[13]=d[18]=d[23]="-";d[14]="4";for(c=0;c<36;c++){if(!d[c]){f=0|Math.random()*16;d[c]=g[(c==19)?(f&3)|8:f]}}}return d.join("")}})();hub.SHA256=function(q){var l=8,o=0;function i(r,u){var t=(r&65535)+(u&65535);var s=(r>>16)+(u>>16)+(t>>16);return(s<<16)|(t&65535)}function e(s,r){return(s>>>r)|(s<<(32-r))}function f(s,r){return(s>>>r)}function a(r,t,s){return((r&t)^((~r)&s))}function d(r,t,s){return((r&t)^(r&s)^(t&s))}function g(r){return(e(r,2)^e(r,13)^e(r,22))}function b(r){return(e(r,6)^e(r,11)^e(r,25))}function p(r){return(e(r,7)^e(r,18)^f(r,3))}function j(r){return(e(r,17)^e(r,19)^f(r,10))}function c(s,t){var F=new Array(1116352408,1899447441,3049323471,3921009573,961987163,1508970993,2453635748,2870763221,3624381080,310598401,607225278,1426881987,1925078388,2162078206,2614888103,3248222580,3835390401,4022224774,264347078,604807628,770255983,1249150122,1555081692,1996064986,2554220882,2821834349,2952996808,3210313671,3336571891,3584528711,113926993,338241895,666307205,773529912,1294757372,1396182291,1695183700,1986661051,2177026350,2456956037,2730485921,2820302411,3259730800,3345764771,3516065817,3600352804,4094571909,275423344,430227734,506948616,659060556,883997877,958139571,1322822218,1537002063,1747873779,1955562222,2024104815,2227730452,2361852424,2428436474,2756734187,3204031479,3329325298);var u=new Array(1779033703,3144134277,1013904242,2773480762,1359893119,2600822924,528734635,1541459225);var r=new Array(64);var H,G,E,D,B,z,y,x,w,v;var C,A;s[t>>5]|=128<<(24-t%32);s[((t+64>>9)<<4)+15]=t;for(var w=0;w<s.length;w+=16){H=u[0];G=u[1];E=u[2];D=u[3];B=u[4];z=u[5];y=u[6];x=u[7];for(var v=0;v<64;v++){if(v<16){r[v]=s[v+w]}else{r[v]=i(i(i(j(r[v-2]),r[v-7]),p(r[v-15])),r[v-16])}C=i(i(i(i(x,b(B)),a(B,z,y)),F[v]),r[v]);A=i(g(H),d(H,G,E));x=y;y=z;z=B;B=i(D,C);D=E;E=G;G=H;H=i(C,A)}u[0]=i(H,u[0]);u[1]=i(G,u[1]);u[2]=i(E,u[2]);u[3]=i(D,u[3]);u[4]=i(B,u[4]);u[5]=i(z,u[5]);u[6]=i(y,u[6]);u[7]=i(x,u[7])}return u}function h(u){var t=Array();var r=(1<<l)-1;for(var s=0;s<u.length*l;s+=l){t[s>>5]|=(u.charCodeAt(s/l)&r)<<(24-s%32)}return t}function n(s){s=s.replace(/\r\n/g,"\n");var r="";for(var u=0;u<s.length;u++){var t=s.charCodeAt(u);if(t<128){r+=String.fromCharCode(t)}else{if((t>127)&&(t<2048)){r+=String.fromCharCode((t>>6)|192);r+=String.fromCharCode((t&63)|128)}else{r+=String.fromCharCode((t>>12)|224);r+=String.fromCharCode(((t>>6)&63)|128);r+=String.fromCharCode((t&63)|128)}}}return r}function m(t){var s=o?"0123456789ABCDEF":"0123456789abcdef";var u="";for(var r=0;r<t.length*4;r++){u+=s.charAt((t[r>>2]>>((3-r%4)*8+4))&15)+s.charAt((t[r>>2]>>((3-r%4)*8))&15)}return u}q=n(q);return m(c(h(q),q.length*l))};hub.buzhash=function(a){return 0};hub.base64chars=["A","B","C","D","E","F","G","H","I","J","K","L","M","N","O","P","Q","R","S","T","U","V","W","X","Y","Z","a","b","c","d","e","f","g","h","i","j","k","l","m","n","o","p","q","r","s","t","u","v","w","x","y","z","0","1","2","3","4","5","6","7","8","9","+","/"];hub.base64inv={0:52,1:53,2:54,3:55,4:56,5:57,6:58,7:59,8:60,9:61,"+":62,"/":63,A:0,B:1,C:2,D:3,E:4,F:5,G:6,H:7,I:8,J:9,K:10,L:11,M:12,N:13,O:14,P:15,Q:16,R:17,S:18,T:19,U:20,V:21,W:22,X:23,Y:24,Z:25,a:26,b:27,c:28,d:29,e:30,f:31,g:32,h:33,i:34,j:35,k:36,l:37,m:38,n:39,o:40,p:41,q:42,r:43,s:44,t:45,u:46,v:47,w:48,x:49,y:50,z:51};hub.base64_encode=function(b){var a=hub.base64chars,d="",e="",g=b.length%3;if(g>0){for(;g<3;g++){e+="=";b+="\0"}}for(g=0;g<b.length;g+=3){if(g>0&&(g/3*4)%76==0){d+="\r\n"}var f=(b.charCodeAt(g)<<16)+(b.charCodeAt(g+1)<<8)+b.charCodeAt(g+2);f=[(f>>>18)&63,(f>>>12)&63,(f>>>6)&63,f&63];d+=a[f[0]]+a[f[1]]+a[f[2]]+a[f[3]]}return d.substring(0,d.length-e.length)+e};hub.base64_decode=function(d){var b=hub.base64inv,a=hub.base64chars;d=d.replace(new RegExp("[^"+a.join("")+"=]","g"),"");var f=(d.charAt(d.length-1)=="="?(d.charAt(d.length-2)=="="?"AA":"A"):"");var e="";d=d.substr(0,d.length-f.length)+f;for(var h=0;h<d.length;h+=4){var g=(b[d.charAt(h)]<<18)+(b[d.charAt(h+1)]<<12)+(b[d.charAt(h+2)]<<6)+b[d.charAt(h+3)];e+=String.fromCharCode((g>>>16)&255,(g>>>8)&255,g&255)}return e.substring(0,e.length-f.length)};hub.Database=hub.Object.extend({});hub.Hub=hub.Store.extend({metaData:{},hasSocket:false,currentCommit:null,checkingOut:null,currentCommitId:0,commitKeys:hub.CoreSet.create(),commitIdsByKey:{},hubKeys:[],hubsByKey:{},nextCommitId:function(){return ++this.currentCommitId},_keysByType:{},_recordsByKey:{},_types:[],_sourceByType:{},uti:"com.sprouthub.app",_hub:{name:null,key:null,head:null,setup:false,db:null},state:0,dbState:"a",goState:function(a){hub.debug("Going to state: %@".fmt(a));this.state=a},goDbState:function(a){hub.debug("Going to DB state: %@".fmt(a));this.dbState=a},delegate:null,addPack:function(b,a){hub_precondition(this.kindOf(hub.Hub));this.receivePack.call(this,b,{version:a,dataSource:this,doCheckout:true,isInternal:true})},hasCommit:function(a){return !!this.commitIdsByKey[a]},extraKeys:function(a){var b=this.commitKeys.clone();b.removeEach(a);return b},commitRecords:function(f,a,g,d){var b=this.statuses,h=b.length,j=hub.Record,e=hub.Store,p=[],n,i,o;f=[];g=[];for(o in b){o=parseInt(o,10);hub_precondition(typeof o===hub.T_NUMBER);status=b[o];if((status==j.EMPTY)||(status==j.ERROR)){throw j.NOT_FOUND_ERROR}else{if(status==j.READY_CLEAN){g.push(o);f.push(e.recordTypeFor(o));this.writeStatus(o,j.BUSY_COMMITTING);this.dataHashDidChange(o,null,true)}else{if(status==j.READY_NEW){this.writeStatus(o,j.BUSY_CREATING);this.dataHashDidChange(o,null,true);g.push(o);f.push(e.recordTypeFor(o))}else{if(status==j.READY_DIRTY){var m=this.changeStoreKey(o);this.writeStatus(m,j.BUSY_COMMITTING);this.dataHashDidChange(m,null,true);g.push(m);p.push(o);var c=e.recordTypeFor(o);if(c){f.push(c)}}else{if(status&j.DESTROYED){this.writeStatus(o,j.BUSY_DESTROYING);this.dataHashDidChange(o,null,true);this.dataSourceDidDestroy(o)}}}}}}if(g.length>0){var l=hub.CoreSet.create([o]);l.addEach(p);this._notifyRecordArrays(l,hub.CoreSet.create(f));i=this._commitRecords(g,d)}if(i){this.changelog=null}return i},_commitRecords:function(b,c){if(!this._hub.key){this._hub.key=hub.uuid();this.ensureHubName()}if(this.state!==0){hub_error();alert("Data Source is Busy, please save again later.");return false}var a=this;a.goState(1);a.addRecords.call(a,b,a.nextCommitId());return true},changeStoreKey:function(e,f){hub_precondition(typeof e===hub.T_NUMBER);var c=hub.Store;if(!f){f=c.generateStoreKey()}hub_precondition(typeof f===hub.T_NUMBER);var g=this.recordTypeFor(e),b=this.idFor(e),d=this.readDataHash(e),a=g.storeKeysById();this.removeRecord(e);a[b]=f;c.idsByStoreKey[f]=b;c.recordTypesByStoreKey[f]=g;this.writeDataHash(f,d,hub.Record.BUSY_COMMITTING);this.dataHashDidChange(f);return f},removeRecord:function(e,f,d){if(!f){f=this.recordTypeFor(e)}var c=hub.Store,b=this.idFor(e),a=f.storeKeysById();if(d&&d.recordChange&&this.changedRecords){this.changedRecords.add(b);this.changesById[b]=f.DESTROYED}this.removeDataHash(e,f.DESTROYED_CLEAN);this.dataHashDidChange(e,null,true);delete a[b];delete c.idsByStoreKey[e];delete c.recordTypesByStoreKey[e];delete this.revisions[e];delete this.editables[e];delete this.metaData[b]},init:function(b,a){arguments.callee.base.apply(this,arguments);this.startUp()},from:function(){hub_error("DEPRECATED: from is not supported on a hub")},_getDataSource:function(){hub.debug("DEPRECATED: _getDataSource is not supported on a hub");hub_precondition(this.kindOf(hub.Hub));return this},setMaxStoreKey:function(a){hub.debug("VersionedStore.setMaxStoreKey to %@".fmt(a));hub.Store.prototype.nextStoreIndex=a;hub.Store.nextStoreKey=a},isClean:function(){hub.debug("VersionedStore.setMaxStoreKey");if(!this.statuses){return true}var a=this.statuses.length;while(a--){var b=this.statuses[a];if(!((b&hub.Record.READY_CLEAN)||(b&hub.Record.EMPTY))){return false}}return true},addRecords:function(l,n){if(this.state!==1){alert("Attempting to add Records while in wrong state ("+this.state+")");return false}l.sort();var q=l.length,m=this,g=hub.get("currentTask"),u=hub.get("currentActor"),r=new Date().getTime(),p=0;while(q--){var e=parseInt(l[q],10),b=m.recordTypeFor(e),v=b.prototype.primaryKey,o=m.readDataHash(e),a=o[v],t;if(hub.empty(a)){a=hub.uuid();o[v]=a}var s=hub.json.encode(o),c={storeKey:e,recordType:b,recordId:a,dataHash:o,bytes:s,storage:s.length,key:hub.SHA256(s),recordTypeName:b.toString(),created_on:r};if(!this._keysByType[c.recordTypeName]){this._keysByType[c.recordTypeName]=[];this._types.push(c.recordTypeName)}this._keysByType[c.recordTypeName].push(c.key);this._recordsByKey[c.key]=c}var h=hub.json.encode("store"),j,d=r,f=m.insertSQL.Data;hub.debug("* addRecords");this.sendToDB(function(i){m.goState(2);var w=[],y={};m._types.forEach(function(G){var H=hub.json.encode(G),B=r,A=[],C={};m._keysByType[G].forEach(function(N){var P=m._recordsByKey[N];i.executeSql(f,[P.key,P.created_on,P.storage,P.bytes,0,P.storeKey,n],function(){},function(Q,R){hub.debug(R)});var M,L,O;L=m.metaData[P.recordId];if(!L){L={name:P.recordId,meta_uti:"com.hub.link",meta_creator:g,meta_editor:"",target_uti:"com.hub.instance",target_creator:g,target_editor:"",target_position:-1,data:""};m.metaData[P.recordId]=L}else{L.meta_editor=g;L.target_editor=g}L.commit_id=n;L.target=P.key;L.source=G;L.storage=P.storage;O=m.getMetaDataKey(L);A.push(O);C[O]=L;p+=P.storage;m.dataSourceDidComplete(P.storeKey,null,P.recordId)});var E=hub.SHA256(""+H+A.sort().join(""));i.executeSql(f,[E,B,0,H,1,null,n],function(){},function(L,M){hub.debug(M)});var I=m.metaData[G];if(!I){I={name:G,meta_uti:"com.hub.link",meta_creator:g,meta_editor:"",target_uti:"com.hub.record",target_creator:g,target_editor:"",target_position:-1,storage:0,data:null};m.metaData[G]=I}else{I.meta_editor=g;I.target_editor=g}I.commit_id=n;I.source=j;I.target=E;var D=m.getMetaDataKey(I);w.push(D);y[D]=I;var F=A.length;while(F--){var J=C[A[F]];J.source=E;m.addMetaData.call(m,i,J)}});j=hub.SHA256(""+h+w.sort().join(""));i.executeSql(f,[j,d,h.length,h,0,null,n],function(){},function(A,B){hub.debug(B)});var x=w.length;while(x--){var z=y[w[x]];z.source=j;m.addMetaData.call(m,i,z)}m.addCommit.call(m,i,{name:"commit",meta_uti:"com.hub.commit",meta_creator:g,meta_editor:g,merger:g,created_on:r,totalStorage:p,commit_storage:0,history_storage:0,data:j,meta_data:null,committer:u,commit_id:n});i.executeSql("UPDATE data SET metadata_count = (SELECT COUNT(*) FROM meta_data where target = data.key)",[],undefined,m._error)},null,function(){m.goState(3);m.cleanup()},true)},addCommit:function(c,a){hub.debug("addCommit");if(this.state!==2){alert("Add Commit called with wrong state: ("+this.state+")");return false}hub_precondition(hub.typeOf(a.commit_id)===hub.T_NUMBER);var g=this,h=a.totalStorage,i=hub.json.encode(a.ancestors?a.ancestors:[this.currentCommit]),d=i.length,f=hub.SHA256(""+a.name+a.committer+a.data),b=g.insertSQL.Commit;var e=[f,a.name,a.commit_id,a.meta_uti,a.meta_creator,a.meta_editor,a.merger,a.created_on,d,h,a.commit_storage,a.history_storage,a.data,a.meta_data,a.committer,i];this.set("currentCommit",f);this.commitKeys.add(f);this.commitIdsByKey[f]=a.commit_id;hub.debug("* addCommit");g.sendToDB(function(l){g.ensureHubName.call(g);var o=g._hub.name,p=g._hub.key,n=g.insertSQL.HubCommit,q=[p,f],m="UPDATE hub SET head = ?, name = ? WHERE key = ?",j=[f,o,p];l.executeSql(m,j,function(r,s){},g._error);l.executeSql(n,q,function(r,s){},g._error);g._hub.head=f},null,null,true,true);c.executeSql(b,e,function(j,l){hub.debug("Added Commit");g.sendPack.call(g,f,a.commit_id)},g._error)},addMetaData:function(b,g){hub.debug("addMetaData");var c=this;if(c.state!==2){alert("Add MetaData called with wrong state: ("+c.state+")");return false}if(g.name===undefined||g.name===""){throw ("I think you have forgotten to give your model a name.\nPlease make sure that you have this in each of your models:\nhub.mixin(App.Model,{modelClass: 'App.Model'});")}var h=(g.data?g.data.length+g.storage:g.storage),d=c.getMetaDataKey(g,true),a="SELECT count(*) as count FROM meta_data WHERE key = ?",f=c.insertSQL.MetaData,e=[d,g.name,g.meta_uti,g.meta_creator,g.meta_editor,g.target_uti,g.target_creator,g.target_editor,g.target_position,h,g.source,g.target,g.data,g.commit_id];b.executeSql(f,e,function(i,j){hub.debug("MetaData Added")},function(i,j){hub.debug(j)});return{storage:h,key:d}},getMetaDataKey:function(c,b){var a=""+c.name+c.meta_uti+c.meta_creator+c.meta_editor+c.target_uti+c.target_creator+c.target_editor+c.target_position+c.target+c.data;if(b){a+=c.source}return hub.SHA256(a)},cleanup:function(){this._keysByType={};this._recordsByKey={};this._types=[];this._sourceByType={};this.goState(0)},fetch:function(a){},_sendPackURL:"/packs/?pk=%@",_receivePackURL:"/packs/?pk=%@",sendPack:function(a,c){var d=this.state;if(hub.OfflineMode){hub.debug("Offline mode, no data is being sent");this.goState(0);return}if(!c){c=this.commitIdsByKey[a]}hub.debug("Preparing Pack ... %@ : %@".fmt(a,c));hub_precondition(hub.typeOf(c)===hub.T_NUMBER);this.goState(5);var b=this;hub.debug("* sendPack");b.sendToDB(function(e){var g=[],f={};e.executeSql("SELECT * FROM data WHERE commit_id = ?",[c],function(j,h){var m=h.rows.length,p,n,l,o;while(m--){p=h.rows.item(m);l=p.key;o={metadata_count:p.metadata_count,storage:parseInt(p.storage,10),created_on:parseInt(p.created_on,10),bytes:p.bytes};n={pk:l,model:"Data",fields:o};hub.debug(hub.inspect(n.fields));g.push(n)}f.data=true;b._sendPack.call(b,a,g,f)});e.executeSql("SELECT * FROM meta_data WHERE commit_id = ?",[c],function(i,h){var l=h.rows.length,o,n,m;while(l--){o=h.rows.item(l);m=o.key;delete o.key;delete o.commit_id;n={pk:m,model:"MetaData",fields:o};g.push(n)}f.metaData=true;b._sendPack.call(b,a,g,f)});hub.debug("Finding commit with id: %@".fmt(c));e.executeSql("SELECT * FROM commits WHERE commit_id = ?",[c],function(i,h){var n=h.rows.item(0),j=n.key,m;m=hub.clone(n);delete m.key;delete m.commit_id;m.created_on=parseInt(m.created_on,10);var l={pk:j,model:"Commit",fields:m};g.push(l);f.commit=true;b._sendPack.call(b,a,g,f)})});this.goState(0)},_sendPack:function(a,d,c){if(c.data&&c.metaData&&c.commit){var e=d,b=this._sendPackURL.fmt(a);hub.debug("Calling packCommited call back");this.packCommitted(a,d)}else{hub.debug("Not yet sending pack.")}},packCommitted:function(a,b){hub.debug("No callback has been created for commits. To be notified of commits assign a callback packCommitted(commitId, packData)")},getPack:function(b,a){var c=this,d=this._receivePackURL.fmt(b);if(!a){a=false}hub.Request.getUrl(d).set("isJSON",true).notify(this,this.receivePack,{version:b,dataSource:c,doCheckout:a}).send()},receivePack:function(c,a){var n=a.dataSource,g=a.version,l=n.commitIdsByKey[g];if(l){hub.debug("Already have commit %@:%@".fmt(g,l));return}n.goState(2);var f=a.doCheckout,h=a.isInternal?c:c.get("response"),b=n.insertSQL,e=h.length,m,o,j,d;l=n.nextCommitId();hub.debug("* receivePack");n.sendToDB.call(n,function(i){while(e--){m=h[e];d=m.fields;o=b[m.model];switch(m.model){case"Data":j=[m.pk,new Date(d.created_on).getTime(),d.storage,d.bytes,d.metadata_count,hub.Store.generateStoreKey(),l];break;case"MetaData":j=[m.pk,d.name,d.meta_uti,d.meta_creator,d.meta_editor,d.target_uti,d.target_creator,d.target_editor,d.target_position,d.storage,d.source,d.target,d.data_key,l];break;case"Commit":j=[m.pk,d.name,l,d.commit_uti,d.commit_creator,d.commit_editor,d.merger,new Date(d.created_on).getTime(),d.ancestor_count,d.total_storage,d.commit_storage,d.history_storage,d.data_key,d.commit_data,d.committer,d.ancestors];break}i.executeSql(o,j,undefined,function(p,q){hub.debug(q);hub.debug(o);hub.debug(j)})}},null,function(){n.commitKeys.add(g);n.commitIdsByKey[g]=l;n.goState(0);if(f){hub.debug("Checking out after sync");n._hub.head=g;n.checkoutLatest.call(n)}else{hub.debug("Not checking out just yet")}},true)},applyCommits:function(a){if(!this.commitKeys.contains(a)){return}var b=this.get("nestedStores"),f=b?b.get("length"):0,d=f;while(f--){b[f].freeze()}var h="",g=this.get("currentCommit");this.checkout(h);var e=this.chain({},hub.NestedHub);e.goTo(g);var c=this.chain({},hub.NestedHub);c.goTo(a);this.merge(e,c);e.destroy();c.destroy();while(d--){b[d].unfreeze()}},merge:function(d,c){var a=this,b=this.delegate;if(b&&b.hubDidStartMerge){b.hubDidStartMerge(a,d,c)}d.changedRecords.forEach(function(e){if(c.changedRecords.contains(e)){if(b&&b.hubDidHaveConflict){b.hubDidHaveConflict(d,c,e)}}})},hubDidHaveConflict:function(f,e,d){var b=hub.Record;var c=f.idFor(),a=e.idFor();if(f.readStatus(c)&b.DESTROYED){return e.readDataHash(a)}if(e.readStatus(a)&b.DESTROYED){return f.readDataHash(c)}if(f.created_on>e.created_on){return f.readDataHash(c)}else{return e.readDataHash(a)}},retrieveRecord:function(a,b){hub.debug("* retrieveRecord");this.sendToDB(function(c){c.executeSql("SELECT * FROM data WHERE store_key = ?",[a],function(f,d){if(d.rows.length>0){var g=d.rows.item(0),e=hub.json.decode(g.bytes);self.dataSourceDidComplete(a,e)}else{hub_error()}},function(d,e){self.dataSourceDidError(a,e)})})},packListUrl:"/packs/keys/",sync:function(){var a=this;hub.Request.getUrl(a.packListUrl).set("isJSON",true).notify(this,this._didGetPackList,{dataSource:a}).send()},_didGetPackList:function(g,h){var c=h.dataSource,e=this.commitKeys,a=hub.CoreSet.create(g.get("response")),b=e.copy().removeEach(a),f=a.copy().removeEach(e),d=f.length-1;f.forEach(function(j,i){hub.debug("  Getting Pack: %@".fmt(j));if(i===d){hub.debug(" ### get pack %@ of %@".fmt(i,d));c.getPack.call(c,j,true)}else{hub.debug(" ## get pack %@ of %@".fmt(i,d));c.getPack.call(c,j)}});b.forEach(function(i){var j=c.commitIdsByKey[i];hub.debug("  Sending Pack: %@ - %@".fmt(i,j));c.sendPack.call(c,i,j);hub.debug("... sent!")})},openHubDialog:function(b){var a=this;this.sendToDB(function(c){var d="SELECT * FROM hubs WHERE meta_uti = ?";c.executeSql(d,[a.get("uti")],function(e,h){var g=h.rows.length,l,j,f=[];while(g--){l=h.rows.item(g);f.unshift({key:l.key,name:l.name});b(f)}},a._error)},null,null,true,true)},openHub:function(b,a){this._hub={key:b,name:a,head:null,setup:false,db:null};this.checkoutLatest()},saveAsDialog:function(){},saveAs:function(c,b){var a=this;this.sendToDB(function(d){var f="UPDATE hub SET name = ? WHERE key = ?",e=[b,c];d.executeSql(f,e,function(g,h){},a._error)})},ensureHubName:function(){hub_precondition(this.kindOf&&this.kindOf(hub.Hub));if(hub.empty(this._hub.name)){var a=prompt("What name do you want to save this sproutHub file as?","MyHub");this._hub.name=a?a:"MyHub"}},checkout:function(a,h){hub_precondition(this.kindOf&&this.kindOf(hub.Hub));if(!a){this.checkoutLatest();return}if(!h){h={}}if(this.get("checkingOut")===a){hub.debug("Already checking out this version");return false}if(this.state!==0){alert("Checkout called with wrong state: ("+this.state+")");return false}if(this.get("currentCommit")===a){hub.debug("Already checked out this version");return false}this.set("checkingOut",a);this.goState(4);if(!this.isClean()){alert("You tried to checkout while the store was not clean. Please commit changes first.");this.goState(0);return false}var b=this,f=b.currentCommit,e={},d={},c=hub.CoreSet.create(),g=hub.CoreSet.create();hub.debug("* checkout");this.sendToDB(function(i){var j="SELECT data.store_key, data.key, commits.key as commitKey, src_md.name as type, data.bytes FROM data JOIN meta_data ON (data.key = meta_data.target) JOIN meta_data AS src_md ON (meta_data.source = src_md.target) JOIN commits ON (commits.commit_id = src_md.commit_id) WHERE data.store_key IS NOT NULL AND commits.key IN (?,?)",l=[f,a];i.executeSql(j,l,function(t,u){var s=u.rows.length,q=hub.Store,v=hub.Record,r,p,n,z,y,m;while(s--){var A=u.rows.item(s),x=parseInt(A.store_key,10);if(A.commitKey==f){c.add(x)}else{g.add(x)}d[x]={type:A.type,pk:A.key,bytes:hub.json.decode(A.bytes)}}var o=c.copy().removeEach(g),w=g.copy().removeEach(c);m=this.changedRecords?{recordChange:true}:undefined;o.forEach(function(B){hub_precondition(typeof B===hub.T_NUMBER);b.removeRecord(B,m)});w.forEach(function(B){hub_precondition(typeof B===hub.T_NUMBER);r=d[B];p=hub.objectForPropertyPath(r.type);n=r.bytes[p.prototype.primaryKey];z=p.storeKeysById();z[n]=B;q.idsByStoreKey[B]=r.key;q.recordTypesByStoreKey[B]=p;b.writeDataHash(B,r.bytes,v.READY_CLEAN);b.dataHashDidChange(B);if(m){this.changedRecords.add(n);this.changesById[n]=v.DIRTY}})},function(m,n){hub.debug("Error in Checkout.");hub.debug(n);return false})},null,function(){b.set("currentCommit",a);b.set("checkingOut",null);this.goState(0)},true)},checkoutLatest:function(){hub_precondition(this.kindOf(hub.Hub));if(!this._hub||!this._hub.head){return}hub_precondition(this._hub.head);var b,a=this;hub.debug("* checkoutLatest");this.sendToDB(function(c){var d="SELECT * FROM commits WHERE key = ?";c.executeSql(d,[a._hub.head],function(e,f){if(f.rows.length>0){var g=f.rows.item(0);b=g.key;a.databaseDesc=a.databaseName=g.hub_name}})},null,function(){if(b){hub.debug("Checking out %@".fmt(b));a.checkout.call(a,b)}else{hub.debug("Found no commits to checkout.")}},true)},createHub:function(b,e){if(!this._hub.key){this._hub.key=hub.uuid()}var c=this,f=c.insertSQL.Hub,d=(c._hub.name||"DefaultName"),a=[c._hub.key,d,c.get("uti"),e.creator,e.editor||"",0,0,e.version,"",""];c._hub.name=d;b.executeSql(f,a,function(g,h){hub.debug("Created Hub: %@: %@".fmt(c._hub.name,c._hub.key))},c._error)},startUp:function(){hub_precondition(this.kindOf(hub.Hub));var a=this;hub.debug("* startUp hub");a.sendToDB(function(b){b.executeSql("SELECT * FROM hub WHERE meta_uti = ?",[a.get("uti")],function(c,d){if(d.rows.length>0){var e=d.rows.item(0);a._hub.key=e.key;a._hub.name=e.name;a._hub.head=e.head;hub.debug("Loading hub: %@; %@".fmt(a._hub.key,a._hub.name))}else{a.createHub.call(a,c,{version:"empty",creator:hub.get("currentTask"),editor:""})}c.executeSql("SELECT * FROM hub_commit WHERE hub = ?",[a._hub.key],function(f,h){var g=h.rows.length,j;while(g--){j=h.rows.item(g);a.commitKeys.add(j.commit);a.commitIdsByKey[j.commit]=parseInt(j.commit_id,10)}},a._error)},a._error)},null,a.setup,true,true)},settingUp:false,setup:function(){var a=this;if(hub.empty(a._hub.key)){return}hub_precondition(!a.settingUp);a.settingUp=true;hub.debug("* startUp store");a.sendToDB(function(b){b.executeSql("SELECT MAX(store_key)+1 AS max FROM data",[],function(d,f){var c;try{c=parseInt(f.rows.item(0)["max"],10)}catch(g){c=1}if(isNaN(c)){c=1}hub_precondition(typeof c===hub.T_NUMBER);a.setMaxStoreKey(c);a.checkoutLatest.call(a)},a._error);b.executeSql("SELECT MAX(commit_id) as max FROM commits",[],function(d,e){var c=parseInt(e.rows.item(0)["max"],10);if(isNaN(c)){c=0}a.currentCommitId=c},a._error);b.executeSql("SELECT commit_id, key FROM commits",[],function(c,e){var d=e.rows.length,f;while(d--){f=e.rows.item(d);a.commitIdsByKey[f.key]=parseInt(f.commit_id,10)}},a._error)},null,function(){a._hub.setup=true;a.settingUp=false},true)},_dbs:{},_sqlQueue:[],_sqlInternalQueue:[],sendToDB:function(b,j,h,d,i){hub_precondition(this.kindOf&&this.kindOf(i.Hub));hub_precondition(this.dbState!=="c","Database is in error state.");var l=this,g,a;if(this.dbState==="b"||(this.state===4&&this._sqlInternalQueue.length>0&&!d)){if(d){this._sqlInternalQueue.push(arguments)}else{this._sqlQueue.push(arguments)}setTimeout(function(){l.invokeSendToDB.apply(l)},500);return}this.goDbState("b");if(i){g="SproutHub";a="SproutHub Metadata"}else{g=l._hub.key;a=g+" DataStore"}if(!g){i.debug("No Hub yet, wait till we have one.");l.invokeLater.apply(l);return}if(!i&&!l.settingUp&&!l._hub.setup){l.setup()}if(l._dbs[g]){i.debug("Running Query with existing database.");l._dbs[g].transaction(function(m){b(m)},function(m){l.goDbState("c");i.debug("ERROR: Transaction Errored.");i.debug(m);hub_error()},function(){if(h){h.apply(l)}l.goDbState("a");l.invokeSendToDB.apply(l)})}else{if(j){j();if(h){h.apply(l)}l.goDbState("a");return l.invokeSendToDB.apply(l)}var f="Sorry, No DB today.",e=null;try{if(window.openDatabaseSync||window.openDatabase||(google.gears.factory&&google.gears.factory.create)){if(window.openDatabaseSync){e=window.openDatabaseSync(g,"1.1",a,5000000);e.addListener("commit",function(){i.debug("COMMIT")});e.addListener("update",function(m,p,o,n){i.debug("update "+m+" "+p+"."+o+" "+n)})}else{if(window.openDatabase){e=window.openDatabase(g,"1.1",a,5000000)}else{e=Gears.openDatabase(g,"1.1")}}if(!e){alert(f+" Couldn't open, maybe bad version or run out of DB quota.")}else{e.transaction(function(m){m.executeSql("SELECT COUNT(*) FROM %@".fmt(i?"hub":"data"),[],function(n){i.debug("We have our data tables.");l._dbs[g]=e;b(n)},function(n,o){i.debug("We don't have the data table ...");if(i){l._createHubTables(n)}else{l._createStoreTables(n)}b(n);i.debug("end callback");return false})},function(m){i.debug("ERROR: Transaction Errored! "+m.message);l.goDbState("c");hub_error("transaction error")},function(){if(h){h.apply(l)}l.goDbState("a");l.invokeSendToDB.apply(l)})}}else{if(window.google.factory&&window.google.factory.create){}else{alert(f+" Your browser doesn't support it.")}}}catch(c){alert(f+" Something bad happened: "+c)}}},invokeCount:0,invokeSendToDB:function(){var a=this,b;if(this.dbState==="b"){hub.debug("Invokeing DB later");a.invokeCount++;if(a.invokeCount<10){setTimeout(function(){a.invokeSendToDB.apply(a)},500)}return false}a.invokeCount=0;if(a._sqlInternalQueue.length>0){b=this._sqlInternalQueue.shift();return a.sendToDB.apply(a,b)}else{if(a._sqlQueue.length>0){b=this._sqlQueue.shift();return a.sendToDB.apply(a,b)}}},_error:function(a,b,c){hub.debug("Error!: "+c);hub.debug(b);return false},insertSQL:{Data:"INSERT OR IGNORE INTO data (key, created_on, storage, bytes, metadata_count, store_key, commit_id) VALUES (?,?,?, ?,?,?, ?)",MetaData:"INSERT OR IGNORE INTO meta_data (key, name, meta_uti, meta_creator, meta_editor, target_uti, target_creator, target_editor, target_position, storage, source, target, data_key, commit_id) VALUES (?,?,?, ?,?,?, ?,?,?, ?,?,?, ?,?);",Commit:"INSERT OR IGNORE INTO commits (key, name, commit_id, commit_uti, commit_creator, commit_editor, merger, created_on, ancestor_count, total_storage, commit_storage, history_storage, data_key, commit_data, committer, ancestors) VALUES (?,?,?, ?,?,?, ?,?,?, ?,?,?, ?,?,?, ?)",Hub:"INSERT OR REPLACE INTO hub (key, name, meta_uti, meta_creator, meta_editor, is_private, is_archived, head, forked_from, meta_data) VALUES (?,?,?, ?,?,?, ?,?,?, ?)",HubCommit:"INSERT OR IGNORE INTO hub_commit (hub, 'commit') VALUES (?,?)"},_createStoreTables:function(a,b){hub.debug("start creating data tables.");a.executeSql("CREATE TABLE 'actor' (email TEXT, public_key TEXT)",[],null,this._error);a.executeSql("CREATE TABLE 'data' (key TEXT, store_key INTEGER, created_on TEXT, storage INTEGER, bytes BLOB, metadata_count INTEGER, commit_id INTEGER)",[],null,this._error);a.executeSql("CREATE TABLE 'meta_data' (key TEXT, name TEXT, meta_uti TEXT, meta_creator TEXT, meta_editor TEXT, target_uti TEXT, target_creator TEXT, target_editor TEXT, target_position INTEGER, storage INTEGER, source TEXT, target TEXT, data_key TEXT, commit_id INTEGER)",[],null,this._error);a.executeSql("CREATE TABLE 'commits' (key TEXT, name TEXT, commit_id INTEGER, commit_uti TEXT, commit_creator TEXT, commit_editor TEXT, merger TEXT, created_on INTEGER, ancestor_count INTEGER, total_storage INTEGER, commit_storage INTEGER, history_storage INTEGER, data_key TEXT, data_uti TEXT, data_editor TEXT, data_creator TEXT, commit_data TEXT, committer TEXT, ancestors TEXT)",[],null,this._error);a.executeSql('CREATE UNIQUE INDEX IF NOT EXISTS "UniqueDataKey" ON "data" ("key");');a.executeSql('CREATE UNIQUE INDEX IF NOT EXISTS "UniqueDataStoreKey" ON "data" ("store_key");');a.executeSql('CREATE UNIQUE INDEX IF NOT EXISTS "UniqueCommitKey" ON "commits" ("key");');a.executeSql('CREATE UNIQUE INDEX IF NOT EXISTS "UniqueMetaKey" ON "meta_data" ("key");')},_createHubTables:function(a,b){hub.debug("start creating hub tables.");a.executeSql("CREATE TABLE 'hub' (key TEXT, name TEXT, meta_uti TEXT, meta_creator TEXT, meta_editor TEXT, is_private INTEGER, is_archived INTEGER, head TEXT, forked_from TEXT, meta_data TEXT)",[],null,this._error);a.executeSql("CREATE TABLE 'hub_commit' (hub TEXT, 'commit' TEXT)",[],null,this._error);a.executeSql("CREATE TABLE 'hub_reference' (name TEXT, meta_uti TEXT, meta_creator TEXT, meta_editor TEXT, hub TEXT, 'commit' TEXT, committer TEXT, meta_data TEXT)",[],null,this._error);a.executeSql("CREATE TABLE 'hub_committer' (is_owner TEXT, hub TEXT, committer TEXT, head TEXT)",[],null,this._error);a.executeSql("CREATE TABLE 'hub_observer' (hub TEXT, observer TEXT)",[],null,this._error);a.executeSql('CREATE UNIQUE INDEX IF NOT EXISTS "UniqueHubKey" ON "hub" ("key");');hub.debug("finish creating hub tables.")}});hub.MergeHub=hub.Hub.extend({hasChanges:false,parentStore:null,isNested:true,lockOnRead:true,locks:null,chainedChanges:null,changedRecords:hub.CoreSet.create(),changesById:{},_hub_currentCommit:null,currentCommit:function(){if(this._hub_currentCommit){return this._hub_currentCommit}else{var a=this.get("parentStore");a.get("currentCommit")}}.property("_currentCommit").cacheable(),goTo:function(a){this.checkout(a)},find:function(a){if(a&&a.isQuery&&a.get("location")!==hub.Query.LOCAL){throw"SC.Store#find() can only accept LOCAL queries in nested stores"}return arguments.callee.base.apply(this,arguments)},commitChanges:function(b){if(this.get("hasChanges")){var a=this.get("parentStore");a.commitChangesFromNestedStore(this,this.chainedChanges,b)}this.reset();return this},discardChanges:function(){var c,f;if((c=this.records)&&(f=this.locks)){var b=this.get("parentStore"),h=b.revisions;var g=this.revisions,e,d,a;for(e in c){if(!c.hasOwnProperty(e)){continue}if(!(d=f[e])){continue}a=h[e];if((a!==d)||(g[e]>a)){this._hub_notifyRecordPropertyChange(e)}}}this.reset();this.flush();return this},destroy:function(){this.discardChanges();var a=this.get("parentStore");if(a){a.willDestroyNestedStore(this)}arguments.callee.base.apply(this,arguments);return this},reset:function(){var a=this.get("parentStore");if(!a){throw hub.Store.NO_PARENT_STORE_ERROR}this.dataHashes=hub.beget(a.dataHashes);this.revisions=hub.beget(a.revisions);this.statuses=hub.beget(a.statuses);this.chainedChanges=this.locks=this.editables=null;this.changelog=null;this.set("hasChanges",false)},refreshQuery:function(b){var a=this.get("parentStore");if(a){a.refreshQuery(b)}return this},readError:function(b){var a=this.get("parentStore");return a?a.readError(b):null},readQueryError:function(b){var a=this.get("parentStore");return a?a.readQueryError(b):null},storeKeyEditState:function(b){var c=this.editables,a=this.locks;return(c&&c[b])?hub.Store.EDITABLE:(a&&a[b])?hub.Store.LOCKED:hub.Store.INHERITED},_hub_lock:function(e){var d=this.locks,a,f;if(d&&d[e]){return this}if(!d){d=this.locks=[]}f=this.editables;if(f){f[e]=0}var c=this.get("parentStore"),b;while(c&&(b=c.storeKeyEditState(e))===hub.Store.INHERITED){c=c.get("parentStore")}if(c&&b===hub.Store.EDITABLE){this.dataHashes[e]=hub.clone(c.dataHashes[e]);if(!f){f=this.editables=[]}f[e]=1}else{this.dataHashes[e]=this.dataHashes[e]}this.statuses[e]=this.statuses[e];a=this.revisions[e]=this.revisions[e];d[e]=a||1;return this},readDataHash:function(a){if(this.get("lockOnRead")){this._hub_lock(a)}return this.dataHashes[a]},readEditableDataHash:function(a){this._hub_lock(a);return arguments.callee.base.apply(this,arguments)},writeDataHash:function(d,f,b){var c=this.locks,a;if(f){this.dataHashes[d]=f}this.statuses[d]=b?b:(this.statuses[d]||hub.Record.READY_NEW);a=this.revisions[d]=this.revisions[d];if(!c){c=this.locks=[]}if(!c[d]){c[d]=a||1}var e=this.editables;if(!e){e=this.editables=[]}e[d]=1;return this},removeDataHash:function(c,a){var b=this.locks;if(!b){b=this.locks=[]}if(!b[c]){b[c]=this.revisions[c]||1}return arguments.callee.base.apply(this,arguments)},dataHashDidChange:function(d,b,a,h){if(!b){b=hub.Store.generateStoreKey()}var c,e,g,i;c=hub.typeOf(d)===hub.T_ARRAY;if(c){e=d.length}else{e=1;i=d}var f=this.chainedChanges;if(!f){f=this.chainedChanges=hub.Set.create()}for(g=0;g<e;g++){if(c){i=d[g]}this._hub_lock(i);this.revisions[i]=b;f.add(i);this._hub_notifyRecordPropertyChange(i,a,h)}this.setIfChanged("hasChanges",true);return this},commitChangesFromNestedStore:function(e,f,a){arguments.callee.base.apply(this,arguments);var b=this.get("parentStore"),h=b.revisions,c;var l=this.locks,g=this.chainedChanges,d,j;if(!l){l=this.locks=[]}if(!g){g=this.chainedChanges=hub.Set.create()}d=f.length;for(c=0;c<d;c++){j=f[c];if(!l[j]){l[j]=h[j]||1}g.add(j)}this.setIfChanged("hasChanges",g.get("length")>0);this.flush();return this},queryFor:function(c,a,b){return this.get("parentStore").queryFor(c,a,b)},findAll:function(e,b,d,c,a){if(!a){a=this}return this.get("parentStore").findAll(e,b,d,c,a)},retrieveRecords:function(f,n,b,c){var a=this.get("parentStore"),l,d,q,p=(!b)?n.length:b.length,i=hub.Record,o;if(c){for(l=0;l<p;l++){d=!b?a.storeKeyFor(f,n[l]):b[l];o=this.peekStatus(d);if(o&i.DIRTY){throw hub.Store.NESTED_STORE_RETRIEVE_DIRTY_ERROR}else{var g=this.dataHashes,j=this.revisions,h=this.statuses,m=this.editables,s=this.locks;var e=false;var r=false;if(g&&g.hasOwnProperty(d)){delete g[d];e=true}if(j&&j.hasOwnProperty(d)){delete j[d];e=true}if(m){delete m[d]}if(s){delete s[d]}if(h&&h.hasOwnProperty(d)){delete h[d];if(!e){r=true}e=true}if(e){this._hub_notifyRecordPropertyChange(d,r)}}}}return a.retrieveRecords(f,n,b,c)},commitRecords:function(a,b,c){throw hub.Store.NESTED_STORE_UNSUPPORTED_ERROR},commitRecord:function(c,b,a){throw hub.Store.NESTED_STORE_UNSUPPORTED_ERROR},cancelRecords:function(a,b,c){throw hub.Store.NESTED_STORE_UNSUPPORTED_ERROR},cancelRecord:function(c,b,a){throw hub.Store.NESTED_STORE_UNSUPPORTED_ERROR},dataSourceDidCancel:function(a){throw hub.Store.NESTED_STORE_UNSUPPORTED_ERROR},dataSourceDidComplete:function(c,b,a){throw hub.Store.NESTED_STORE_UNSUPPORTED_ERROR},dataSourceDidDestroy:function(a){throw hub.Store.NESTED_STORE_UNSUPPORTED_ERROR},dataSourceDidError:function(b,a){throw hub.Store.NESTED_STORE_UNSUPPORTED_ERROR},pushRetrieve:function(d,c,a,b){throw hub.Store.NESTED_STORE_UNSUPPORTED_ERROR},pushDestroy:function(c,b,a){throw hub.Store.NESTED_STORE_UNSUPPORTED_ERROR},pushError:function(d,c,a,b){throw hub.Store.NESTED_STORE_UNSUPPORTED_ERROR}});